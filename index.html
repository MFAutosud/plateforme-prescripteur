<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Plateforme prescripteur â€“ MF Auto Sud</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#0b1220;color:#fff;padding:24px}
h1{color:#4da3ff}
.box{background:#111c34;padding:16px;border-radius:10px;margin-bottom:18px}
label{display:block;margin-top:12px}
input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2b3a5a;background:#0b1220;color:#fff}
button{margin-top:14px;padding:12px;border-radius:10px;border:0;background:#4da3ff;color:#000;font-weight:bold;cursor:pointer}
button.secondary{background:#334155;color:#fff}
.row{display:flex;gap:10px;flex-wrap:wrap}
.hint{opacity:.7;font-size:12px;margin-top:6px}
.msg{background:#0b1220;padding:10px;border-radius:8px;margin-top:8px}
.msg.you{border-left:4px solid #4da3ff}
.msg.them{border-left:4px solid #22c55e}
</style>
</head>

<body>

<h1>Plateforme prescripteur â€“ MF Auto Sud</h1>

<div class="box">
  <h2>CrÃ©er une demande</h2>
  <label>Client</label>
  <input id="client">
  <label>VÃ©hicule</label>
  <input id="vehicle">
  <button onclick="createRequest()">CrÃ©er</button>
  <div id="link"></div>
</div>

<div class="box">
  <h2>Envoyer Ã  un prestataire</h2>
  <label>Email prestataire</label>
  <input id="provider">
  <button onclick="send()">Envoyer</button>
  <div id="sendStatus"></div>
</div>

<div class="box">
  <h2>Conversation</h2>
  <button class="secondary" onclick="loadThread()">ðŸ”„ RafraÃ®chir</button>
  <div id="thread"></div>
</div>

<script>
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_KEY = "TON_ANON_KEY_ICI";

let RID="", CODE="";

async function createRequest(){
  const client=document.getElementById("client").value.trim();
  const vehicle=document.getElementById("vehicle").value.trim();
  if(!client||!vehicle){alert("Champs manquants");return;}

  CODE=crypto.randomUUID();
  const r=await fetch(`${SUPABASE_URL}/rest/v1/requests`,{
    method:"POST",
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:"Bearer "+SUPABASE_KEY,
      "Content-Type":"application/json",
      Prefer:"return=representation"
    },
    body:JSON.stringify({client_name:client,vehicle,access_code:CODE})
  });
  const d=await r.json();
  RID=d[0].id;
  const link=location.href.split("#")[0]+`#rid=${RID}&code=${CODE}`;
  document.getElementById("link").innerHTML=`Lien : <a href="${link}" target="_blank">${link}</a>`;
}

async function send(){
  const email=document.getElementById("provider").value.trim();
  if(!email||!RID)return;
  document.getElementById("sendStatus").innerText="Envoi...";
  const r=await fetch(`${SUPABASE_URL}/functions/v1/send-request`,{
    method:"POST",
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:"Bearer "+SUPABASE_KEY,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      request_id:RID,
      access_code:CODE,
      provider_emails:[email]
    })
  });
  document.getElementById("sendStatus").innerText=r.ok?"âœ… EnvoyÃ©":"âŒ Erreur";
}

async function loadThread(){
  if(!RID)return;
  const r=await fetch(`${SUPABASE_URL}/functions/v1/get-thread`,{
    method:"POST",
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:"Bearer "+SUPABASE_KEY,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({request_id:RID,access_code:CODE})
  });
  const d=await r.json();
  const el=document.getElementById("thread");
  el.innerHTML="";
  d.responses.forEach(x=>{
    el.innerHTML+=`
      <div class="msg ${x.responder_email?'them':'you'}">
        <strong>${x.responder_email||"Vous"}</strong><br>
        ${x.message||""}
      </div>`;
  });
}
</script>

</body>
</html>
