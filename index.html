<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Plateforme prescripteur ‚Äì MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{font-family:Arial,sans-serif;background:#0b1220;color:#fff;padding:28px}
    h1{color:#4da3ff;margin:0 0 18px}
    h2{margin:0 0 10px}
    h3{margin:0}
    .box{background:#111c34;padding:18px;border-radius:10px;margin-bottom:18px}
    label{display:block;margin-top:12px}
    input,textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:#0b1220;color:#fff}
    button{width:100%;padding:12px;margin-top:14px;background:#4da3ff;border:0;font-weight:700;cursor:pointer;border-radius:10px}
    button.secondary{background:#334155}
    button.small{width:auto;padding:8px 10px;margin-top:0}
    #result{margin-top:12px;word-break:break-all}
    hr{margin:18px 0;opacity:.25}
    .pill{display:inline-block;background:#2563eb;color:#fff;padding:4px 10px;border-radius:20px;font-size:12px;margin-top:8px}
    .hint{opacity:.7;font-size:12px;margin-top:6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .providerRow{display:flex;align-items:center;gap:10px;margin:10px 0}
    .providerRow span{flex:1}
    a{color:#7cc0ff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    thead th{border-bottom:1px solid rgba(255,255,255,.15);text-align:left}
  </style>
</head>

<body>
  <h1>Plateforme prescripteur ‚Äì MF Auto Sud</h1>

  <!-- Prescripteur UI -->
  <div class="box" id="prescriberBox">
    <h2>1Ô∏è‚É£ Configuration</h2>
    <button onclick="saveConfig()">Enregistrer</button>
    <div id="result"></div>
  </div>

  <div class="box" id="createBox">
    <h2>2Ô∏è‚É£ Cr√©er une demande</h2>

    <label>V√©hicule</label>
    <input id="vehicle" placeholder="Ex : Renault Clio / Cupra Formentor...">

    <label>Infos client (copier-coller)</label>
    <textarea id="pasteBlock" placeholder="Colle ici le bloc complet (1√®re ligne = nom client)‚Ä¶" style="height:180px;"></textarea>
    <div class="hint">
      Astuce : la 1 ≥·µâ ligne du bloc devient automatiquement le nom du client.
      Le portail ignore automatiquement : ‚ÄúClient‚Äù, ‚ÄúContacts‚Äù, ‚ÄúAr‚Äù, ‚ÄúMandat‚Ä¶‚Äù, ‚ÄúResponsable MF Autosud‚Äù.
    </div>

    <button onclick="createRequest()">Cr√©er la demande</button>
  </div>

  <div class="box" id="historyBox">
    <h2>3Ô∏è‚É£ Historique relances</h2>
    <div class="row">
      <button class="secondary" onclick="loadHistory()">üîÑ Rafra√Æchir</button>
    </div>
    <div class="hint">Affiche sent_at / last_reminder_at / reminder_count / responded_at (table provider_invites).</div>
    <div id="historyStatus" class="hint"></div>
    <div id="historyTable" style="margin-top:12px;"></div>
  </div>

  <!-- Envoi -->
  <div class="box" id="sendBox" style="display:none;">
    <h2>4Ô∏è‚É£ Envoyer la demande</h2>

    <div id="sendLinkBox" style="margin-bottom:12px;"></div>

    <h3 style="margin:16px 0 8px;">Prestataires enregistr√©s</h3>
    <div id="providersList"></div>

    <h3 style="margin:16px 0 8px;">Ajouter un prestataire</h3>
    <label>Nom (optionnel)</label>
    <input id="newProviderName" placeholder="Ex : Banque X / Loueur Y">

    <label>Email</label>
    <input id="newProviderEmail" placeholder="exemple@domaine.com">

    <button onclick="addProvider()">Ajouter</button>

    <hr>

    <label>Message optionnel pour le prestataire</label>
    <textarea id="providerMessage" placeholder="Texte optionnel (inclus dans l‚Äôemail automatique)..." style="height:110px;"></textarea>
    <div id="sendAutoStatus" class="hint"></div>

    <div class="row">
      <button onclick="sendToSelectedAuto()">‚úÖ Envoyer automatiquement (recommand√©)</button>
      <button class="secondary" onclick="openEmailToSelected()">Ouvrir email (manuel)</button>
      <button class="secondary" onclick="copyLink()">Copier le lien</button>
    </div>

    <p class="hint">
      Objet email auto : <strong>Courtier: NOM DU CLIENT</strong> (automatique).<br>
      Le lien du portail est inclus, et l‚Äôhistorique relances se met √† jour.
    </p>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1YmhzamtzdGJycWx2bXlsb2J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDE1NzQsImV4cCI6MjA4NDk3NzU3NH0.tANS4zo9wvLsWJS48Hyw6thttQX0yhBjOKI1aY4FTCo";
const FIXED_PRESCRIBER_EMAIL = "courtier@mfautosud.fr";

/* ‚úÖ √©vite erreur bouton */
window.saveConfig = function(){
  setResult("‚úÖ OK (h√©berg√© sur GitHub Pages).");
};

/* =========================
   UTILS
========================= */
function getHashParams(){
  const p = new URLSearchParams(window.location.hash.replace("#",""));
  return { rid: p.get("rid"), code: p.get("code"), pe: p.get("pe") };
}
function randomCode(){
  const a = crypto.getRandomValues(new Uint8Array(16));
  return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("");
}
function setResult(html, ok=true){
  const el = document.getElementById("result");
  if(!el) return;
  el.style.color = ok ? "#9dffb3" : "#ff9d9d";
  el.innerHTML = html;
}
function joinAddress(d){
  const line1 = d.address || "";
  const line2 = [d.postcode, d.city].filter(Boolean).join(" ");
  const line3 = d.country || "";
  return [line1, line2, line3].filter(Boolean).join("<br>");
}
function fmt(iso){
  return iso ? new Date(iso).toLocaleString("fr-FR") : "‚Äî";
}

/* =========================
   PARSE "COPIER-COLLER"
========================= */
function parsePaste(text){
  const t = (text || "").replace(/\r/g, "").trim();
  const lines = t.split("\n").map(l => l.trim()).filter(Boolean);

  const out = {
    client_name: "",
    address: "",
    postcode: "",
    city: "",
    country: "",
    siret: "",
    vat: "",
    contact_name: "",
    contact_email: "",
    contact_phone: ""
  };
  if (!lines.length) return out;

  out.client_name = lines[0];

  const isTitleLine = (l) => {
    const x = l.toLowerCase();
    return x === "client" || x === "contacts" || x === "contact";
  };
  const isUselessLine = (l) => {
    const x = l.toLowerCase();
    return x.includes("mandat d'autorisation") || x.includes("responsable mf autosud");
  };

  for (let i = 1; i < lines.length; i++) {
    const l = lines[i];
    if (isTitleLine(l)) continue;
    if (isUselessLine(l)) continue;

    const siretMatch = l.match(/siret\s*[:\-]?\s*([0-9 ]{10,20})/i);
    if (siretMatch) { out.siret = siretMatch[1].replace(/\s+/g, "").trim(); continue; }

    const vatMatch = l.match(/tva\s*[:\-]?\s*([A-Z]{2}\s*[0-9A-Z ]{5,})/i);
    if (vatMatch) { out.vat = vatMatch[1].replace(/\s+/g, "").trim(); continue; }

    const emailMatch = l.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    if (emailMatch && !out.contact_email) { out.contact_email = emailMatch[0]; continue; }

    const phoneMatch = l.match(/(\+33|0)\s*[1-9](?:[\s.\-]*\d{2}){4}/);
    if (phoneMatch && !out.contact_phone) { out.contact_phone = phoneMatch[0].replace(/\s+/g, "").trim(); continue; }

    if (!out.address && /\d{5}/.test(l)) {
      out.address = l;
      const cpCity = l.match(/(\d{5})\s+(.+)/);
      if (cpCity) {
        out.postcode = cpCity[1];
        out.city = cpCity[2].replace(/\s+France$/i, "").trim();
        if (/France$/i.test(l)) out.country = "France";
      }
      continue;
    }

    if (!out.contact_name) {
      const looksLikeInitials = /^[A-Za-z]{1,3}$/.test(l);
      const hasDigits = /\d/.test(l);
      const hasAt = l.includes("@");
      if (!looksLikeInitials && !hasDigits && !hasAt && l.split(" ").length >= 2) {
        out.contact_name = l;
        continue;
      }
    }
  }

  if (!out.country && /France/i.test(t)) out.country = "France";
  return out;
}

/* =========================
   PRESTATAIRES (localStorage)
========================= */
const PROVIDERS_KEY = "mfautosud_providers_v1";

function loadProviders(){
  try{
    const raw = localStorage.getItem(PROVIDERS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveProviders(arr){ localStorage.setItem(PROVIDERS_KEY, JSON.stringify(arr)); }
function normalizeEmail(email){ return (email || "").trim().toLowerCase(); }

function renderProviders(){
  const listEl = document.getElementById("providersList");
  if(!listEl) return;

  const providers = loadProviders();
  if(providers.length === 0){
    listEl.innerHTML = `<p class="hint">Aucun prestataire enregistr√©.</p>`;
    return;
  }

  listEl.innerHTML = providers.map((p, idx) => {
    const label = p.name ? `${p.name} ‚Äî ${p.email}` : p.email;
    return `
      <div class="providerRow">
        <input type="checkbox" class="providerCheck" data-email="${p.email}">
        <span>${label}</span>
        <button class="small" onclick="openEmailToOne('${p.email}')">Email</button>
        <button class="small secondary" onclick="removeProvider(${idx})">Suppr.</button>
      </div>
    `;
  }).join("");
}

window.addProvider = function(){
  const name = (document.getElementById("newProviderName")?.value || "").trim();
  const email = normalizeEmail(document.getElementById("newProviderEmail")?.value);

  if(!email || !email.includes("@")){
    alert("Email invalide.");
    return;
  }

  const providers = loadProviders();
  if(providers.some(p => normalizeEmail(p.email) === email)){
    alert("D√©j√† enregistr√©.");
    return;
  }

  providers.push({ name, email });
  saveProviders(providers);

  document.getElementById("newProviderName").value = "";
  document.getElementById("newProviderEmail").value = "";
  renderProviders();
};

window.removeProvider = function(index){
  const providers = loadProviders();
  providers.splice(index, 1);
  saveProviders(providers);
  renderProviders();
};

/* =========================
   LIEN + ENVOI
========================= */
let LAST_REQUEST_LINK = "";
let LAST_CLIENT_NAME = "";
let LAST_VEHICLE = "";

function showSendBox(link, clientName, vehicle){
  LAST_REQUEST_LINK = link;
  LAST_CLIENT_NAME = clientName || "";
  LAST_VEHICLE = vehicle || "";

  const box = document.getElementById("sendBox");
  const sendLinkBox = document.getElementById("sendLinkBox");
  if(!box || !sendLinkBox) return;

  sendLinkBox.innerHTML = `
    <p><strong>Lien de la demande :</strong><br>
    <a href="${link}" target="_blank">${link}</a></p>
    <p class="hint">Client : ${LAST_CLIENT_NAME || "-"} ‚Äî V√©hicule : ${LAST_VEHICLE || "-"}</p>
  `;

  box.style.display = "block";
  renderProviders();
}

window.copyLink = async function(){
  if(!LAST_REQUEST_LINK){ alert("Aucun lien."); return; }
  await navigator.clipboard.writeText(LAST_REQUEST_LINK);
  alert("Lien copi√©.");
};

function buildMailto(toList){
  const subject = encodeURIComponent(`Courtier : ${LAST_CLIENT_NAME || "Client"}`);

  const body = encodeURIComponent(
`Bonjour,

Veuillez consulter la demande via le lien ci-dessous et d√©poser votre proposition (documents + message) :
${LAST_REQUEST_LINK}

V√©hicule souhait√© : ${LAST_VEHICLE || "-"}

Cordialement,

Maxant & Florence Couraud
La Direction MF Autosud
06 08 92 47 89 | 06 23 57 49 20
${FIXED_PRESCRIBER_EMAIL} ‚Äì www.mfautosud.fr`
  );

  const to = encodeURIComponent(toList.join(","));
  return `mailto:${to}?subject=${subject}&body=${body}`;
}

window.openEmailToOne = function(email){
  if(!LAST_REQUEST_LINK){ alert("Cr√©e d‚Äôabord une demande."); return; }
  window.location.href = buildMailto([email]);
};

window.openEmailToSelected = function(){
  if(!LAST_REQUEST_LINK){ alert("Cr√©e d‚Äôabord une demande."); return; }
  const checks = Array.from(document.querySelectorAll(".providerCheck:checked"));
  const emails = checks.map(c => c.getAttribute("data-email")).filter(Boolean);
  if(emails.length === 0){ alert("S√©lectionne au moins 1 prestataire."); return; }
  window.location.href = buildMailto(emails);
};

/* ‚úÖ Envoi automatique via Edge Function send-request */
window.sendToSelectedAuto = async function(){
  if(!LAST_REQUEST_LINK){
    alert("Cr√©e d‚Äôabord une demande (lien manquant).");
    return;
  }

  const checks = Array.from(document.querySelectorAll(".providerCheck:checked"));
  const emails = checks.map(c => c.getAttribute("data-email")).filter(Boolean);
  if(emails.length === 0){
    alert("S√©lectionne au moins 1 prestataire.");
    return;
  }

  const statusEl = document.getElementById("sendAutoStatus");
  const msg = (document.getElementById("providerMessage")?.value || "").trim();
  if(statusEl) statusEl.textContent = "Envoi automatique en cours‚Ä¶";

  // Extraire rid + code depuis le lien
  const u = new URL(LAST_REQUEST_LINK);
  const h = new URLSearchParams(u.hash.replace("#",""));
  const request_id = h.get("rid");
  const access_code = h.get("code");

  if(!request_id || !access_code){
    if(statusEl) statusEl.textContent = "‚ùå Impossible de lire rid/code dans le lien.";
    return;
  }

  const res = await fetch(`${SUPABASE_URL}/functions/v1/send-request`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY
    },
    body: JSON.stringify({
      request_id,
      access_code,
      provider_emails: emails,
      custom_message: msg
    })
  });

  const txt = await res.text();
  if(!res.ok){
    console.log("send-request failed:", res.status, txt);
    if(statusEl) statusEl.textContent = "‚ùå Erreur envoi (HTTP " + res.status + ")";
    return;
  }

  if(statusEl) statusEl.textContent = "‚úÖ Envoy√© ! (emails + provider_invites enregistr√©s)";
  if(typeof loadHistory === "function") loadHistory();
};

/* =========================
   HISTORIQUE RELANCES
========================= */
window.loadHistory = async function () {
  const statusEl = document.getElementById("historyStatus");
  const tableEl = document.getElementById("historyTable");
  if (!statusEl || !tableEl) return;

  statusEl.textContent = "Chargement‚Ä¶";
  tableEl.innerHTML = "";

  try {
    const reqRes = await fetch(
      `${SUPABASE_URL}/rest/v1/requests?select=id,client_name,vehicle,status,created_at&order=created_at.desc&limit=25`,
      { headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY } }
    );
    if (!reqRes.ok) throw new Error(`requests HTTP ${reqRes.status}: ${await reqRes.text()}`);
    const requests = await reqRes.json();
    if (!requests.length) { statusEl.textContent = "Aucune demande."; return; }

    const ids = requests.map(r => r.id);
    const inList = ids.map(id => `"${id}"`).join(",");

    const invRes = await fetch(
      `${SUPABASE_URL}/rest/v1/provider_invites?select=request_id,provider_email,sent_at,responded_at,last_reminder_at,reminder_count&request_id=in.(${inList})&order=sent_at.desc`,
      { headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY } }
    );
    if (!invRes.ok) throw new Error(`provider_invites HTTP ${invRes.status}: ${await invRes.text()}`);
    const invites = await invRes.json();

    const byReq = new Map();
    for (const inv of invites) {
      const k = inv.request_id;
      if (!byReq.has(k)) byReq.set(k, []);
      byReq.get(k).push(inv);
    }

    const badge = (inv) => {
      if (inv.responded_at) return `<span style="color:#9dffb3;font-weight:700;">‚úÖ R√©pondu</span>`;
      if ((inv.reminder_count || 0) > 0) return `<span style="color:#ffd38a;font-weight:700;">‚è≥ Relanc√© (${inv.reminder_count})</span>`;
      return `<span style="color:#ff9d9d;font-weight:700;">üïí En attente</span>`;
    };

    let html = `
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Demande</th>
              <th>Prestataire</th>
              <th>Envoy√©</th>
              <th>Derni√®re relance</th>
              <th>Nb</th>
              <th>R√©pondu</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
    `;

    for (const r of requests) {
      const invs = byReq.get(r.id) || [];

      if (!invs.length) {
        html += `
          <tr>
            <td>
              <div style="font-weight:700;">${r.client_name || "‚Äî"}</div>
              <div style="opacity:.8;">${r.vehicle || "‚Äî"}</div>
              <div style="opacity:.6;font-size:12px;">Cr√©√©e: ${fmt(r.created_at)}</div>
            </td>
            <td colspan="6" class="hint">Aucun prestataire (provider_invites vide)</td>
          </tr>`;
        continue;
      }

      for (const inv of invs) {
        html += `
          <tr>
            <td>
              <div style="font-weight:700;">${r.client_name || "‚Äî"}</div>
              <div style="opacity:.8;">${r.vehicle || "‚Äî"}</div>
              <div style="opacity:.6;font-size:12px;">Cr√©√©e: ${fmt(r.created_at)}</div>
            </td>
            <td>${inv.provider_email || "‚Äî"}</td>
            <td>${fmt(inv.sent_at)}</td>
            <td>${fmt(inv.last_reminder_at)}</td>
            <td style="text-align:center;">${inv.reminder_count ?? 0}</td>
            <td>${fmt(inv.responded_at)}</td>
            <td>${badge(inv)}</td>
          </tr>`;
      }
    }

    html += `</tbody></table></div>`;
    tableEl.innerHTML = html;
    statusEl.textContent = `‚úÖ ${requests.length} demandes / ${invites.length} lignes prestataires`;

  } catch (e) {
    statusEl.textContent = "‚ùå " + String(e);
  }
};

/* =========================
   MODE INTERLOCUTEUR / PRESCRIPTEUR
========================= */
const { rid, code, pe } = getHashParams();

if (rid && code) {
  // --- MODE PRESTATAIRE ---
  document.getElementById("prescriberBox").style.display = "none";
  document.getElementById("createBox").style.display = "none";
  document.getElementById("historyBox").style.display = "none";
  document.getElementById("sendBox").style.display = "none";

  document.body.innerHTML = `<h1>Demande re√ßue</h1><p>Chargement‚Ä¶</p>`;

  fetch(`${SUPABASE_URL}/rest/v1/requests?select=*&id=eq.${rid}&access_code=eq.${code}`, {
    headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY }
  })
  .then(res => { if(!res.ok) throw new Error("HTTP "+res.status); return res.json(); })
  .then(rows => {
    if(!rows.length){
      document.body.innerHTML = `<h1>Acc√®s refus√©</h1><p>Demande invalide ou expir√©e.</p>`;
      return;
    }

    const d = rows[0];
    const addr = joinAddress(d);

    document.body.innerHTML = `
      <div style="max-width:900px">
        <h1 style="color:#4da3ff;margin:0">${d.client_name || "Client"}</h1>
        <div class="pill">Client</div>

        <p style="margin:14px 0 0;opacity:.9;">
          <strong>V√©hicule souhait√© :</strong> ${d.vehicle || "-"}
        </p>

        <p style="margin:6px 0 0;opacity:.9;">
          <strong>Email prescripteur :</strong>
          <a href="mailto:${FIXED_PRESCRIBER_EMAIL}" style="color:#7cc0ff;text-decoration:none;">
            ${FIXED_PRESCRIBER_EMAIL}
          </a>
        </p>

        ${addr ? `<hr><p>üìç ${addr}</p>` : ""}

        ${(d.siret || d.vat) ? `
          <hr>
          <p>
            ${d.siret ? `üè¢ N¬∞ SIRET : ${d.siret}<br>` : ""}
            ${d.vat ? `üèõÔ∏è N¬∞ TVA : ${d.vat}` : ""}
          </p>
        ` : ""}

        ${(d.contact_name || d.contact_email || d.contact_phone) ? `
          <hr>
          <h2>Contact</h2>
          <p>
            ${d.contact_name ? `<strong>${d.contact_name}</strong><br>` : ""}
            ${d.contact_email ? `üìß ${d.contact_email}<br>` : ""}
            ${d.contact_phone ? `üìû ${d.contact_phone}` : ""}
          </p>
        ` : ""}

        <hr>

        <h2>Votre r√©ponse</h2>
        <label>Message</label>
        <textarea id="responseMessage" style="height:110px;"></textarea>

        <label>Documents (PDF, images, etc.)</label>
        <input type="file" id="responseFiles" multiple>

        <button id="sendResponse">Envoyer la r√©ponse</button>
        <p id="responseStatus"></p>
      </div>
    `;

    document.getElementById("sendResponse").addEventListener("click", async () => {
      const status = document.getElementById("responseStatus");
      status.innerText = "Envoi en cours‚Ä¶";

      const message = document.getElementById("responseMessage").value || "";
      const filesInput = document.getElementById("responseFiles");

      const files = [];
      for (const file of filesInput.files) {
        const dataUrl = await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(file);
        });
        files.push({ name: file.name, type: file.type || "application/octet-stream", dataUrl });
      }

      const providerEmail = (pe || "").trim().toLowerCase();

      const res = await fetch(`${SUPABASE_URL}/functions/v1/submit-response`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_ANON_KEY,
          Authorization: "Bearer " + SUPABASE_ANON_KEY
        },
        body: JSON.stringify({
          request_id: rid,
          access_code: code,
          responder_name: "Prestataire",
          responder_email: providerEmail,
          provider_email: providerEmail,
          message,
          files
        })
      });

      if(!res.ok){
        const txt = await res.text();
        status.innerText = "‚ùå Erreur envoi (HTTP "+res.status+")";
        console.log("DETAIL submit-response:", txt);
        return;
      }

      status.innerText = "‚úÖ R√©ponse envoy√©e avec succ√®s";
    });
  })
  .catch(err => {
    document.body.innerHTML = `<h1>Erreur</h1><p>${err.message}</p>`;
  });

} else {
  // --- MODE PRESCRIPTEUR ---
  renderProviders();
  setTimeout(() => { if (typeof loadHistory === "function") loadHistory(); }, 600);

  window.createRequest = async function(){
    const vehicle = document.getElementById("vehicle").value.trim();
    const pasted = document.getElementById("pasteBlock").value || "";
    const parsed = parsePaste(pasted);

    if(!vehicle || !pasted){
      setResult("‚ùå Remplis le v√©hicule et colle le bloc client.", false);
      return;
    }
    if(!parsed.client_name){
      setResult("‚ùå Nom client introuvable (1√®re ligne).", false);
      return;
    }

    const access_code = randomCode();

    const payload = {
      prescriber_email: FIXED_PRESCRIBER_EMAIL,
      client_name: parsed.client_name,
      vehicle: vehicle,
      fin_type: "LLD",
      recipients: [FIXED_PRESCRIBER_EMAIL],
      access_code,
      status: "sent",

      address: parsed.address,
      postcode: parsed.postcode,
      city: parsed.city,
      country: parsed.country,
      siret: parsed.siret,
      vat: parsed.vat,
      contact_name: parsed.contact_name,
      contact_email: parsed.contact_email,
      contact_phone: parsed.contact_phone
    };

    const res = await fetch(`${SUPABASE_URL}/rest/v1/requests`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type": "application/json",
        Prefer: "return=representation"
      },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const txt = await res.text();
      setResult("‚ùå Erreur cr√©ation (HTTP "+res.status+")", false);
      console.log("DETAIL createRequest:", txt);
      return;
    }

    const rows = await res.json();
    const id = rows[0].id;

    const link = `${location.href.split("#")[0]}#rid=${id}&code=${access_code}`;
    setResult(`‚úÖ Lien g√©n√©r√© :<br><a href="${link}" target="_blank">${link}</a>`);

    showSendBox(link, parsed.client_name, vehicle);
  };
}
</script>

</body>
</html>
