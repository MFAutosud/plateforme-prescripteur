<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Plateforme prescripteur ‚Äì MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{font-family:Arial;background:#0b1220;color:#fff;padding:24px}
    h1{color:#4da3ff;margin:0 0 18px}
    h2{margin:0 0 10px}
    .box{background:#111c34;padding:16px;border-radius:10px;margin-bottom:18px}
    label{display:block;margin-top:12px;opacity:.9}
    input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2b3a5a;background:#0b1220;color:#fff}
    button{margin-top:14px;padding:12px;border-radius:10px;border:0;background:#4da3ff;color:#000;font-weight:bold;cursor:pointer}
    button.secondary{background:#334155;color:#fff}
    button.small{padding:8px 10px;margin-top:0;border-radius:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hint{opacity:.7;font-size:12px;margin-top:6px;white-space:pre-wrap}
    .msg{background:#0b1220;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,.08)}
    .msg.you{border-left:4px solid #4da3ff}
    .msg.them{border-left:4px solid #22c55e}
    a{color:#7cc0ff}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;background:#24365f;margin-left:6px}
  </style>
</head>

<body>
<h1>Plateforme prescripteur ‚Äì MF Auto Sud</h1>

<!-- =========================
     MODE 1 : ACCUEIL PRESCRIPTEUR
========================= -->
<div id="homeUI">
  <div class="box">
    <h2>1) Cr√©er une demande</h2>

    <label>Client</label>
    <input id="client" placeholder="Ex: COTE SANTE">

    <label>V√©hicule</label>
    <input id="vehicle" placeholder="Ex: Ford Puma LLD 25 mois 30 000 km + entretien">

    <label>Bloc client (optionnel : colle tout, on essaie d‚Äôextraire email/tel)</label>
    <textarea id="pasteBlock" placeholder="Optionnel : colle le bloc complet ici‚Ä¶" style="height:120px"></textarea>
    <div class="hint">Astuce : si tu colles un email ou un t√©l√©phone, on le stocke dans la demande.</div>

    <button onclick="createRequest()">Cr√©er</button>
    <div id="link" class="hint"></div>
  </div>

  <div class="box">
    <h2>2) Envoyer √† un prestataire</h2>

    <label>Email prestataire</label>
    <input id="provider" placeholder="exemple@domaine.com">

    <div class="row">
      <button onclick="send()">Envoyer (automatique)</button>
      <button class="secondary" onclick="copyProviderLink()">Copier lien prestataire</button>
      <button class="secondary" onclick="copyPrescriberThreadLink()">Copier lien dossier (prescripteur)</button>
    </div>

    <div id="sendStatus" class="hint"></div>
  </div>

  <div class="box">
    <h2>3) Conversation (dossier en cours)</h2>
    <div class="row">
      <button class="secondary" onclick="loadThread()">üîÑ Rafra√Æchir</button>
    </div>
    <div id="threadHome" style="margin-top:10px"></div>
  </div>
</div>

<!-- =========================
     MODE 2 : DOSSIER PRESCRIPTEUR (rid+code, sans pe)
========================= -->
<div id="prescriberThreadUI" style="display:none;">
  <div class="box">
    <h2>Dossier <span class="pill">Prescripteur</span></h2>
    <div id="requestInfoPrescriber" class="hint">Chargement‚Ä¶</div>
    <div class="row" style="margin-top:10px">
      <button class="secondary" onclick="loadThread()">üîÑ Rafra√Æchir</button>
      <button class="secondary" onclick="copyCurrentLink()">Copier le lien</button>
    </div>
  </div>

  <div class="box">
    <h2>Conversation</h2>
    <div id="threadPrescriber" style="margin-top:10px"></div>
  </div>

  <div class="box">
    <h2>R√©pondre</h2>

    <label>Votre message</label>
    <textarea id="respMsgPrescriber" style="height:120px" placeholder="Votre r√©ponse‚Ä¶"></textarea>

    <label>Documents (PDF, images, etc.)</label>
    <input type="file" id="respFilesPrescriber" multiple>

    <button onclick="submitResponsePrescriber()">Envoyer la r√©ponse</button>
    <div id="respStatusPrescriber" class="hint"></div>
  </div>
</div>

<!-- =========================
     MODE 3 : DOSSIER PRESTATAIRE (rid+code+pe)
========================= -->
<div id="providerUI" style="display:none;">
  <div class="box">
    <h2>Demande re√ßue <span class="pill">Prestataire</span></h2>
    <div id="requestInfoProvider" class="hint">Chargement‚Ä¶</div>
  </div>

  <div class="box">
    <h2>Conversation</h2>
    <button class="secondary" onclick="loadThread()">üîÑ Rafra√Æchir</button>
    <div id="threadProvider" style="margin-top:10px"></div>
  </div>

  <div class="box">
    <h2>R√©pondre</h2>

    <label>Votre message</label>
    <textarea id="respMsgProvider" style="height:120px" placeholder="Texte d‚Äôaccompagnement‚Ä¶"></textarea>

    <label>Documents (PDF, images, etc.)</label>
    <input type="file" id="respFilesProvider" multiple>

    <button onclick="submitResponseProvider()">Envoyer la r√©ponse</button>
    <div id="respStatusProvider" class="hint"></div>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1YmhzamtzdGJycWx2bXlsb2J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDE1NzQsImV4cCI6MjA4NDk3NzU3NH0.tANS4zo9wvLsWJS48Hyw6thttQX0yhBjOKI1aY4FTCo";
const PRESCRIBER_EMAIL = "courtier@mfautosud.fr";

/* =========================
   STATE
========================= */
let RID = "";
let CODE = "";
let PROVIDER_EMAIL = ""; // seulement en mode prestataire
let MODE = "home"; // home | prescriber_thread | provider

/* =========================
   UTILS
========================= */
function $(id){ return document.getElementById(id); }

function getHashParams(){
  const p = new URLSearchParams(location.hash.replace("#",""));
  return { rid: p.get("rid"), code: p.get("code"), pe: p.get("pe") };
}

function randomCode(){
  const a = crypto.getRandomValues(new Uint8Array(16));
  return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("");
}

function emailFromText(t){
  const m = String(t||"").match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
  return m ? m[0].toLowerCase() : "";
}

function phoneFromText(t){
  const m = String(t||"").match(/(\+33|0)\s*[1-9](?:[\s.\-]*\d{2}){4}/);
  return m ? m[0].replace(/\s+/g,"") : "";
}

async function fetchJson(url, options){
  const res = await fetch(url, options);
  let data = null;
  try { data = await res.json(); } catch { /* ignore */ }
  return { res, data };
}

async function readFileAsDataURL(file){
  return await new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function baseUrl(){
  return location.href.split("#")[0];
}

function safeText(s){
  return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function showMode(mode){
  MODE = mode;
  $("homeUI").style.display = (mode === "home") ? "block" : "none";
  $("prescriberThreadUI").style.display = (mode === "prescriber_thread") ? "block" : "none";
  $("providerUI").style.display = (mode === "provider") ? "block" : "none";
}

function currentLink(){
  const p = [];
  if(RID) p.push(`rid=${encodeURIComponent(RID)}`);
  if(CODE) p.push(`code=${encodeURIComponent(CODE)}`);
  if(MODE === "provider" && PROVIDER_EMAIL) p.push(`pe=${encodeURIComponent(PROVIDER_EMAIL)}`);
  return `${baseUrl()}#${p.join("&")}`;
}

function copyCurrentLink(){
  navigator.clipboard.writeText(currentLink());
  alert("Lien copi√©.");
}

/* =========================
   CREATE REQUEST (home)
========================= */
async function createRequest(){
  const client = $("client").value.trim();
  const vehicle = $("vehicle").value.trim();
  const paste = ($("pasteBlock").value || "").trim();

  if(!client || !vehicle){
    alert("Client + V√©hicule sont obligatoires.");
    return;
  }

  RID = "";
  CODE = randomCode();

  const contact_email = emailFromText(paste);
  const contact_phone = phoneFromText(paste);

  const payload = {
    status: "sent",
    prescriber_email: PRESCRIBER_EMAIL,
    client_name: client,
    vehicle: vehicle,
    fin_type: "LLD",
    recipients: [PRESCRIBER_EMAIL],
    access_code: CODE,
    contact_email: contact_email || null,
    contact_phone: contact_phone || null,
  };

  const { res, data } = await fetchJson(`${SUPABASE_URL}/rest/v1/requests`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    console.log("createRequest failed:", res.status, data);
    alert("Erreur cr√©ation demande (voir console).");
    return;
  }

  RID = data[0].id;

  const link = `${baseUrl()}#rid=${RID}&code=${CODE}`;
  $("link").textContent = `‚úÖ Demande cr√©√©e\nLien dossier prescripteur : ${link}`;
  await loadThread();
}

/* =========================
   SEND REQUEST (send-request)
========================= */
async function send(){
  const email = $("provider").value.trim().toLowerCase();
  if(!email){ alert("Email prestataire requis."); return; }
  if(!RID || !CODE){ alert("Cr√©e d‚Äôabord une demande."); return; }

  $("sendStatus").textContent = "Envoi automatique‚Ä¶";

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/send-request`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      provider_emails: [email],
      custom_message: ""
    })
  });

  if(!res.ok){
    console.log("send-request failed:", res.status, data);
    $("sendStatus").textContent = "‚ùå Erreur\n" + JSON.stringify(data, null, 2);
    return;
  }

  $("sendStatus").textContent = "‚úÖ Envoy√©\n" + JSON.stringify(data, null, 2);
}

function copyProviderLink(){
  const email = $("provider").value.trim().toLowerCase();
  if(!email){ alert("Renseigne l‚Äôemail prestataire."); return; }
  if(!RID || !CODE){ alert("Cr√©e d‚Äôabord une demande."); return; }
  const link = `${baseUrl()}#rid=${RID}&code=${CODE}&pe=${encodeURIComponent(email)}`;
  navigator.clipboard.writeText(link);
  alert("Lien prestataire copi√©.");
}

function copyPrescriberThreadLink(){
  if(!RID || !CODE){ alert("Cr√©e d‚Äôabord une demande."); return; }
  const link = `${baseUrl()}#rid=${RID}&code=${CODE}`;
  navigator.clipboard.writeText(link);
  alert("Lien dossier prescripteur copi√©.");
}

/* =========================
   LOAD THREAD (get-request)
========================= */
async function loadThread(){
  if(!RID || !CODE) return;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/get-request`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ request_id: RID, access_code: CODE })
  });

  if(!res.ok){
    console.log("get-request failed:", res.status, data);
    if(MODE === "provider") $("requestInfoProvider").textContent = "‚ùå Erreur chargement.";
    if(MODE === "prescriber_thread") $("requestInfoPrescriber").textContent = "‚ùå Erreur chargement.";
    return;
  }

  // request info
  const r = data.request || {};
  const info =
`Client: ${r.client_name || "-"}
V√©hicule: ${r.vehicle || "-"}
Contact email: ${r.contact_email || "-"}
Contact tel: ${r.contact_phone || "-"}`;

  if(MODE === "provider") $("requestInfoProvider").textContent = info;
  if(MODE === "prescriber_thread") $("requestInfoPrescriber").textContent = info;

  // render messages
  const msgs = (data.responses || []);
  const render = (containerId, youEmailLower) => {
    const el = $(containerId);
    if(!el) return;
    el.innerHTML = "";
    msgs.forEach(x=>{
      const email = String(x.responder_email || "").toLowerCase();
      const isYou = youEmailLower ? (email === youEmailLower) : false;

      // si prescripteur : "vous" = PRESCRIBER_EMAIL OU responder_email vide
      let who = x.responder_email || "MF Auto Sud";
      if(containerId.includes("Home") || containerId.includes("Prescriber")){
        if(!x.responder_email || email === PRESCRIBER_EMAIL.toLowerCase()) who = "Vous";
      } else {
        // c√¥t√© prestataire : "vous" = PROVIDER_EMAIL
        if(youEmailLower && email === youEmailLower) who = "Vous";
      }

      const css = (containerId.includes("Provider"))
        ? (isYou ? "you" : "them")
        : ((!x.responder_email || email === PRESCRIBER_EMAIL.toLowerCase()) ? "you" : "them");

      el.innerHTML += `
        <div class="msg ${css}">
          <div class="hint">${new Date(x.created_at).toLocaleString("fr-FR")}</div>
          <strong>${safeText(who)}</strong><br>
          ${safeText(x.message || "").replaceAll("\n","<br>")}
        </div>`;
    });
  };

  render("threadHome", null);
  render("threadPrescriber", null);
  render("threadProvider", (PROVIDER_EMAIL || "").toLowerCase());
}

/* =========================
   SUBMIT RESPONSE : PROVIDER
========================= */
async function submitResponseProvider(){
  const statusEl = $("respStatusProvider");

  if(!RID || !CODE){
    statusEl.textContent = "‚ùå Lien invalide (rid/code manquants).";
    return;
  }
  if(!PROVIDER_EMAIL){
    statusEl.textContent = "‚ùå Lien prestataire incomplet : pe manquant.";
    return;
  }

  statusEl.textContent = "Envoi en cours‚Ä¶";

  const msg = ($("respMsgProvider").value || "").trim();
  const filesInput = $("respFilesProvider");

  const files = [];
  for(const file of (filesInput.files || [])){
    const dataUrl = await readFileAsDataURL(file);
    files.push({ name: file.name, type: file.type || "application/octet-stream", dataUrl });
  }

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/submit-response`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      author_role: "provider",
      responder_name: "Prestataire",
      responder_email: PROVIDER_EMAIL,
      provider_email: PROVIDER_EMAIL,
      message: msg,
      files
    })
  });

  if(!res.ok){
    console.log("submit-response (provider) failed:", res.status, data);
    statusEl.textContent = "‚ùå Erreur\n" + JSON.stringify(data, null, 2);
    return;
  }

  statusEl.textContent = "‚úÖ Envoy√©";
  $("respMsgProvider").value = "";
  $("respFilesProvider").value = "";
  await loadThread();
}

/* =========================
   SUBMIT RESPONSE : PRESCRIBER
========================= */
async function submitResponsePrescriber(){
  const statusEl = $("respStatusPrescriber");

  if(!RID || !CODE){
    statusEl.textContent = "‚ùå Lien invalide (rid/code manquants).";
    return;
  }

  statusEl.textContent = "Envoi en cours‚Ä¶";

  const msg = ($("respMsgPrescriber").value || "").trim();
  const filesInput = $("respFilesPrescriber");

  const files = [];
  for(const file of (filesInput.files || [])){
    const dataUrl = await readFileAsDataURL(file);
    files.push({ name: file.name, type: file.type || "application/octet-stream", dataUrl });
  }

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/submit-response`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      author_role: "prescriber",
      responder_name: "MF Auto Sud",
      responder_email: PRESCRIBER_EMAIL,
      message: msg,
      files
    })
  });

  if(!res.ok){
    console.log("submit-response (prescriber) failed:", res.status, data);
    statusEl.textContent = "‚ùå Erreur\n" + JSON.stringify(data, null, 2);
    return;
  }

  statusEl.textContent = "‚úÖ Envoy√©";
  $("respMsgPrescriber").value = "";
  $("respFilesPrescriber").value = "";
  await loadThread();
}

/* =========================
   INIT
========================= */
(async function init(){
  const { rid, code, pe } = getHashParams();

  if(rid && code){
    RID = rid;
    CODE = code;

    // ‚úÖ Prestataire seulement si pe est pr√©sent
    if(pe){
      PROVIDER_EMAIL = (pe || "").trim().toLowerCase();
      showMode("provider");
    } else {
      // ‚úÖ sinon : prescripteur dossier
      showMode("prescriber_thread");
    }

    await loadThread();
    return;
  }

  // Accueil
  showMode("home");
})();
</script>

</body>
</html>
