<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Plateforme prescripteur ‚Äì MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{font-family:Arial;background:#0b1220;color:#fff;padding:24px}
    h1{color:#4da3ff;margin:0 0 18px}
    h2{margin:0 0 10px}
    .box{background:#111c34;padding:16px;border-radius:10px;margin-bottom:18px}
    label{display:block;margin-top:12px;opacity:.9}
    input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2b3a5a;background:#0b1220;color:#fff}
    button{margin-top:14px;padding:12px;border-radius:10px;border:0;background:#4da3ff;color:#000;font-weight:bold;cursor:pointer}
    button.secondary{background:#334155;color:#fff}
    button.small{padding:8px 10px;margin-top:0;border-radius:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hint{opacity:.7;font-size:12px;margin-top:6px;white-space:pre-wrap}
    .msg{background:#0b1220;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,.08)}
    .msg.you{border-left:4px solid #4da3ff}
    .msg.them{border-left:4px solid #22c55e}
    a{color:#7cc0ff}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;background:#24365f;margin-left:6px}
    .file{display:inline-block;margin-top:6px;padding:6px 10px;border-radius:10px;background:#334155;color:#fff;text-decoration:none}
    hr{border:0;border-top:1px solid rgba(255,255,255,.12);margin:14px 0}
    .providerRow{display:flex;align-items:center;gap:10px;margin:8px 0}
    .providerRow span{flex:1}
  </style>
</head>

<body>
<h1>Plateforme prescripteur ‚Äì MF Auto Sud</h1>

<!-- =========================
     PRESCRIPTEUR UI
========================= -->
<div id="prescriberUI">
  <div class="box">
    <h2>1) Cr√©er une demande</h2>

    <label>V√©hicule</label>
    <input id="vehicle" placeholder="Ex: Ford Puma LLD 25 mois 30 000 km + entretien">

    <label>Bloc client (copier-coller) ‚Äî 1√®re ligne = NOM CLIENT</label>
    <textarea id="pasteBlock" style="height:180px" placeholder="Colle ici le bloc complet‚Ä¶"></textarea>

    <div class="hint">
      La 1√®re ligne devient automatiquement le NOM CLIENT.
      Lignes supprim√©es automatiquement :
      - ‚ÄúObtenir un lien √† envoyer au client pour signer un mandat de pr√©l√®vement SEPA‚Äù
      - ‚ÄúResponsable MF Autosud‚Äù
      - et variantes ‚Äúpr√©l√®vement / prelevement‚Äù
    </div>

    <button onclick="createRequest()">Cr√©er</button>
    <div id="link" class="hint"></div>
  </div>

  <div class="box" id="sendBox" style="display:none;">
    <h2>2) Envoyer √† des prestataires</h2>

    <div class="row">
      <button class="secondary" onclick="checkAll()">Tout cocher</button>
      <button class="secondary" onclick="uncheckAll()">Tout d√©cocher</button>
      <button class="secondary" onclick="exportProviders()">Exporter</button>
      <button class="secondary" onclick="clearProviders()">Tout effacer</button>
    </div>

    <div id="providersList" style="margin-top:10px"></div>

    <hr>

    <h3 style="margin:0 0 8px">Ajouter / Importer</h3>

    <label>Email prestataire</label>
    <input id="providerEmail" placeholder="exemple@domaine.com">

    <label>Nom (optionnel)</label>
    <input id="providerName" placeholder="Ex: GROUPE GRIM">

    <div class="row">
      <button onclick="addProvider()">Ajouter</button>
    </div>

    <label>Importer une liste (1 par ligne : Nom &lt;email&gt; ou email)</label>
    <textarea id="importArea" style="height:110px" placeholder="Ex: Nom <email@domaine.com>"></textarea>
    <div class="row">
      <button class="secondary" onclick="importProviders()">Importer</button>
    </div>

    <label>Message (optionnel) inclus dans l‚Äôemail</label>
    <textarea id="customMessage" style="height:90px" placeholder="Texte optionnel‚Ä¶"></textarea>

    <div class="row">
      <button onclick="sendToSelected()">‚úÖ Envoyer automatiquement</button>
      <button class="secondary" onclick="copyThreadLink()">Copier lien demande</button>
    </div>
    <div id="sendStatus" class="hint"></div>
  </div>

  <div class="box">
    <h2>3) Conversation</h2>
    <div class="row">
      <button class="secondary" onclick="loadThread()">üîÑ Rafra√Æchir</button>
      <button class="secondary" onclick="copyThreadLink()">Copier lien demande</button>
    </div>
    <div id="thread" style="margin-top:10px"></div>
  </div>

  <div class="box" id="prescriberReplyBox" style="display:none;">
    <h2>4) R√©pondre (MF Auto Sud)</h2>

    <label>Message</label>
    <textarea id="prescMsg" style="height:120px" placeholder="Votre message‚Ä¶"></textarea>

    <label>Documents (PDF, images‚Ä¶)</label>
    <input type="file" id="prescFiles" multiple>

    <div class="hint">
      La r√©ponse va :
      - s‚Äôenregistrer dans l‚Äôhistorique,
      - notifier par email TOUS les prestataires d√©j√† invit√©s sur cette demande.
    </div>

    <button onclick="submitPrescriberResponse()">Envoyer la r√©ponse</button>
    <div id="prescStatus" class="hint"></div>
  </div>
</div>

<!-- =========================
     PRESTATAIRE UI
========================= -->
<div id="providerUI" style="display:none;">
  <div class="box">
    <h2>Demande re√ßue <span class="pill">Prestataire</span></h2>
    <div id="requestInfo" class="hint">Chargement‚Ä¶</div>
  </div>

  <div class="box">
    <h2>Conversation</h2>
    <button class="secondary" onclick="loadThread()">üîÑ Rafra√Æchir</button>
    <div id="threadProvider" style="margin-top:10px"></div>
  </div>

  <div class="box">
    <h2>R√©pondre</h2>

    <label>Votre message</label>
    <textarea id="respMsg" style="height:120px" placeholder="Texte d‚Äôaccompagnement‚Ä¶"></textarea>

    <label>Documents (PDF, images‚Ä¶)</label>
    <input type="file" id="respFiles" multiple>

    <button onclick="submitProviderResponse()">Envoyer la r√©ponse</button>
    <div id="respStatus" class="hint"></div>
  </div>
</div>
// =========================
// ADMIN : ouvrir une demande
// =========================
async function adminOpen(requestId){
  const { res, data } = await fetchJson(
    `${SUPABASE_URL}/functions/v1/get-admin-link`,
    {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        request_id: requestId,
        admin_email: PRESCRIBER_EMAIL
      })
    }
  );

  if(!res.ok || !data?.link){
    alert("Impossible d‚Äôouvrir la demande");
    console.log(data);
    return;
  }

  // Ouvre la conversation dans un nouvel onglet
  window.open(data.link, "_blank");
}
<script>
/* =========================
   CONFIG
========================= */
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1YmhzamtzdGJycWx2bXlsb2J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDE1NzQsImV4cCI6MjA4NDk3NzU3NH0.tANS4zo9wvLsWJS48Hyw6thttQX0yhBjOKI1aY4FTCo";
const PRESCRIBER_EMAIL = "courtier@mfautosud.fr";

const PROVIDERS_KEY = "mfautosud_providers_v2"; // localStorage

/* =========================
   STATE
========================= */
let RID = "";
let CODE = "";
let PROVIDER_EMAIL = "";

/* =========================
   UTILS
========================= */
function $(id){ return document.getElementById(id); }

function getHashParams(){
  const p = new URLSearchParams(location.hash.replace("#",""));
  return { rid: p.get("rid"), code: p.get("code"), pe: p.get("pe") };
}

function randomCode(){
  const a = crypto.getRandomValues(new Uint8Array(16));
  return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function fetchJson(url, options){
  const res = await fetch(url, options);
  let data = null;
  try { data = await res.json(); } catch {}
  return { res, data };
}

async function readFileAsDataURL(file){
  return await new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function baseUrl(){
  return location.href.split("#")[0];
}

function escHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

/* =========================
   PARSE COPY-PASTE -> client_name + infos
========================= */
function parsePaste(text){
  const t = (text || "").replace(/\r/g, "").trim();
  const lines = t.split("\n").map(l => l.trim()).filter(Boolean);

  const out = {
    client_name: "",
    address: "",
    postcode: "",
    city: "",
    country: "",
    siret: "",
    vat: "",
    contact_name: "",
    contact_email: "",
    contact_phone: ""
  };

  if (!lines.length) return out;

  // ‚úÖ 1√®re ligne = nom client
  out.client_name = lines[0];

  const isTitleLine = (l) => ["client","contacts","contact"].includes(l.toLowerCase());

  const isUselessLine = (l) => {
    const x = l.toLowerCase();
    return (
      x.includes("obtenir un lien") ||
      x.includes("mandat de pr√©l√®vement sepa") ||
      x.includes("mandat de prelevement sepa") ||
      x.includes("prelevement sepa") ||
      x.includes("pr√©l√®vement sepa") ||
      x.includes("responsable mf autosud")
    );
  };

  const looksLikeShortCode = (l) => /^[a-z]{1,3}$/i.test(l.trim());

  for (let i = 1; i < lines.length; i++) {
    const l = lines[i];
    if (isTitleLine(l) || isUselessLine(l) || looksLikeShortCode(l)) continue;

    // Adresse (contient CP 5 chiffres)
    if (!out.address && /\b\d{5}\b/.test(l)) {
      out.address = l;
      const m = l.match(/\b(\d{5})\b\s+(.+)$/);
      if (m) {
        out.postcode = m[1];
        let rest = m[2].trim();
        if (/france$/i.test(rest)) {
          out.country = "France";
          rest = rest.replace(/france$/i, "").trim();
        }
        out.city = rest;
      }
      continue;
    }

    // SIRET
    const siretMatch = l.match(/siret\s*[:\-]?\s*([0-9 ]{10,30})/i);
    if (siretMatch) { out.siret = siretMatch[1].replace(/\s+/g, ""); continue; }

    // TVA
    const vatMatch = l.match(/tva\s*[:\-]?\s*([A-Z]{2}\s*[0-9A-Z ]{6,})/i);
    if (vatMatch) { out.vat = vatMatch[1].replace(/\s+/g, ""); continue; }

    // Email
    const emailMatch = l.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    if (emailMatch && !out.contact_email) { out.contact_email = emailMatch[0].toLowerCase(); continue; }

    // T√©l√©phone FR
    const phoneMatch = l.match(/(\+33|0)\s*[1-9](?:[\s.\-]*\d{2}){4}/);
    if (phoneMatch && !out.contact_phone) { out.contact_phone = phoneMatch[0].replace(/[\s.\-]/g,""); continue; }

    // Nom contact (√©vite phrase)
    if (!out.contact_name) {
      if (!/\d/.test(l) && !l.includes("@") && l.length <= 45) {
        const w = l.split(/\s+/).filter(Boolean);
        if (w.length >= 2 && w.length <= 5) out.contact_name = l;
      }
    }
  }

  if (!out.country && /france/i.test(t)) out.country = "France";
  return out;
}

/* =========================
   PROVIDERS (localStorage)
========================= */
function loadProviders(){
  try{
    const raw = localStorage.getItem(PROVIDERS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}

function saveProviders(arr){
  localStorage.setItem(PROVIDERS_KEY, JSON.stringify(arr));
}

function normalizeEmail(email){
  return (email || "").trim().toLowerCase();
}

function emailLooksValid(e){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
}

function extractEmailAndName(line){
  const s = (line || "").trim();
  if(!s) return null;

  // "Nom <email@...>"
  const m = s.match(/^(.*)<\s*([^>]+)\s*>$/);
  if(m){
    const name = m[1].replace(/^['"]|['"]$/g,"").trim();
    const email = (m[2] || "").trim().toLowerCase();
    return { name, email };
  }

  // "email@..."
  const only = s.replace(/^['"]|['"]$/g,"").trim().toLowerCase();
  if(emailLooksValid(only)) return { name:"", email: only };

  // email quelque part
  const em = s.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
  if(em) return { name:"", email: em[0].toLowerCase() };

  return null;
}

function renderProviders(){
  const listEl = $("providersList");
  if(!listEl) return;

  const providers = loadProviders();
  if(!providers.length){
    listEl.innerHTML = `<div class="hint">Aucun prestataire enregistr√©.</div>`;
    return;
  }

  listEl.innerHTML = providers.map((p, idx) => {
    const label = p.name ? `${p.name} ‚Äî ${p.email}` : p.email;
    return `
      <div class="providerRow">
        <input type="checkbox" class="providerCheck" data-email="${escHtml(p.email)}">
        <span>${escHtml(label)}</span>
        <button class="small secondary" onclick="adminOpen('${r.id}')">
  Ouvrir
</button>

<button class="small secondary" onclick="adminDelete('${r.id}')">
  Supprimer
</button>
    `;
  }).join("");
}

function checkAll(){ document.querySelectorAll(".providerCheck").forEach(c=>c.checked=true); }
function uncheckAll(){ document.querySelectorAll(".providerCheck").forEach(c=>c.checked=false); }

function addProvider(){
  const email = normalizeEmail($("providerEmail").value);
  const name = ($("providerName").value || "").trim();

  if(!emailLooksValid(email)){ alert("Email invalide."); return; }

  const providers = loadProviders();
  if(providers.some(p => normalizeEmail(p.email) === email)){ alert("D√©j√† enregistr√©."); return; }

  providers.push({ name, email });
  saveProviders(providers);

  $("providerEmail").value = "";
  $("providerName").value = "";
  renderProviders();
}

function removeProvider(index){
  const providers = loadProviders();
  providers.splice(index, 1);
  saveProviders(providers);
  renderProviders();
}

function importProviders(){
  const raw = ($("importArea").value || "").replace(/\r/g,"").trim();
  if(!raw){ alert("Colle une liste."); return; }

  const lines = raw.split("\n").map(x=>x.trim()).filter(Boolean);
  const providers = loadProviders();
  const existing = new Set(providers.map(p => normalizeEmail(p.email)));

  let added=0, ignored=0;

  for(const line of lines){
    const parsed = extractEmailAndName(line);
    if(!parsed || !emailLooksValid(parsed.email)){ ignored++; continue; }
    if(existing.has(parsed.email)){ ignored++; continue; }

    providers.push({ name: parsed.name || "", email: parsed.email });
    existing.add(parsed.email);
    added++;
  }

  saveProviders(providers);
  renderProviders();
  alert(`Import termin√©: +${added} ajout√©s / ${ignored} ignor√©s`);
}

async function exportProviders(){
  const providers = loadProviders();
  const lines = providers.map(p => p.name ? `${p.name} <${p.email}>` : p.email).join("\n");
  await navigator.clipboard.writeText(lines || "");
  alert("Liste copi√©e dans le presse-papiers.");
}

function clearProviders(){
  if(!confirm("Supprimer tous les prestataires enregistr√©s sur cet ordinateur ?")) return;
  saveProviders([]);
  renderProviders();
}

/* =========================
   CREATE REQUEST (prescriber)
========================= */
async function createRequest(){
  const vehicle = $("vehicle").value.trim();
  const paste = ($("pasteBlock").value || "").trim();

  if(!vehicle || !paste){
    alert("V√©hicule + bloc client (copier-coller) sont obligatoires.");
    return;
  }

  const parsed = parsePaste(paste);
  if(!parsed.client_name){
    alert("Impossible de lire le nom client (1√®re ligne).");
    return;
  }

  RID = "";
  CODE = randomCode();

  const payload = {
    status: "draft",
    prescriber_email: PRESCRIBER_EMAIL,
    client_name: parsed.client_name,
    vehicle: vehicle,
    fin_type: "LLD",
    recipients: [PRESCRIBER_EMAIL],
    access_code: CODE,

    address: parsed.address || null,
    postcode: parsed.postcode || null,
    city: parsed.city || null,
    country: parsed.country || null,
    siret: parsed.siret || null,
    vat: parsed.vat || null,
    contact_name: parsed.contact_name || null,
    contact_email: parsed.contact_email || null,
    contact_phone: parsed.contact_phone || null
  };

  const { res, data } = await fetchJson(`${SUPABASE_URL}/rest/v1/requests`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    console.log("createRequest failed:", res.status, data);
    alert("Erreur cr√©ation demande (voir console).");
    return;
  }

  RID = data[0].id;

  const link = `${baseUrl()}#rid=${RID}&code=${CODE}`;
  $("link").textContent = `‚úÖ Demande cr√©√©e\nClient: ${parsed.client_name}\nLien demande: ${link}`;
  $("sendBox").style.display = "block";
  $("prescriberReplyBox").style.display = "block";
  renderProviders();
  await loadThread();
}

/* =========================
   SEND REQUEST (send-request edge function)
========================= */
async function sendToSelected(){
  if(!RID || !CODE){ alert("Cr√©e d‚Äôabord une demande."); return; }

  const checks = Array.from(document.querySelectorAll(".providerCheck:checked"));
  const emails = checks.map(c => (c.getAttribute("data-email")||"").trim().toLowerCase()).filter(Boolean);

  if(!emails.length){ alert("S√©lectionne au moins 1 prestataire."); return; }

  $("sendStatus").textContent = "Envoi automatique‚Ä¶";

  const custom = ($("customMessage").value || "").trim();

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/send-request`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      provider_emails: emails,
      custom_message: custom
    })
  });

  if(!res.ok){
    console.log("send-request failed:", res.status, data);
    $("sendStatus").textContent = "‚ùå Erreur\n" + JSON.stringify(data, null, 2);
    return;
  }

  $("sendStatus").textContent = "‚úÖ Envoy√©\n" + JSON.stringify(data, null, 2);
}

function copyThreadLink(){
  if(!RID || !CODE){ alert("Cr√©e d‚Äôabord une demande."); return; }
  const link = `${baseUrl()}#rid=${RID}&code=${CODE}`;
  navigator.clipboard.writeText(link);
  alert("Lien demande copi√©.");
}

/* =========================
   LOAD THREAD (get-thread)
   ‚úÖ Affiche messages + liens de t√©l√©chargement fichiers
========================= */
function renderMessageFiles(files){
  if(!Array.isArray(files) || !files.length) return "";
  return files.map(f => {
    const name = escHtml(f?.name || "fichier");
    const url = f?.url;
    if(!url) return `<div class="hint">üìé ${name} (lien indisponible)</div>`;
    return `<div><a class="file" href="${url}" target="_blank" rel="noopener">üìé T√©l√©charger : ${name}</a></div>`;
  }).join("");
}

async function loadThread(){
  if(!RID || !CODE) return;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/get-thread`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ request_id: RID, access_code: CODE })
  });

  if(!res.ok){
    console.log("get-thread failed:", res.status, data);
    const target = $("thread") || $("threadProvider");
    if(target) target.innerHTML = `<div class="hint">‚ùå Erreur chargement conversation</div>`;
    return;
  }

  // prescriber view
  if($("thread")){
    const el = $("thread");
    el.innerHTML = "";

    (data.responses || []).forEach(x=>{
      const isThem = !!x.responder_email; // prestataire
      el.innerHTML += `
        <div class="msg ${isThem ? "them":"you"}">
          <div class="hint">${new Date(x.created_at).toLocaleString("fr-FR")}</div>
          <strong>${isThem ? escHtml(x.responder_email || "Prestataire") : "Vous"}</strong><br>
          ${escHtml(x.message || "").replaceAll("\n","<br>")}
          ${renderMessageFiles(x.files)}
        </div>`;
    });
  }

  // provider view
  if($("threadProvider")){
    const el = $("threadProvider");
    el.innerHTML = "";

    (data.responses || []).forEach(x=>{
      const isYou = PROVIDER_EMAIL && (String(x.responder_email||"").toLowerCase() === PROVIDER_EMAIL);
      el.innerHTML += `
        <div class="msg ${isYou ? "you":"them"}">
          <div class="hint">${new Date(x.created_at).toLocaleString("fr-FR")}</div>
          <strong>${escHtml(x.responder_email || "MF Auto Sud")}</strong><br>
          ${escHtml(x.message || "").replaceAll("\n","<br>")}
          ${renderMessageFiles(x.files)}
        </div>`;
    });
  }

  // request info in provider mode
  if($("requestInfo") && data.request){
    const r = data.request;
    $("requestInfo").textContent =
      `Client: ${r.client_name || "-"}\nV√©hicule: ${r.vehicle || "-"}\nContact: ${r.contact_name || "-"}\nEmail: ${r.contact_email || "-"}\nTel: ${r.contact_phone || "-"}\nSIRET: ${r.siret || "-"}\nTVA: ${r.vat || "-"}\nAdresse: ${r.address || "-"}`;
  }
}

/* =========================
   SUBMIT RESPONSE - PROVIDER
   ‚úÖ author_role + notifications infinies
========================= */
async function submitProviderResponse(){
  const msg = ($("respMsg").value || "").trim();
  const filesInput = $("respFiles");
  const statusEl = $("respStatus");

  if(!RID || !CODE){
    statusEl.textContent = "‚ùå Lien invalide (rid/code manquants).";
    return;
  }
  if(!PROVIDER_EMAIL){
    statusEl.textContent = "‚ùå Lien prestataire incomplet (pe=...).";
    return;
  }

  statusEl.textContent = "Envoi en cours‚Ä¶";

  const files = [];
  for(const file of (filesInput.files || [])){
    const dataUrl = await readFileAsDataURL(file);
    files.push({ name: file.name, type: file.type || "application/octet-stream", dataUrl });
  }

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/submit-response`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,

      // ‚úÖ IMPORTANT pour ton Edge Function
      author_role: "provider",

      responder_name: "Prestataire",
      responder_email: PROVIDER_EMAIL,
      provider_email: PROVIDER_EMAIL,

      message: msg,
      files
    })
  });

  if(!res.ok){
    console.log("submit-response failed:", res.status, data);
    statusEl.textContent = "‚ùå Erreur\n" + JSON.stringify(data, null, 2);
    return;
  }

  statusEl.textContent = "‚úÖ R√©ponse envoy√©e";
  $("respMsg").value = "";
  $("respFiles").value = "";
  await loadThread();
}

/* =========================
   SUBMIT RESPONSE - PRESCRIBER
   ‚úÖ author_role + notifications √† tous les prestataires invit√©s
========================= */
async function submitPrescriberResponse(){
  const msg = ($("prescMsg").value || "").trim();
  const filesInput = $("prescFiles");
  const statusEl = $("prescStatus");

  if(!RID || !CODE){
    statusEl.textContent = "‚ùå Cr√©e d‚Äôabord une demande.";
    return;
  }

  statusEl.textContent = "Envoi en cours‚Ä¶";

  const files = [];
  for(const file of (filesInput.files || [])){
    const dataUrl = await readFileAsDataURL(file);
    files.push({ name: file.name, type: file.type || "application/octet-stream", dataUrl });
  }

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/submit-response`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,

      // ‚úÖ IMPORTANT pour ton Edge Function
      author_role: "prescriber",

      responder_name: "MF Auto Sud",
      // ‚úÖ vide = affichage "Vous" c√¥t√© UI
      responder_email: "",

      message: msg,
      files
    })
  });

  if(!res.ok){
    console.log("submit-response failed:", res.status, data);
    statusEl.textContent = "‚ùå Erreur\n" + JSON.stringify(data, null, 2);
    return;
  }

  statusEl.textContent = "‚úÖ R√©ponse envoy√©e";
  $("prescMsg").value = "";
  $("prescFiles").value = "";
  await loadThread();
}

/* =========================
   INIT (FIX)
   ‚úÖ Mode prestataire UNIQUEMENT si pe=...
   ‚úÖ Sinon rid+code = mode prescripteur (dossier)
========================= */
(function init(){
  const { rid, code, pe } = getHashParams();

  // Si on a rid+code => on est sur un dossier
  if(rid && code){
    RID = rid;
    CODE = code;

    // ‚úÖ Prestataire uniquement si pe est pr√©sent
    if(pe && pe.trim()){
      PROVIDER_EMAIL = decodeURIComponent(pe).trim().toLowerCase();
      $("prescriberUI").style.display = "none";
      $("providerUI").style.display = "block";
      loadThread();
      return;
    }

    // ‚úÖ Sinon: Prescripteur (dossier)
    PROVIDER_EMAIL = "";
    $("prescriberUI").style.display = "block";
    $("providerUI").style.display = "none";

    // Comme on est sur un dossier existant, on affiche les blocs utiles
    $("sendBox").style.display = "block";
    $("prescriberReplyBox").style.display = "block";
    renderProviders();
    loadThread();
    return;
  }

  // Racine: prescripteur (cr√©ation)
  $("prescriberUI").style.display = "block";
  $("providerUI").style.display = "none";
  renderProviders();
})();
</script>

</body>
</html>
