<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Plateforme prescripteur ‚Äì MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{font-family:Arial,sans-serif;background:#0b1220;color:#fff;padding:28px}
    h1{color:#4da3ff;margin:0 0 18px}
    .box{background:#111c34;padding:18px;border-radius:10px;margin-bottom:18px}
    label{display:block;margin-top:12px}
    input,textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:#0b1220;color:#fff}
    button{width:100%;padding:12px;margin-top:14px;background:#4da3ff;border:0;font-weight:700;cursor:pointer;border-radius:10px}
    #result{margin-top:12px;word-break:break-all}
    hr{margin:18px 0;opacity:.25}
    .pill{display:inline-block;background:#2563eb;color:#fff;padding:4px 10px;border-radius:20px;font-size:12px;margin-top:8px}
    .hint{opacity:.7;font-size:12px;margin-top:6px}
  </style>
</head>

<body>
  <h1>Plateforme prescripteur ‚Äì MF Auto Sud</h1>

  <div class="box">
    <h2>1Ô∏è‚É£ Configuration Supabase</h2>
    <label>Project URL</label>
    <input id="sbUrl" placeholder="(optionnel)"/>
    <label>Publishable key</label>
    <input id="sbKey" placeholder="(optionnel)"/>
    <button onclick="saveConfig()">Enregistrer</button>
    <div id="result"></div>
  </div>

  <div class="box">
    <h2>2Ô∏è‚É£ Cr√©er une demande</h2>

    <label>Nom du client</label>
    <input id="clientName">

    <label>V√©hicule</label>
    <input id="vehicle">

    <label>Email prescripteur</label>
    <input id="prescriberEmail">

    <label>Infos client (copier-coller)</label>
    <textarea id="pasteBlock" placeholder="Colle ici les infos (adresse, SIRET, TVA, contact)‚Ä¶" style="height:160px;"></textarea>
    <div class="hint">Astuce : colle le bloc tel quel. Le portail extrait automatiquement adresse / SIRET / TVA / contact.</div>

    <button onclick="createRequest()">Cr√©er la demande</button>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1YmhzamtzdGJycWx2bXlsb2J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDE1NzQsImV4cCI6MjA4NDk3NzU3NH0.tANS4zo9wvLsWJS48Hyw6thttQX0yhBjOKI1aY4FTCo";

/* =========================
   UTILS
========================= */
function getHashParams(){
  const p = new URLSearchParams(window.location.hash.replace("#",""));
  return { rid: p.get("rid"), code: p.get("code") };
}
function randomCode(){
  const a = crypto.getRandomValues(new Uint8Array(16));
  return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("");
}
function setResult(html, ok=true){
  const el = document.getElementById("result");
  if(!el) return;
  el.style.color = ok ? "#9dffb3" : "#ff9d9d";
  el.innerHTML = html;
}
function joinAddress(d){
  const line1 = d.address || "";
  const line2 = [d.postcode, d.city].filter(Boolean).join(" ");
  const line3 = d.country || "";
  return [line1, line2, line3].filter(Boolean).join("<br>");
}

/* =========================
   PARSE "COPIER-COLLER"
   (pas de th√©orie : √ßa extrait automatiquement ce qu'on peut)
========================= */
function parsePaste(text){
  const t = (text || "").replace(/\r/g, "").trim();
  const lines = t.split("\n").map(l => l.trim()).filter(Boolean);

  const out = {
    address: "",
    postcode: "",
    city: "",
    country: "",
    siret: "",
    vat: "",
    contact_name: "",
    contact_email: "",
    contact_phone: ""
  };

  // SIRET
  const siretMatch = t.match(/siret\s*[:\-]?\s*([0-9 ]{10,20})/i);
  if (siretMatch) out.siret = siretMatch[1].replace(/\s+/g, " ").trim();

  // TVA
  const vatMatch = t.match(/tva\s*[:\-]?\s*([A-Z]{2}\s*[0-9A-Z ]{5,})/i);
  if (vatMatch) out.vat = vatMatch[1].replace(/\s+/g, " ").trim();

  // Email
  const emailMatch = t.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
  if (emailMatch) out.contact_email = emailMatch[0];

  // T√©l√©phone FR
  const phoneMatch = t.match(/(\+33|0)\s*[1-9](?:[\s.\-]*\d{2}){4}/);
  if (phoneMatch) out.contact_phone = phoneMatch[0].replace(/\s+/g, " ").trim();

  // Nom contact : premi√®re ligne "probable nom" (2 mots min) sans chiffres/email
  const isNoise = (l) =>
    /siret|tva|client|adresse|contact|responsable|mandat/i.test(l) ||
    l.includes("@") ||
    /\d{2}/.test(l);

  const nameLine = lines.find(l => !isNoise(l) && l.split(" ").length >= 2);
  if (nameLine) out.contact_name = nameLine;

  // Adresse : une ligne avec num√©ro + rue/chemin/avenue/bd/route + (souvent) la suivante
  const addrIndex = lines.findIndex(l =>
    /\d+\s+/.test(l) && /(rue|chemin|avenue|bd|boulevard|route|impasse|allee|all√©e)/i.test(l)
  );
  if (addrIndex >= 0) {
    out.address = lines[addrIndex];
    // Ligne suivante potentiellement code postal + ville + pays
    const next = lines[addrIndex + 1] || "";
    const cpCity = next.match(/(\d{5})\s+(.+)/);
    if (cpCity) {
      out.postcode = cpCity[1];
      out.city = cpCity[2].replace(/\s+France$/i, "").trim();
      if (/France$/i.test(next)) out.country = "France";
    } else if (next) {
      // Si pas de CP, on la colle en compl√©ment d'adresse
      out.address = out.address + "\n" + next;
    }
  }

  // Country si on trouve "France"
  if (!out.country && /France/i.test(t)) out.country = "France";

  return out;
}

/* =========================
   MODE INTERLOCUTEUR
========================= */
const { rid, code } = getHashParams();

if (rid && code) {
  document.body.innerHTML = `<h1>Demande re√ßue</h1><p>Chargement‚Ä¶</p>`;

  fetch(`${SUPABASE_URL}/rest/v1/requests?select=*&id=eq.${rid}&access_code=eq.${code}`, {
    headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY }
  })
  .then(res => { if(!res.ok) throw new Error("HTTP "+res.status); return res.json(); })
  .then(rows => {
    if(!rows.length){
      document.body.innerHTML = `<h1>Acc√®s refus√©</h1><p>Demande invalide ou expir√©e.</p>`;
      return;
    }

    const d = rows[0];
    const addr = joinAddress(d);

    // bloc pro (sans undefined) - et sans tes 2 lignes interdites
    document.body.innerHTML = `
      <div style="max-width:900px">
        <h1 style="color:#4da3ff;margin:0">${d.client_name || "Client"}</h1>
        <div class="pill">Client</div>

        ${addr ? `<hr><p>üìç ${addr}</p>` : ""}

        ${(d.siret || d.vat) ? `
          <hr>
          <p>
            ${d.siret ? `üè¢ N¬∞ SIRET : ${d.siret}<br>` : ""}
            ${d.vat ? `üèõÔ∏è N¬∞ TVA : ${d.vat}` : ""}
          </p>
        ` : ""}

        ${(d.contact_name || d.contact_email || d.contact_phone) ? `
          <hr>
          <h2>Contact</h2>
          <p>
            ${d.contact_name ? `<strong>${d.contact_name}</strong><br>` : ""}
            ${d.contact_email ? `üìß ${d.contact_email}<br>` : ""}
            ${d.contact_phone ? `üìû ${d.contact_phone}` : ""}
          </p>
        ` : ""}

        <hr>

        <h2>Votre r√©ponse</h2>
        <label>Message</label>
        <textarea id="responseMessage" style="height:110px;"></textarea>

        <label>Documents (PDF, images, etc.)</label>
        <input type="file" id="responseFiles" multiple>

        <button id="sendResponse">Envoyer la r√©ponse</button>
        <p id="responseStatus"></p>
      </div>
    `;

    // envoi via Edge Function (email + upload + insert c√¥t√© serveur)
    document.getElementById("sendResponse").addEventListener("click", async () => {
      const status = document.getElementById("responseStatus");
      status.innerText = "Envoi en cours‚Ä¶";

      const message = document.getElementById("responseMessage").value || "";
      const filesInput = document.getElementById("responseFiles");

      const files = [];
      for (const file of filesInput.files) {
        const dataUrl = await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(file);
        });
        files.push({ name: file.name, type: file.type || "application/octet-stream", dataUrl });
      }

      const res = await fetch(`${SUPABASE_URL}/functions/v1/submit-response`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_ANON_KEY,
          Authorization: "Bearer " + SUPABASE_ANON_KEY
        },
        body: JSON.stringify({
          request_id: rid,
          access_code: code,
          responder_name: "Interlocuteur",
          responder_email: "",
          message,
          files
        })
      });

      if(!res.ok){
        const txt = await res.text();
        status.innerText = "‚ùå Erreur envoi (HTTP "+res.status+")";
        console.log("DETAIL submit-response:", txt);
        return;
      }

      status.innerText = "‚úÖ R√©ponse envoy√©e avec succ√®s";
    });
  })
  .catch(err => {
    document.body.innerHTML = `<h1>Erreur</h1><p>${err.message}</p>`;
  });

} else {
  /* =========================
     MODE PRESCRIPTEUR
  ========================= */
  window.saveConfig = function(){
    setResult("‚úÖ OK (h√©berg√© sur GitHub Pages).");
  };

  window.createRequest = async function(){
    const name = document.getElementById("clientName").value.trim();
    const vehicle = document.getElementById("vehicle").value.trim();
    const email = document.getElementById("prescriberEmail").value.trim();
    const pasted = document.getElementById("pasteBlock").value || "";
    const parsed = parsePaste(pasted);

    if(!name || !vehicle || !email){
      setResult("‚ùå Remplis Nom du client, V√©hicule, Email prescripteur.", false);
      return;
    }

    const access_code = randomCode();

    const payload = {
      prescriber_email: email,
      client_name: name,
      vehicle: vehicle,
      fin_type: "LLD",
      recipients: [email],
      access_code,
      status: "sent",

      // champs optionnels extraits du copier-coller
      address: parsed.address,
      postcode: parsed.postcode,
      city: parsed.city,
      country: parsed.country,
      siret: parsed.siret,
      vat: parsed.vat,
      contact_name: parsed.contact_name,
      contact_email: parsed.contact_email,
      contact_phone: parsed.contact_phone
    };

    const res = await fetch(`${SUPABASE_URL}/rest/v1/requests`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type": "application/json",
        Prefer: "return=representation"
      },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const txt = await res.text();
      setResult("‚ùå Erreur cr√©ation (HTTP "+res.status+")", false);
      console.log("DETAIL createRequest:", txt);
      return;
    }

    const rows = await res.json();
    const id = rows[0].id;

    const link = `${location.href.split("#")[0]}#rid=${id}&code=${access_code}`;
    setResult(`‚úÖ Lien g√©n√©r√© :<br><a href="${link}" target="_blank" style="color:#7cc0ff">${link}</a>`);
  };
}
</script>

</body>
</html>
