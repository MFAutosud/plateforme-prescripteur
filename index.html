<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Admin ‚Äì MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="./assets/logo-mfautosud.png">

  <style>
    :root{
      --bg:#0b1220; --panel:#111c34; --panel2:#0f1a32;
      --text:#ffffff; --muted:rgba(255,255,255,.75); --line:rgba(255,255,255,.10);
      --brand:#4da3ff; --brand2:#2563eb;
      --btn:#4da3ff; --btnText:#001; --btn2:#334155;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 10px 24px rgba(0,0,0,.22);
      --fieldBg: rgba(11,18,32,.85); --fieldBorder: rgba(255,255,255,.14); --fieldFocus: rgba(77,163,255,.55);
      --chipBg: rgba(77,163,255,.12); --chipBorder: rgba(77,163,255,.25); --chipText: #cfe6ff;
      --link: #7cc0ff;
      --rowBg: rgba(11,18,32,.60); --rowBorder: rgba(255,255,255,.08);
      --msgBg: rgba(11,18,32,.75); --cardBg: rgba(11,18,32,.65); --kvBg: rgba(17,28,52,.55);
      --topbarBg: rgba(17,28,52,.85); --topbarBorder: rgba(255,255,255,.08);
      --fileBg: #334155; --fileBorder: rgba(255,255,255,.10);
      --divider: rgba(255,255,255,.10);
    }

    [data-theme="light"]{
      --bg:#f6f8fc; --panel:#ffffff; --panel2:#ffffff;
      --text:#0b1220; --muted:rgba(15,23,42,.72); --line:rgba(15,23,42,.12);
      --brand:#2563eb; --brand2:#1d4ed8;
      --btn:#2563eb; --btnText:#ffffff; --btn2:#e2e8f0;
      --shadow: 0 10px 24px rgba(2,6,23,.08);
      --fieldBg: rgba(255,255,255,.95); --fieldBorder: rgba(15,23,42,.14); --fieldFocus: rgba(37,99,235,.45);
      --chipBg: rgba(37,99,235,.10); --chipBorder: rgba(37,99,235,.22); --chipText: rgba(15,23,42,.85);
      --link: #2563eb;
      --rowBg: rgba(2,6,23,.03); --rowBorder: rgba(2,6,23,.08);
      --msgBg: rgba(2,6,23,.03); --cardBg: rgba(2,6,23,.02); --kvBg: rgba(2,6,23,.03);
      --topbarBg: rgba(255,255,255,.85); --topbarBorder: rgba(2,6,23,.10);
      --fileBg: rgba(2,6,23,.06); --fileBorder: rgba(2,6,23,.10);
      --divider: rgba(2,6,23,.10);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial, sans-serif; color:var(--text); padding:24px;
      background:
        radial-gradient(1100px 460px at 10% -10%, rgba(77,163,255,.22), transparent 60%),
        radial-gradient(900px 380px at 90% 0%, rgba(37,99,235,.18), transparent 60%),
        var(--bg);
    }
    [data-theme="light"] body{
      background:
        radial-gradient(1100px 460px at 10% -10%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(900px 380px at 90% 0%, rgba(77,163,255,.08), transparent 60%),
        var(--bg);
    }

    .wrap{max-width:1100px;margin:0 auto}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-radius:16px;
      background: var(--topbarBg); border:1px solid var(--topbarBorder);
      backdrop-filter: blur(6px); margin-bottom:16px; box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0;}
    .brandLogo{
      width:44px;height:44px;border-radius:12px; background:var(--panel2); border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center; padding:6px; flex:0 0 auto;
    }
    .brandLogo img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .brandTitle h1{font-size:18px;margin:0;color:var(--brand);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .brandTitle .sub{margin:2px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .topbarRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .chip{
      font-size:12px; padding:6px 10px;border-radius:999px;
      background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--chipText);
      white-space:nowrap;
    }

    .box{
      background: linear-gradient(180deg, rgba(17,28,52,.95), rgba(15,26,50,.95));
      border:1px solid rgba(255,255,255,.08);
      padding:16px; border-radius:16px; margin-bottom:14px; box-shadow: var(--shadow);
    }
    [data-theme="light"] .box{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
      border:1px solid rgba(2,6,23,.10);
    }
    h2{margin:0 0 10px;font-size:16px}
    h3{margin:8px 0 8px;font-size:14px}
    label{display:block;margin-top:10px;font-size:13px;color:var(--muted)}
    input,textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--fieldBorder); background:var(--fieldBg); color:var(--text); outline:none;
    }
    input:focus,textarea:focus{border-color:var(--fieldFocus); box-shadow:0 0 0 4px rgba(77,163,255,.12)}
    [data-theme="light"] input:focus,[data-theme="light"] textarea:focus{box-shadow:0 0 0 4px rgba(37,99,235,.12)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    button{
      padding:10px 12px; border-radius:12px; border:0;
      background:var(--btn); color:var(--btnText); font-weight:800; cursor:pointer;
      transition:.12s transform ease, .12s opacity ease;
    }
    button:hover{transform: translateY(-1px)}
    button:active{transform: translateY(0px); opacity:.92}
    button.secondary{
      background:var(--btn2); color: var(--text); font-weight:700; border:1px solid var(--line);
    }
    [data-theme="light"] button.secondary{color:#0b1220;border:1px solid rgba(2,6,23,.10)}
    button.small{padding:8px 10px;border-radius:12px;margin-top:0}

    .hint{opacity:.86;font-size:12px;margin-top:8px;white-space:pre-wrap;line-height:1.35;color:var(--muted)}
    .divider{height:1px;background:var(--divider);margin:14px 0}

    .providerRow{
      display:flex;align-items:flex-start;gap:10px;
      padding:10px 10px;border-radius:14px;
      background:var(--rowBg);
      border:1px solid var(--rowBorder);
      margin:8px 0;
    }
    .providerRow .txt{flex:1; min-width:0}
    .providerRow .main{
      display:block; font-size:13px; font-weight:800; color:var(--text);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .providerRow .sub{
      display:block; margin-top:2px; font-size:12px; font-weight:600; color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .tag{
      display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px;
      border:1px solid var(--line); background:var(--rowBg); color:var(--text);
    }
    .tag.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10)}
    .tag.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)}
    .checkline{display:flex;align-items:center;gap:8px;margin-top:0;color:var(--muted)}
    .checkline input{width:auto}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="brandLogo">
        <img src="./assets/logo-mfautosud.png" alt="MF Auto Sud">
      </div>
      <div class="brandTitle">
        <h1>Admin ‚Äì MF Auto Sud</h1>
        <div class="sub">Gestion des prestataires ‚Ä¢ R√¥les ‚Ä¢ √âquipes (Chefs des ventes ‚Üí Vendeurs)</div>
      </div>
    </div>

    <div class="topbarRight">
      <div class="chip" id="modeChip">Mode : Admin</div>
      <button class="secondary" id="themeBtn" style="white-space:nowrap">üåô Mode sombre</button>
    </div>
  </div>

  <div class="box">
    <h2>Acc√®s Admin</h2>
    <div class="hint">
      ‚úÖ Ajoute ton token dans l‚ÄôURL : <b>?token=TON_TOKEN</b><br>
      Il sera m√©moris√© sur cet ordinateur.
    </div>

    <div class="grid2">
      <div>
        <label>Token admin</label>
        <input id="tokenInput" placeholder="Colle ton token ici">
      </div>
      <div>
        <label>Actions</label>
        <div class="row" style="margin-top:10px">
          <button class="secondary" id="saveTokenBtn">Enregistrer le token</button>
          <button class="secondary" id="clearTokenBtn">Supprimer le token</button>
          <button id="refreshAllBtn">Rafra√Æchir</button>
        </div>
      </div>
    </div>

    <div id="authStatus" class="hint"></div>
  </div>

  <div class="box">
    <h2>Prestataires & r√¥les</h2>

    <h3>Ajouter / mettre √† jour</h3>
    <div class="grid2">
      <div>
        <label>E-mail</label>
        <input id="adminEmail" placeholder="chef@concession.com">
      </div>
      <div>
        <label>Nom (optionnel)</label>
        <input id="adminName" placeholder="Concession X">
      </div>
    </div>

    <div class="row">
      <label class="checkline"><input type="checkbox" id="adminIsManager"> Chef des ventes</label>
      <label class="checkline"><input type="checkbox" id="adminIsVendor"> Vendeur</label>
      <button id="adminSave">Enregistrer</button>
      <button class="secondary" id="adminRefresh">Rafra√Æchir</button>
    </div>

    <div class="divider"></div>

    <h3>Liste</h3>
    <div id="adminList" class="hint">‚Äî</div>
  </div>

  <div class="box">
    <h2>Chefs des ventes ‚Üí Vendeurs (gestion √©quipe)</h2>
    <div class="hint">Tu vois toutes les √©quipes. Tu peux ajouter/supprimer des vendeurs.</div>
    <div id="teamBox" class="hint">‚Äî</div>
  </div>

</div>

<script>
/* ========================= CONFIG ========================= */
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1YmhzamtzdGJycWx2bXlsb2J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDE1NzQsImV4cCI6MjA4NDk3NzU3NH0.tANS4zo9wvLsWJS48Hyw6thttQX0yhBjOKI1aY4FTCo";

const THEME_KEY = "mfautosud_theme";
const ADMIN_TOKEN_KEY = "mfautosud_admin_token";

/* ========================= THEME ========================= */
function applyTheme(theme){
  const t = (theme === "light") ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem(THEME_KEY, t);
  const btn = document.getElementById("themeBtn");
  if(btn) btn.textContent = (t === "light") ? "‚òÄÔ∏è Mode clair" : "üåô Mode sombre";
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(cur === "dark" ? "light" : "dark");
}
(function(){
  const saved = localStorage.getItem(THEME_KEY) || "dark";
  applyTheme(saved);
  document.getElementById("themeBtn").addEventListener("click", toggleTheme);
})();

/* ========================= UTILS ========================= */
function $(id){ return document.getElementById(id); }
function escHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function normalizeEmail(email){ return (email || "").trim().toLowerCase(); }
function emailLooksValid(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||"").trim().toLowerCase()); }

function getTokenFromUrl(){
  const url = new URL(window.location.href);
  const qs = url.searchParams;
  const hs = new URLSearchParams(url.hash.replace("#",""));
  return (qs.get("token") || hs.get("token") || "").trim();
}
function getToken(){
  return (localStorage.getItem(ADMIN_TOKEN_KEY) || "").trim();
}
function setToken(t){
  localStorage.setItem(ADMIN_TOKEN_KEY, String(t||"").trim());
}
function clearToken(){
  localStorage.removeItem(ADMIN_TOKEN_KEY);
}

async function fetchJson(url, options){
  const res = await fetch(url, options);
  let data = null;
  try { data = await res.json(); } catch {}
  return { res, data };
}

function authHeaders(){
  const tok = getToken();
  return {
    apikey: SUPABASE_ANON_KEY,
    Authorization: "Bearer " + SUPABASE_ANON_KEY,
    "Content-Type": "application/json",
    "x-admin-token": tok
  };
}

function setAuthStatus(ok, msg){
  const el = $("authStatus");
  if(!el) return;
  el.innerHTML = ok
    ? `<span class="tag ok">Token OK</span> ${escHtml(msg||"")}`
    : `<span class="tag bad">Token requis / invalide</span> ${escHtml(msg||"")}`;
}

/* ========================= ADMIN API ========================= */
async function adminProviderList(){
  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/admin-provider-list`, {
    method:"POST",
    headers: authHeaders(),
    body: JSON.stringify({})
  });

  const box = $("adminList");
  if(!box) return;

  if(!res.ok){
    console.log("admin-provider-list:", res.status, data);
    box.innerHTML = `‚ùå admin-provider-list indisponible ou token invalide.`;
    setAuthStatus(false, "V√©rifie le token.");
    return;
  }

  setAuthStatus(true, "Acc√®s admin actif.");

  const rows = Array.isArray(data?.providers) ? data.providers : [];
  if(!rows.length){
    box.innerHTML = `<div class="hint">Aucun prestataire en base.</div>`;
    return;
  }

  box.innerHTML = rows.map(r=>{
    const email = escHtml(r.provider_email || "");
    const name = escHtml(r.provider_name || "");
    const tags = [
      r.is_sales_manager ? "‚úÖ Chef des ventes" : "",
      r.is_vendor ? "‚úÖ Vendeur" : ""
    ].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî";

    return `
      <div class="providerRow">
        <div class="txt">
          <span class="main">${email}</span>
          ${name ? `<span class="sub">${name}</span>` : ""}
          <span class="sub">${escHtml(tags)}</span>
        </div>
      </div>
    `;
  }).join("");
}

async function adminProviderUpsert(){
  const email = normalizeEmail($("adminEmail").value);
  const name = ($("adminName").value || "").trim();
  const is_sales_manager = !!$("adminIsManager").checked;
  const is_vendor = !!$("adminIsVendor").checked;

  if(!emailLooksValid(email)){ alert("Email invalide"); return; }

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/admin-provider-upsert`, {
    method:"POST",
    headers: authHeaders(),
    body: JSON.stringify({ provider_email: email, provider_name: name || null, is_sales_manager, is_vendor })
  });

  if(!res.ok){
    console.log("admin-provider-upsert:", res.status, data);
    alert("Erreur admin-provider-upsert (voir console)");
    setAuthStatus(false, "Token invalide ?");
    return;
  }

  $("adminEmail").value = "";
  $("adminName").value = "";
  $("adminIsManager").checked = false;
  $("adminIsVendor").checked = false;

  await refreshAll();
}

async function adminManagerVendorList(){
  const box = $("teamBox");
  if(!box) return;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/admin-manager-vendor-list`, {
    method:"POST",
    headers: authHeaders(),
    body: JSON.stringify({})
  });

  if(!res.ok){
    console.log("admin-manager-vendor-list:", res.status, data);
    box.innerHTML = `‚ùå admin-manager-vendor-list indisponible (ou token invalide).`;
    setAuthStatus(false, "V√©rifie le token.");
    return;
  }

  setAuthStatus(true, "Acc√®s admin actif.");

  const managers = Array.isArray(data?.managers) ? data.managers : [];
  if(!managers.length){
    box.innerHTML = `<div class="hint">Aucun chef des ventes trouv√©.</div>`;
    return;
  }

  box.innerHTML = managers.map(m=>{
    const me = String(m.manager_email || "").trim().toLowerCase();
    const mn = String(m.manager_name || "").trim();
    const vendors = Array.isArray(m.vendors) ? m.vendors : [];

    const vendorHtml = vendors.length
      ? vendors.map(v=>{
          const ve = String(v.vendor_email || "").trim().toLowerCase();
          const vn = String(v.vendor_name || "").trim();
          const label = vn ? `${vn} ‚Äî ${ve}` : ve;

          return `
            <div class="providerRow">
              <div class="txt">
                <span class="main">${escHtml(label)}</span>
                <span class="sub">${escHtml(ve)}</span>
              </div>
              <button class="small secondary" data-del="${escHtml(me)}||${escHtml(ve)}">Suppr.</button>
            </div>
          `;
        }).join("")
      : `<div class="hint">Aucun vendeur rattach√©.</div>`;

    return `
      <div class="box" style="margin-top:12px">
        <h3>${escHtml(mn ? `${mn} ‚Äî ${me}` : me)}</h3>
        ${vendorHtml}
        <div class="divider"></div>

        <div class="grid2">
          <div>
            <label>Ajouter vendeur (email)</label>
            <input data-add-email="${escHtml(me)}" placeholder="vendeur@domaine.com">
          </div>
          <div>
            <label>Nom (optionnel)</label>
            <input data-add-name="${escHtml(me)}" placeholder="Jean Dupont">
          </div>
        </div>

        <div class="row">
          <button class="secondary" data-add-btn="${escHtml(me)}">Ajouter</button>
        </div>
      </div>
    `;
  }).join("");

  // bind delete
  box.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const raw = String(btn.getAttribute("data-del")||"");
      const [manager_email, vendor_email] = raw.split("||").map(x=>String(x||"").trim().toLowerCase());
      if(!manager_email || !vendor_email) return;
      if(!confirm("Supprimer ce vendeur de l‚Äô√©quipe ?")) return;

      const { res: r2, data: d2 } = await fetchJson(`${SUPABASE_URL}/functions/v1/admin-vendor-delete`, {
        method:"POST",
        headers: authHeaders(),
        body: JSON.stringify({ manager_email, vendor_email })
      });

      if(!r2.ok){
        console.log("admin-vendor-delete:", r2.status, d2);
        alert("Erreur suppression (console)");
        return;
      }

      await adminManagerVendorList();
    });
  });

  // bind add
  box.querySelectorAll("button[data-add-btn]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const manager_email = String(btn.getAttribute("data-add-btn")||"").trim().toLowerCase();
      const emailInput = box.querySelector(`input[data-add-email="${CSS.escape(manager_email)}"]`);
      const nameInput  = box.querySelector(`input[data-add-name="${CSS.escape(manager_email)}"]`);

      const vendor_email = normalizeEmail(emailInput ? emailInput.value : "");
      const vendor_name  = String(nameInput ? nameInput.value : "").trim();

      if(!emailLooksValid(vendor_email)){ alert("Email vendeur invalide"); return; }

      const { res: r2, data: d2 } = await fetchJson(`${SUPABASE_URL}/functions/v1/admin-vendor-upsert`, {
        method:"POST",
        headers: authHeaders(),
        body: JSON.stringify({ manager_email, vendor_email, vendor_name: vendor_name || null })
      });

      if(!r2.ok){
        console.log("admin-vendor-upsert:", r2.status, d2);
        alert("Erreur ajout vendeur (console)");
        return;
      }

      if(emailInput) emailInput.value = "";
      if(nameInput) nameInput.value = "";
      await adminManagerVendorList();
    });
  });
}

async function refreshAll(){
  const tok = getToken();
  $("tokenInput").value = tok || "";
  if(!tok){
    setAuthStatus(false, "Ajoute ?token=... ou colle le token ci-dessus.");
    $("adminList").innerHTML = `<div class="hint">Token requis.</div>`;
    $("teamBox").innerHTML = `<div class="hint">Token requis.</div>`;
    return;
  }

  await adminProviderList();
  await adminManagerVendorList();
}

/* ========================= INIT ========================= */
(function init(){
  // r√©cup token URL si pr√©sent
  const tUrl = getTokenFromUrl();
  if(tUrl){
    setToken(tUrl);
  }

  $("saveTokenBtn").addEventListener("click", async ()=>{
    const t = String($("tokenInput").value || "").trim();
    if(!t){ alert("Colle un token."); return; }
    setToken(t);
    await refreshAll();
  });

  $("clearTokenBtn").addEventListener("click", async ()=>{
    clearToken();
    await refreshAll();
  });

  $("refreshAllBtn").addEventListener("click", refreshAll);

  $("adminSave").addEventListener("click", adminProviderUpsert);
  $("adminRefresh").addEventListener("click", refreshAll);

  refreshAll();
})();
</script>

</body>
</html>
