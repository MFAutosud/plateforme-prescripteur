<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Plateforme prescripteur â€“ MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#0b1220; color:#fff; padding:40px; }
    h1 { color:#4da3ff; }
    .box{ background:#111c34; padding:20px; border-radius:10px; margin-bottom:20px; }
    label{ display:block; margin-top:12px; }
    input{ width:100%; padding:10px; margin-top:6px; }
    button{ width:100%; padding:12px; margin-top:14px; background:#4da3ff; border:0; font-weight:700; cursor:pointer; }
    #result{ margin-top:12px; word-break:break-all; }
  </style>
</head>

<body>
  <h1>Plateforme prescripteur â€“ MF Auto Sud</h1>

  <div class="box">
    <h2>1ï¸âƒ£ Configuration Supabase</h2>
    <label>Project URL</label>
    <input id="sbUrl" placeholder="https://xxxx.supabase.co">
    <label>Publishable key</label>
    <input id="sbKey" placeholder="sb_publishable_...">
    <button onclick="saveConfig()">Enregistrer</button>
    <div id="result"></div>
  </div>

  <div class="box">
    <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #ffffff; max-width: 700px;">

  <h2 style="margin-bottom:4px;">
    ${d.client_name || ""}
  </h2>

  <span style="display:inline-block;background:#2563eb;color:#fff;padding:4px 10px;border-radius:20px;font-size:12px;">
    Client
  </span>

  ${(d.address || d.postcode || d.city || d.country) ? `
    <hr style="margin:20px 0;opacity:0.3;">
    <p>
      ğŸ“ ${[d.address, [d.postcode, d.city].filter(Boolean).join(" "), d.country].filter(Boolean).join("<br>")}
    </p>
  ` : ""}

  ${(d.siret || d.vat) ? `
    <hr style="margin:20px 0;opacity:0.3;">
    <p>
      ${d.siret ? `ğŸ¢ NÂ° SIRET : ${d.siret}<br>` : ""}
      ${d.vat ? `ğŸ›ï¸ NÂ° TVA : ${d.vat}` : ""}
    </p>
  ` : ""}

  ${(d.contact_name || d.contact_email || d.contact_phone) ? `
    <hr style="margin:20px 0;opacity:0.3;">
    <h3>Contact</h3>
    <p>
      ${d.contact_name ? `<strong>${d.contact_name}</strong><br>` : ""}
      ${d.contact_email ? `ğŸ“§ ${d.contact_email}<br>` : ""}
      ${d.contact_phone ? `ğŸ“ ${d.contact_phone}` : ""}
    </p>
  ` : ""}

</div>

/* =========================
   MODE INTERLOCUTEUR
========================= */
const { rid, code } = getHashParams();

if (rid && code) {
  console.log("MODE INTERLOCUTEUR", rid, code);

  document.body.innerHTML = `
    <h1>Demande reÃ§ue</h1>
    <p>Chargement de la demande en coursâ€¦</p>
  `;

  // Charger la demande
  fetch(`${SUPABASE_URL}/rest/v1/requests?select=*&id=eq.${rid}&access_code=eq.${code}`, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY
    }
  })
  .then(res => {
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  })
  .then(rows => {
    if (!rows.length) {
      document.body.innerHTML = `<h1>AccÃ¨s refusÃ©</h1><p>Cette demande est invalide ou expirÃ©e.</p>`;
      return;
    }

    const d = rows[0];

    document.body.innerHTML = `
     <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #ffffff; max-width: 700px;">

  <h2 style="margin-bottom:4px;">
    ${d.client_name}
  </h2>

  <span style="display:inline-block;background:#2563eb;color:#fff;padding:4px 10px;border-radius:20px;font-size:12px;">
    Client
  </span>

  <hr style="margin:20px 0;opacity:0.3;">

  <p>
    ğŸ“ ${d.address}
  </p>

  <hr style="margin:20px 0;opacity:0.3;">

  <p>
    ğŸ¢ NÂ° SIRET : ${d.siret}<br>
    ğŸ›ï¸ NÂ° TVA : ${d.vat}
  </p>

  <hr style="margin:20px 0;opacity:0.3;">

  <h3>Contact</h3>

  <p>
    <strong>${d.contact_name}</strong><br>
    ğŸ“§ ${d.contact_email}<br>
    ğŸ“ ${d.contact_phone}
  </p>

</div>

      <h2>Votre rÃ©ponse</h2>

      <label>Message</label><br>
      <textarea id="responseMessage" style="width:100%;height:110px;"></textarea>

      <br><br>

      <label>Documents (PDF, images, etc.)</label><br>
      <input type="file" id="responseFiles" multiple>

      <br><br>

      <button id="sendResponse">Envoyer la rÃ©ponse</button>
      <p id="responseStatus"></p>
    `;

    // Envoi via Edge Function submit-response (upload + insert cÃ´tÃ© serveur)
    document.getElementById("sendResponse").addEventListener("click", async () => {
      const message = document.getElementById("responseMessage").value || "";
      const filesInput = document.getElementById("responseFiles");
      const status = document.getElementById("responseStatus");

      status.innerText = "Envoi en coursâ€¦";

      // Convertir fichiers en base64 (dataUrl)
      const files = [];
      for (const file of filesInput.files) {
        const dataUrl = await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(file);
        });

        files.push({
          name: file.name,
          type: file.type || "application/octet-stream",
          dataUrl
        });
      }

      const res = await fetch(`${SUPABASE_URL}/functions/v1/submit-response`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_ANON_KEY,
          Authorization: "Bearer " + SUPABASE_ANON_KEY
        },
        body: JSON.stringify({
          request_id: rid,
          access_code: code,
          responder_name: "Interlocuteur",
          responder_email: "",
          message,
          files
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        status.innerText = "âŒ Erreur envoi (HTTP " + res.status + ")";
        console.log("DETAIL ERREUR submit-response:", txt);
        return;
      }

      status.innerText = "âœ… RÃ©ponse envoyÃ©e avec succÃ¨s";
    });
  })
  .catch(err => {
    document.body.innerHTML = `<h1>Erreur</h1><p>${err.message}</p>`;
  });

} else {
  /* =========================
     MODE PRESCRIPTEUR
  ========================= */

  // Bouton "Enregistrer" : purement informatif (tu peux garder tes champs)
  window.saveConfig = function() {
    setResult("âœ… Configuration OK (clÃ© anon intÃ©grÃ©e).");
  };

  // CrÃ©ation de demande via REST (requests)
  window.createRequest = async function() {
    const name = document.getElementById("clientName").value.trim();
    const vehicle = document.getElementById("vehicle").value.trim();
    const email = document.getElementById("prescriberEmail").value.trim();

    if (!name || !vehicle || !email) {
      setResult("âŒ Remplis Nom du client, VÃ©hicule, Email prescripteur.", false);
      return;
    }

    const access_code = randomCode();

    const payload = {
      prescriber_email: email,
      client_name: name,
      vehicle: vehicle,
      fin_type: "LLD",
      recipients: [email],
      access_code: access_code,
      status: "sent"
    };

    const res = await fetch(`${SUPABASE_URL}/rest/v1/requests`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type": "application/json",
        Prefer: "return=representation"
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const txt = await res.text();
      setResult("âŒ Erreur crÃ©ation demande (HTTP " + res.status + ")", false);
      console.log("DETAIL ERREUR createRequest:", txt);
      return;
    }

    const rows = await res.json();
    const id = rows[0].id;

    const link = `${location.href.split("#")[0]}#rid=${id}&code=${access_code}`;
    setResult(`âœ… Lien gÃ©nÃ©rÃ© :<br><a href="${link}" target="_blank" style="color:#7cc0ff">${link}</a>`, true);
  };
}
</script>

</body>
</html>
