<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Plateforme prescripteur ‚Äì MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ‚úÖ Favicon (corrig√© : chemin relatif s√ªr GitHub Pages) -->
  <link rel="icon" type="image/png" href="./assets/logo-mfautosud.png">

  <style>
    :root{
      --bg:#0b1220;
      --panel:#111c34;
      --panel2:#0f1a32;
      --text:#ffffff;
      --muted:rgba(255,255,255,.75);
      --line:rgba(255,255,255,.10);
      --brand:#4da3ff;
      --brand2:#2563eb;
      --btn:#4da3ff;
      --btnText:#001;
      --btn2:#334155;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 24px rgba(0,0,0,.22);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial, sans-serif;
      background:
        radial-gradient(1100px 460px at 10% -10%, rgba(77,163,255,.22), transparent 60%),
        radial-gradient(900px 380px at 90% 0%, rgba(37,99,235,.18), transparent 60%),
        var(--bg);
      color:var(--text);
      padding:24px;
    }
    .wrap{max-width:1100px;margin:0 auto}

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-radius:16px;
      background: rgba(17,28,52,.85);
      border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
      margin-bottom:16px;
      box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0;}
    .brand img{
      width:44px;height:44px;border-radius:12px;
      background:#0b1220;border:1px solid rgba(255,255,255,.12);
      object-fit:contain;
      padding:6px;
      display:block;
    }
    .brandTitle{min-width:0}
    .brandTitle h1{
      font-size:18px;margin:0;color:var(--brand);letter-spacing:.2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brandTitle .sub{
      margin:2px 0 0;font-size:12px;opacity:.75;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .chip{
      font-size:12px;
      padding:6px 10px;border-radius:999px;
      background:rgba(77,163,255,.12);
      border:1px solid rgba(77,163,255,.25);
      color:#cfe6ff;
      white-space:nowrap;
    }

    /* Layout */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}

    .box{
      background: linear-gradient(180deg, rgba(17,28,52,.95), rgba(15,26,50,.95));
      border:1px solid rgba(255,255,255,.08);
      padding:16px;
      border-radius:16px;
      margin-bottom:14px;
      box-shadow: var(--shadow);
    }

    h2{margin:0 0 10px;font-size:16px}
    h3{margin:8px 0 8px;font-size:14px;opacity:.95}

    label{display:block;margin-top:10px;font-size:13px;opacity:.9}
    input,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,18,32,.85);
      color:#fff;
      outline:none;
    }
    input:focus,textarea:focus{
      border-color:rgba(77,163,255,.55);
      box-shadow:0 0 0 4px rgba(77,163,255,.12)
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    button{
      padding:10px 12px;
      border-radius:12px;
      border:0;
      background:var(--btn);
      color:var(--btnText);
      font-weight:800;
      cursor:pointer;
      transition:.12s transform ease, .12s opacity ease;
    }
    button:hover{transform: translateY(-1px)}
    button:active{transform: translateY(0px); opacity:.92}
    button.secondary{background:var(--btn2);color:#fff;font-weight:700}
    button.small{padding:8px 10px;border-radius:12px;margin-top:0}

    .hint{
      opacity:.78;font-size:12px;margin-top:8px;
      white-space:pre-wrap;line-height:1.35
    }

    .divider{height:1px;background:rgba(255,255,255,.10);margin:14px 0}

    /* Rows */
    .providerRow{
      display:flex;align-items:center;gap:10px;
      padding:10px 10px;border-radius:14px;
      background:rgba(11,18,32,.6);
      border:1px solid rgba(255,255,255,.08);
      margin:8px 0;
    }
    .providerRow span{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* Messages */
    .msg{
      background:rgba(11,18,32,.75);
      padding:12px;
      border-radius:14px;
      margin-top:10px;
      border:1px solid rgba(255,255,255,.08)
    }
    .msg.you{border-left:4px solid var(--brand)}
    .msg.them{border-left:4px solid var(--ok)}
    .msgHead{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .msgMeta{font-size:12px;opacity:.7}
    .msgWho{font-weight:800}
    .msgBody{margin-top:8px;line-height:1.45;font-size:13px}
    .file{
      display:inline-block;
      margin-top:8px;
      padding:8px 10px;
      border-radius:12px;
      background:#334155;
      color:#fff;
      text-decoration:none;
      border:1px solid rgba(255,255,255,.10);
    }
    a{color:#7cc0ff}

    /* Request card */
    .card{
      background:rgba(11,18,32,.65);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:14px;
    }
    .gridInfo{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.gridInfo{grid-template-columns:1fr}}
    .kv{
      padding:10px 10px;border-radius:14px;
      background:rgba(17,28,52,.55);
      border:1px solid rgba(255,255,255,.08);
    }
    .kv b{display:block;font-size:12px;opacity:.8;margin-bottom:4px}
    .kv div{font-size:13px;word-break:break-word}

    .legal{
      margin-top:14px;
      font-size:11px;
      opacity:.70;
      line-height:1.35;
      border-top:1px solid rgba(255,255,255,.10);
      padding-top:10px;
    }

    .pill{
      display:inline-block;
      padding:3px 10px;
      border-radius:999px;
      font-size:12px;
      background:rgba(77,163,255,.14);
      border:1px solid rgba(77,163,255,.28);
      color:#d9ecff;
      margin-left:8px;
      white-space:nowrap;
    }

    /* Small status pills */
    .tag{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,18,32,.55);
      color:#fff;
    }
    .tag.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10)}
    .tag.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <!-- ‚úÖ Logo corrig√© : chemin relatif s√ªr GitHub Pages -->
      <img src="./assets/logo-mfautosud.png" alt="MF Auto Sud">
      <div class="brandTitle">
        <h1>Plateforme prescripteur ‚Äì MF Auto Sud</h1>
        <div class="sub">Demandes ‚Ä¢ R√©ponses ‚Ä¢ Pi√®ces jointes ‚Ä¢ Transferts ‚Ä¢ Relances automatiques</div>
      </div>
    </div>
    <div class="chip" id="modeChip">Mode : Prescripteur</div>
  </div>

  <!-- =========================
       PRESCRIPTEUR UI
  ========================= -->
  <div id="prescriberUI">

    <div class="box">
      <h2>1) Cr√©er une demande</h2>

      <div class="grid2">
        <div>
          <label>V√©hicule</label>
          <input id="vehicle" placeholder="Ex. : Ford Puma LLD 25 mois ‚Äì 30 000 km ‚Äì entretien inclus">
        </div>

        <div>
          <label>Lien de la demande</label>
          <div class="row" style="margin-top:10px">
            <button class="secondary" onclick="copyThreadLink()">Copier le lien</button>
          </div>
          <div class="hint">Disponible apr√®s cr√©ation (rid + code).</div>
        </div>
      </div>

      <label>Bloc client (copier-coller) ‚Äî 1 ≥·µâ ligne = nom du client</label>
      <textarea id="pasteBlock" style="height:180px" placeholder="Colle ici le bloc complet‚Ä¶"></textarea>

      <div class="hint">
La 1 ≥·µâ ligne devient automatiquement le nom du client.
Lignes supprim√©es automatiquement :
- ¬´ Obtenir un lien √† envoyer au client pour signer un mandat de pr√©l√®vement SEPA ¬ª
- ¬´ Responsable MF Autosud ¬ª
- variantes ¬´ pr√©l√®vement / prelevement ¬ª
      </div>

      <div class="row">
        <button onclick="createRequest()">Cr√©er la demande</button>
      </div>

      <div id="link" class="hint"></div>

      <div class="legal">
        <b>Information (RGPD)</b> : les donn√©es transmises sont utilis√©es uniquement dans le cadre du traitement de la demande et de la r√©ponse commerciale.
        Vous pouvez demander l‚Äôacc√®s, la rectification ou la suppression en √©crivant √†
        <a href="mailto:courtier@mfautosud.fr">courtier@mfautosud.fr</a>.
      </div>
    </div>

    <div class="box" id="sendBox" style="display:none;">
      <h2>2) Envoyer √† des prestataires</h2>

      <div class="row">
        <button class="secondary" onclick="checkAll()">Tout cocher</button>
        <button class="secondary" onclick="uncheckAll()">Tout d√©cocher</button>
        <button class="secondary" onclick="exportProviders()">Exporter</button>
        <button class="secondary" onclick="clearProviders()">Tout effacer</button>
      </div>

      <div id="providersList" style="margin-top:10px"></div>

      <div class="divider"></div>

      <h3>Ajouter / importer</h3>

      <div class="grid2">
        <div>
          <label>E-mail du prestataire</label>
          <input id="providerEmail" placeholder="exemple@domaine.com">
        </div>
        <div>
          <label>Nom (optionnel)</label>
          <input id="providerName" placeholder="Ex. : Groupe Grim">
        </div>
      </div>

      <div class="row">
        <button onclick="addProvider()">Ajouter au r√©pertoire</button>
      </div>

      <label>Importer une liste (1 par ligne : Nom &lt;email&gt; ou email)</label>
      <textarea id="importArea" style="height:110px" placeholder="Ex. : Nom <email@domaine.com>"></textarea>
      <div class="row">
        <button class="secondary" onclick="importProviders()">Importer</button>
      </div>

      <label>Message (optionnel) inclus dans l‚Äôe-mail</label>
      <textarea id="customMessage" style="height:90px" placeholder="Texte optionnel‚Ä¶"></textarea>

      <div class="row">
        <button onclick="sendToSelected()">‚úÖ Envoyer automatiquement</button>
        <button class="secondary" onclick="copyThreadLink()">Copier le lien</button>
      </div>

      <div id="sendStatus" class="hint"></div>
    </div>

    <div class="box">
      <h2>3) Conversation</h2>
      <div class="row">
        <button class="secondary" onclick="loadThread()">üîÑ Rafra√Æchir</button>
        <button class="secondary" onclick="copyThreadLink()">Copier le lien</button>
      </div>
      <div id="thread" style="margin-top:10px"></div>
    </div>

    <div class="box" id="prescriberReplyBox" style="display:none;">
      <h2>4) R√©pondre (MF Auto Sud)</h2>

      <label>Message</label>
      <textarea id="prescMsg" style="height:120px" placeholder="Votre message‚Ä¶"></textarea>

      <label>Documents (PDF, images‚Ä¶)</label>
      <input type="file" id="prescFiles" multiple>

      <div class="hint">
La r√©ponse :
- s‚Äôenregistre dans l‚Äôhistorique,
- notifie par e-mail TOUS les prestataires d√©j√† invit√©s sur cette demande.
      </div>

      <button onclick="submitPrescriberResponse()">Envoyer la r√©ponse</button>
      <div id="prescStatus" class="hint"></div>
    </div>
  </div>

  <!-- =========================
       PRESTATAIRE UI
  ========================= -->
  <div id="providerUI" style="display:none;">
    <div class="box">
      <h2>Demande re√ßue <span class="pill">Prestataire</span></h2>
      <div id="requestInfo" class="hint">Chargement‚Ä¶</div>
    </div>

    <div class="box">
      <h2>Conversation</h2>
      <div class="row">
        <button class="secondary" onclick="loadThread()">üîÑ Rafra√Æchir</button>
      </div>
      <div id="threadProvider" style="margin-top:10px"></div>
    </div>

    <div class="box">
      <h2>R√©pertoire vendeurs (Chef des ventes)</h2>

      <div class="hint" id="vendorRoleHint">
        Chargement du r√©pertoire vendeurs‚Ä¶
      </div>

      <div class="row">
        <button class="secondary" onclick="vendorCheckAll(true)">Tout cocher</button>
        <button class="secondary" onclick="vendorCheckAll(false)">Tout d√©cocher</button>
        <button class="secondary" onclick="vendorExport()">Exporter</button>
        <button class="secondary" onclick="vendorClear()">Tout effacer</button>
      </div>

      <div id="vendorList" style="margin-top:10px"></div>

      <div class="divider"></div>

      <h3>Ajouter / importer des vendeurs</h3>

      <div class="grid2">
        <div>
          <label>E-mail vendeur</label>
          <input id="vendorEmail" placeholder="vendeur@domaine.com">
        </div>
        <div>
          <label>Nom (optionnel)</label>
          <input id="vendorName" placeholder="Ex. : Jean Dupont">
        </div>
      </div>

      <div class="row">
        <!-- ‚úÖ bouton -> vendorAddDb (DB Supabase) -->
        <button onclick="vendorAddDb()">Ajouter</button>
      </div>

      <label>Importer une liste (1 par ligne : Nom &lt;email&gt; ou email)</label>
      <textarea id="vendorImport" style="height:110px" placeholder="Ex. : Jean Dupont <vendeur@domaine.com>"></textarea>
      <div class="row">
        <button class="secondary" onclick="vendorImportList()">Importer</button>
      </div>
    </div>

    <div class="box">
      <h2>Transf√©rer la demande</h2>
      <div class="hint">
Le nouveau destinataire re√ßoit un e-mail + MF Auto Sud est notifi√©. L‚Äôhistorique conserve l‚Äôinformation.
      </div>

      <label>Note (optionnel)</label>
      <textarea id="forwardNote" style="height:90px" placeholder="Ex. : Peux-tu traiter ce dossier ? Merci !"></textarea>

      <div class="divider"></div>

      <h3>Transf√©rer √† un vendeur (un seul)</h3>
      <label>E-mail du nouveau destinataire</label>
      <input id="forwardTo" placeholder="vendeur@domaine.com">
      <div class="row">
        <button class="secondary" onclick="forwardRequest()">Transf√©rer</button>
      </div>

      <div class="divider"></div>

      <h3>Transf√©rer √† plusieurs vendeurs (r√©pertoire)</h3>
      <div class="row">
        <button class="secondary" onclick="forwardToSelectedVendors()">Transf√©rer aux vendeurs coch√©s</button>
      </div>

      <div id="forwardStatus" class="hint"></div>
    </div>

    <div class="box">
      <h2>R√©pondre</h2>

      <label>Votre message</label>
      <textarea id="respMsg" style="height:120px" placeholder="Texte d‚Äôaccompagnement‚Ä¶"></textarea>

      <label>Documents (PDF, images‚Ä¶)</label>
      <input type="file" id="respFiles" multiple>

      <button onclick="submitProviderResponse()">Envoyer la r√©ponse</button>
      <div id="respStatus" class="hint"></div>
    </div>
  </div>

</div>

<script>
/* =========================
   CONFIG
========================= */
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1YmhzamtzdGJycWx2bXlsb2J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDE1NzQsImV4cCI6MjA4NDk3NzU3NH0.tANS4zo9wvLsWJS48Hyw6thttQX0yhBjOKI1aY4FTCo";
const PRESCRIBER_EMAIL = "courtier@mfautosud.fr";
const PROVIDERS_KEY = "mfautosud_providers_v2";

/* =========================
   STATE
========================= */
let RID = "";
let CODE = "";
let PROVIDER_EMAIL = "";

/* =========================
   UTILS
========================= */
function $(id){ return document.getElementById(id); }

function setModeChip(txt){
  const c = $("modeChip");
  if(c) c.textContent = "Mode : " + txt;
}

function getHashParams(){
  const p = new URLSearchParams(location.hash.replace("#",""));
  return { rid: p.get("rid"), code: p.get("code"), pe: p.get("pe") };
}

function randomCode(){
  const a = crypto.getRandomValues(new Uint8Array(16));
  return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function fetchJson(url, options){
  const res = await fetch(url, options);
  let data = null;
  try { data = await res.json(); } catch {}
  return { res, data };
}

async function callEdge(fnName, body){
  return await fetchJson(`${SUPABASE_URL}/functions/v1/${fnName}`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body || {})
  });
}

function requireProviderEmail(){
  if(!PROVIDER_EMAIL){
    alert("Ouvre via un lien prestataire complet (avec pe=...) pour utiliser le r√©pertoire vendeurs.");
    return false;
  }
  return true;
}

async function readFileAsDataURL(file){
  return await new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function baseUrl(){
  return location.href.split("#")[0];
}

function escHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function normalizeEmail(email){ return (email || "").trim().toLowerCase(); }
function emailLooksValid(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||"").trim().toLowerCase()); }

/* =========================
   PARSE COPY-PASTE
========================= */
function parsePaste(text){
  const t = (text || "").replace(/\r/g, "").trim();
  const lines = t.split("\n").map(l => l.trim()).filter(Boolean);

  const out = {
    client_name: "",
    address: "",
    postcode: "",
    city: "",
    country: "",
    siret: "",
    vat: "",
    contact_name: "",
    contact_email: "",
    contact_phone: ""
  };

  if (!lines.length) return out;
  out.client_name = lines[0];

  const isTitleLine = (l) => ["client","contacts","contact"].includes(l.toLowerCase());
  const isUselessLine = (l) => {
    const x = l.toLowerCase();
    return (
      x.includes("obtenir un lien") ||
      x.includes("mandat de pr√©l√®vement sepa") ||
      x.includes("mandat de prelevement sepa") ||
      x.includes("prelevement sepa") ||
      x.includes("pr√©l√®vement sepa") ||
      x.includes("responsable mf autosud")
    );
  };
  const looksLikeShortCode = (l) => /^[a-z]{1,3}$/i.test(l.trim());

  for (let i = 1; i < lines.length; i++) {
    const l = lines[i];
    if (isTitleLine(l) || isUselessLine(l) || looksLikeShortCode(l)) continue;

    if (!out.address && /\b\d{5}\b/.test(l)) {
      out.address = l;
      const m = l.match(/\b(\d{5})\b\s+(.+)$/);
      if (m) {
        out.postcode = m[1];
        let rest = m[2].trim();
        if (/france$/i.test(rest)) {
          out.country = "France";
          rest = rest.replace(/france$/i, "").trim();
        }
        out.city = rest;
      }
      continue;
    }

    const siretMatch = l.match(/siret\s*[:\-]?\s*([0-9 ]{10,30})/i);
    if (siretMatch) { out.siret = siretMatch[1].replace(/\s+/g, ""); continue; }

    const vatMatch = l.match(/tva\s*[:\-]?\s*([A-Z]{2}\s*[0-9A-Z ]{6,})/i);
    if (vatMatch) { out.vat = vatMatch[1].replace(/\s+/g, ""); continue; }

    const emailMatch = l.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    if (emailMatch && !out.contact_email) { out.contact_email = emailMatch[0].toLowerCase(); continue; }

    const phoneMatch = l.match(/(\+33|0)\s*[1-9](?:[\s.\-]*\d{2}){4}/);
    if (phoneMatch && !out.contact_phone) { out.contact_phone = phoneMatch[0].replace(/[\s.\-]/g,""); continue; }

    if (!out.contact_name) {
      if (!/\d/.test(l) && !l.includes("@") && l.length <= 45) {
        const w = l.split(/\s+/).filter(Boolean);
        if (w.length >= 2 && w.length <= 5) out.contact_name = l;
      }
    }
  }

  if (!out.country && /france/i.test(t)) out.country = "France";
  return out;
}

/* =========================
   PROVIDERS (localStorage c√¥t√© MF Auto Sud)
========================= */
function loadProviders(){
  try{
    const raw = localStorage.getItem(PROVIDERS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveProviders(arr){ localStorage.setItem(PROVIDERS_KEY, JSON.stringify(arr)); }

function extractEmailAndName(line){
  const s = (line || "").trim();
  if(!s) return null;

  const m = s.match(/^(.*)<\s*([^>]+)\s*>$/);
  if(m){
    const name = m[1].replace(/^['"]|['"]$/g,"").trim();
    const email = (m[2] || "").trim().toLowerCase();
    return { name, email };
  }
  const only = s.replace(/^['"]|['"]$/g,"").trim().toLowerCase();
  if(emailLooksValid(only)) return { name:"", email: only };

  const em = s.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
  if(em) return { name:"", email: em[0].toLowerCase() };

  return null;
}

function renderProviders(){
  const listEl = $("providersList");
  if(!listEl) return;

  const providers = loadProviders();
  if(!providers.length){
    listEl.innerHTML = `<div class="hint">Aucun prestataire enregistr√©.</div>`;
    return;
  }

  listEl.innerHTML = providers.map((p, idx) => {
    const label = p.name ? `${p.name} ‚Äî ${p.email}` : p.email;
    return `
      <div class="providerRow">
        <input type="checkbox" class="providerCheck" data-email="${escHtml(p.email)}">
        <span title="${escHtml(label)}">${escHtml(label)}</span>
        <button class="small secondary" onclick="removeProvider(${idx})">Suppr.</button>
      </div>
    `;
  }).join("");
}

function checkAll(){ document.querySelectorAll(".providerCheck").forEach(c=>c.checked=true); }
function uncheckAll(){ document.querySelectorAll(".providerCheck").forEach(c=>c.checked=false); }

function addProvider(){
  const email = normalizeEmail($("providerEmail").value);
  const name = ($("providerName").value || "").trim();
  if(!emailLooksValid(email)){ alert("E-mail invalide."); return; }

  const providers = loadProviders();
  if(providers.some(p => normalizeEmail(p.email) === email)){ alert("D√©j√† enregistr√©."); return; }

  providers.push({ name, email });
  saveProviders(providers);
  $("providerEmail").value = "";
  $("providerName").value = "";
  renderProviders();
}

function removeProvider(index){
  const providers = loadProviders();
  providers.splice(index, 1);
  saveProviders(providers);
  renderProviders();
}

function importProviders(){
  const raw = ($("importArea").value || "").replace(/\r/g,"").trim();
  if(!raw){ alert("Colle une liste."); return; }

  const lines = raw.split("\n").map(x=>x.trim()).filter(Boolean);
  const providers = loadProviders();
  const existing = new Set(providers.map(p => normalizeEmail(p.email)));

  let added=0, ignored=0;
  for(const line of lines){
    const parsed = extractEmailAndName(line);
    if(!parsed || !emailLooksValid(parsed.email)){ ignored++; continue; }
    if(existing.has(parsed.email)){ ignored++; continue; }
    providers.push({ name: parsed.name || "", email: parsed.email });
    existing.add(parsed.email);
    added++;
  }

  saveProviders(providers);
  renderProviders();
  alert(`Import termin√© : +${added} ajout√©s / ${ignored} ignor√©s`);
}

async function exportProviders(){
  const providers = loadProviders();
  const lines = providers.map(p => p.name ? `${p.name} <${p.email}>` : p.email).join("\n");
  await navigator.clipboard.writeText(lines || "");
  alert("Liste copi√©e dans le presse-papiers.");
}

function clearProviders(){
  if(!confirm("Supprimer tous les prestataires enregistr√©s sur cet ordinateur ?")) return;
  saveProviders([]);
  renderProviders();
}

/* =========================
   CREATE REQUEST
========================= */
async function createRequest(){
  const vehicle = $("vehicle").value.trim();
  const paste = ($("pasteBlock").value || "").trim();

  if(!vehicle || !paste){
    alert("V√©hicule + bloc client (copier-coller) sont obligatoires.");
    return;
  }

  const parsed = parsePaste(paste);
  if(!parsed.client_name){
    alert("Impossible de lire le nom du client (1 ≥·µâ ligne).");
    return;
  }

  RID = "";
  CODE = randomCode();

  const payload = {
    status: "draft",
    prescriber_email: PRESCRIBER_EMAIL,
    client_name: parsed.client_name,
    vehicle: vehicle,
    fin_type: "LLD",
    recipients: [PRESCRIBER_EMAIL],
    access_code: CODE,

    address: parsed.address || null,
    postcode: parsed.postcode || null,
    city: parsed.city || null,
    country: parsed.country || null,
    siret: parsed.siret || null,
    vat: parsed.vat || null,
    contact_name: parsed.contact_name || null,
    contact_email: parsed.contact_email || null,
    contact_phone: parsed.contact_phone || null
  };

  const { res, data } = await fetchJson(`${SUPABASE_URL}/rest/v1/requests`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    console.log("createRequest failed:", res.status, data);
    alert("Erreur cr√©ation demande (voir console).");
    return;
  }

  RID = data[0].id;

  const link = `${baseUrl()}#rid=${RID}&code=${CODE}`;
  $("link").textContent = `‚úÖ Demande cr√©√©e\nClient : ${parsed.client_name}\nLien : ${link}`;
  $("sendBox").style.display = "block";
  $("prescriberReplyBox").style.display = "block";
  renderProviders();
  await loadThread();
}

/* =========================
   SEND (send-request)
========================= */
async function sendToSelected(){
  if(!RID || !CODE){ alert("Cr√©e d‚Äôabord une demande."); return; }

  const checks = Array.from(document.querySelectorAll(".providerCheck:checked"));
  const emails = checks.map(c => (c.getAttribute("data-email")||"").trim().toLowerCase()).filter(Boolean);
  if(!emails.length){ alert("S√©lectionne au moins 1 prestataire."); return; }

  $("sendStatus").textContent = "Envoi automatique‚Ä¶";
  const custom = ($("customMessage").value || "").trim();

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/send-request`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      provider_emails: emails,
      custom_message: custom
    })
  });

  if(!res.ok){
    console.log("send-request failed:", res.status, data);
    $("sendStatus").textContent = "‚ùå Erreur\n" + JSON.stringify(data, null, 2);
    return;
  }

  $("sendStatus").textContent = "‚úÖ Envoy√©\n" + JSON.stringify(data, null, 2);
}

function copyThreadLink(){
  if(!RID || !CODE){ alert("Cr√©e d‚Äôabord une demande."); return; }
  const link = `${baseUrl()}#rid=${RID}&code=${CODE}`;
  navigator.clipboard.writeText(link);
  alert("Lien copi√©.");
}

/* =========================
   THREAD (get-thread)
========================= */
function renderMessageFiles(files){
  if(!Array.isArray(files) || !files.length) return "";
  return files.map(f => {
    const name = escHtml(f?.name || "fichier");
    const url = f?.url;
    if(!url) return `<div class="hint">üìé ${name} (lien indisponible)</div>`;
    return `<div><a class="file" href="${url}" target="_blank" rel="noopener">üìé T√©l√©charger : ${name}</a></div>`;
  }).join("");
}

async function loadThread(){
  if(!RID || !CODE) return;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/get-thread`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ request_id: RID, access_code: CODE })
  });

  if(!res.ok){
    console.log("get-thread failed:", res.status, data);
    const target = $("thread") || $("threadProvider");
    if(target) target.innerHTML = `<div class="hint">‚ùå Erreur chargement conversation</div>`;
    return;
  }

  if($("thread")){
    const el = $("thread");
    el.innerHTML = "";
    (data.responses || []).forEach(x=>{
      const isThem = !!x.responder_email;
      el.innerHTML += `
        <div class="msg ${isThem ? "them":"you"}">
          <div class="msgHead">
            <div class="msgWho">${isThem ? escHtml(x.responder_email || "Prestataire") : "Vous"}</div>
            <div class="msgMeta">${new Date(x.created_at).toLocaleString("fr-FR")}</div>
          </div>
          <div class="msgBody">
            ${escHtml(x.message || "").replaceAll("\n","<br>")}
            ${renderMessageFiles(x.files)}
          </div>
        </div>`;
    });
  }

  if($("threadProvider")){
    const el = $("threadProvider");
    el.innerHTML = "";
    (data.responses || []).forEach(x=>{
      const isYou = PROVIDER_EMAIL && (String(x.responder_email||"").toLowerCase() === PROVIDER_EMAIL);
      el.innerHTML += `
        <div class="msg ${isYou ? "you":"them"}">
          <div class="msgHead">
            <div class="msgWho">${escHtml(x.responder_email || "MF Auto Sud")}</div>
            <div class="msgMeta">${new Date(x.created_at).toLocaleString("fr-FR")}</div>
          </div>
          <div class="msgBody">
            ${escHtml(x.message || "").replaceAll("\n","<br>")}
            ${renderMessageFiles(x.files)}
          </div>
        </div>`;
    });
  }

  if($("requestInfo") && data.request){
    const r = data.request;
    $("requestInfo").innerHTML = `
      <div class="card">
        <div class="gridInfo">
          <div class="kv"><b>Client</b><div>${escHtml(r.client_name || "-")}</div></div>
          <div class="kv"><b>V√©hicule</b><div>${escHtml(r.vehicle || "-")}</div></div>
          <div class="kv"><b>Contact</b><div>${escHtml(r.contact_name || "-")}</div></div>
          <div class="kv"><b>E-mail</b><div>${escHtml(r.contact_email || "-")}</div></div>
          <div class="kv"><b>T√©l√©phone</b><div>${escHtml(r.contact_phone || "-")}</div></div>
          <div class="kv"><b>SIRET</b><div>${escHtml(r.siret || "-")}</div></div>
          <div class="kv"><b>TVA</b><div>${escHtml(r.vat || "-")}</div></div>
          <div class="kv"><b>Adresse</b><div>${escHtml(r.address || "-")}</div></div>
        </div>
        <div class="legal">
          <b>Information (RGPD)</b> : les donn√©es transmises sont utilis√©es uniquement dans le cadre du traitement de la demande et de la r√©ponse commerciale.
          Pour toute demande d‚Äôacc√®s/suppression : <a href="mailto:${PRESCRIBER_EMAIL}">${PRESCRIBER_EMAIL}</a>.
        </div>
      </div>
    `;
  }
}

/* =========================
   VENDORS DIRECTORY (DB via Supabase Edge Functions)
   vendor-list / vendor-upsert / vendor-delete
   ‚úÖ Seul le Chef des ventes peut g√©rer
========================= */
function vendorEmailValid(e){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||"").trim().toLowerCase());
}

let VENDOR_IS_MANAGER = false;

function setVendorRoleHint(html){
  const el = $("vendorRoleHint");
  if(el) el.innerHTML = html;
}

async function vendorFetchList(){
  const el = $("vendorList");
  if(!el) return;

  if(!RID || !CODE || !PROVIDER_EMAIL){
    el.innerHTML = `<div class="hint">‚ö†Ô∏è Acc√®s vendeurs indisponible (lien invalide).</div>`;
    setVendorRoleHint(`‚ö†Ô∏è Lien incomplet (rid/code/pe).`);
    return;
  }

  el.innerHTML = `<div class="hint">Chargement du r√©pertoire vendeurs‚Ä¶</div>`;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-list`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      provider_email: PROVIDER_EMAIL,
      request_id: RID,
      access_code: CODE
    })
  });

  if(!res.ok){
    console.log("vendor-list error:", res.status, data);
    el.innerHTML = `<div class="hint">‚ùå Erreur chargement vendeurs (${res.status}).</div>`;
    setVendorRoleHint(`‚ùå Erreur chargement du r√¥le (vendor-list).`);
    return;
  }

  VENDOR_IS_MANAGER = (data && data.is_sales_manager === true);

  if(!VENDOR_IS_MANAGER){
    setVendorRoleHint(`‚ÑπÔ∏è Votre e-mail n‚Äôest pas qualifi√© <b>Chef des ventes</b>. Vous ne pouvez pas g√©rer le r√©pertoire vendeurs.`);
    el.innerHTML = `<div class="hint">R√©pertoire non disponible pour votre profil.</div>`;
    disableVendorControls(true);
    return;
  }

  disableVendorControls(false);
  setVendorRoleHint(`<span class="tag ok">Chef des ventes</span> Vous pouvez ajouter / supprimer des vendeurs et les cocher pour transf√©rer.`);

  const vendors = Array.isArray(data.vendors) ? data.vendors : [];
  if(!vendors.length){
    el.innerHTML = `<div class="hint">Aucun vendeur enregistr√©.</div>`;
    return;
  }

  el.innerHTML = vendors.map(v => {
    const ve = String(v.vendor_email || "").trim().toLowerCase();
    const vn = String(v.vendor_name || "").trim();
    const label = vn ? `${vn} ‚Äî ${ve}` : ve;

    return `
      <div class="providerRow">
        <input type="checkbox" class="vendorCheck" data-email="${escHtml(ve)}">
        <span title="${escHtml(label)}">${escHtml(label)}</span>
        <button class="small secondary" onclick="vendorDeleteDb('${escHtml(ve)}')">Suppr.</button>
      </div>
    `;
  }).join("");
}

function disableVendorControls(disabled){
  ["vendorEmail","vendorName","vendorImport","forwardTo","forwardNote"].forEach(id=>{
    const el = $(id);
    if(el) el.disabled = !!disabled;
  });
  // On d√©sactive aussi les boutons d'action
  document.querySelectorAll("#providerUI button").forEach(b=>{
    const txt = (b.textContent || "").toLowerCase();
    // laisse "Rafra√Æchir" thread OK
    if(txt.includes("rafra√Æchir")) return;
    if(txt.includes("r√©ponse") || txt.includes("envoyer la r√©ponse")) return;
    // Les actions vendeurs + transferts se d√©sactivent si pas manager
    if(
      txt.includes("tout cocher") ||
      txt.includes("tout d√©cocher") ||
      txt.includes("exporter") ||
      txt.includes("tout effacer") ||
      txt.includes("ajouter") ||
      txt.includes("importer") ||
      txt.includes("transf√©rer aux vendeurs") ||
      txt === "transf√©rer"
    ){
      b.disabled = !!disabled;
      b.style.opacity = disabled ? ".55" : "1";
      b.style.cursor = disabled ? "not-allowed" : "pointer";
    }
  });
}

async function vendorAddDb(){
  if(!VENDOR_IS_MANAGER){
    alert("Action r√©serv√©e au Chef des ventes.");
    return;
  }
  const email = ( $("vendorEmail").value || "" ).trim().toLowerCase();
  const name = ( $("vendorName").value || "" ).trim();

  if(!vendorEmailValid(email)){
    alert("E-mail vendeur invalide.");
    return;
  }
  if(!RID || !CODE || !PROVIDER_EMAIL){
    alert("Lien invalide.");
    return;
  }

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-upsert`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      provider_email: PROVIDER_EMAIL,
      vendor_email: email,
      vendor_name: name,
      request_id: RID,
      access_code: CODE
    })
  });

  if(!res.ok){
    console.log("vendor-upsert error:", res.status, data);
    alert("Erreur ajout vendeur.");
    return;
  }

  $("vendorEmail").value = "";
  $("vendorName").value = "";
  await vendorFetchList();
}

async function vendorDeleteDb(vendorEmail){
  if(!VENDOR_IS_MANAGER){
    alert("Action r√©serv√©e au Chef des ventes.");
    return;
  }
  if(!confirm("Supprimer ce vendeur ?")) return;

  const email = String(vendorEmail || "").trim().toLowerCase();
  if(!email) return;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-delete`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      provider_email: PROVIDER_EMAIL,
      vendor_email: email,
      request_id: RID,
      access_code: CODE
    })
  });

  if(!res.ok){
    console.log("vendor-delete error:", res.status, data);
    alert("Erreur suppression vendeur.");
    return;
  }

  await vendorFetchList();
}

function vendorCheckAll(on){
  document.querySelectorAll(".vendorCheck").forEach(c => c.checked = !!on);
}

async function vendorImportList(){
  if(!VENDOR_IS_MANAGER){
    alert("Action r√©serv√©e au Chef des ventes.");
    return;
  }
  const raw = ($("vendorImport").value || "").replace(/\r/g,"").trim();
  if(!raw){ alert("Colle une liste."); return; }

  const lines = raw.split("\n").map(x=>x.trim()).filter(Boolean);

  let added = 0, ignored = 0;
  for(const line of lines){
    const p = vendorExtractLine(line);
    if(!p || !emailLooksValid(p.email)){ ignored++; continue; }

    const { res } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-upsert`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        provider_email: PROVIDER_EMAIL,
        vendor_email: p.email,
        vendor_name: p.name || "",
        request_id: RID,
        access_code: CODE
      })
    });

    if(res.ok) added++; else ignored++;
  }

  $("vendorImport").value = "";
  await vendorFetchList();
  alert(`Import termin√© : +${added} ajout√©s / ${ignored} ignor√©s`);
}

async function vendorExport(){
  if(!VENDOR_IS_MANAGER){
    alert("Action r√©serv√©e au Chef des ventes.");
    return;
  }
  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-list`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      provider_email: PROVIDER_EMAIL,
      request_id: RID,
      access_code: CODE
    })
  });
  if(!res.ok){
    alert("Erreur export vendeurs (voir console).");
    console.log("vendor-list error:", data);
    return;
  }

  const vendors = Array.isArray(data.vendors) ? data.vendors : [];
  const lines = vendors.map(v => {
    const email = String(v.vendor_email || "");
    const name = String(v.vendor_name || "").trim();
    return name ? `${name} <${email}>` : email;
  }).join("\n");

  await navigator.clipboard.writeText(lines || "");
  alert("R√©pertoire vendeurs copi√© dans le presse-papiers.");
}

async function vendorClear(){
  if(!VENDOR_IS_MANAGER){
    alert("Action r√©serv√©e au Chef des ventes.");
    return;
  }
  if(!confirm("Supprimer tout le r√©pertoire vendeurs (en base) ?")) return;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-list`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      provider_email: PROVIDER_EMAIL,
      request_id: RID,
      access_code: CODE
    })
  });

  if(!res.ok){
    alert("Erreur chargement vendeurs (voir console).");
    console.log("vendor-list error:", data);
    return;
  }

  const vendors = Array.isArray(data.vendors) ? data.vendors : [];
  for(const v of vendors){
    const ve = String(v.vendor_email || "").toLowerCase();
    await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-delete`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        provider_email: PROVIDER_EMAIL,
        vendor_email: ve,
        request_id: RID,
        access_code: CODE
      })
    });
  }

  await vendorFetchList();
}

function vendorExtractLine(line){
  const s = (line || "").trim();
  if(!s) return null;

  const m = s.match(/^(.*)<\s*([^>]+)\s*>$/);
  if(m){
    const name = m[1].replace(/^['"]|['"]$/g,"").trim();
    const email = (m[2] || "").trim().toLowerCase();
    return { name, email };
  }

  const only = s.replace(/^['"]|['"]$/g,"").trim().toLowerCase();
  if(emailLooksValid(only)) return { name:"", email: only };

  const em = s.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
  if(em) return { name:"", email: em[0].toLowerCase() };

  return null;
}

/* =========================
   TRANSFER (forward-request)
========================= */
async function forwardToSelectedVendors(){
  const statusEl = $("forwardStatus");
  if(!statusEl) return;

  if(!VENDOR_IS_MANAGER){
    statusEl.textContent = "‚ùå Action r√©serv√©e au Chef des ventes.";
    return;
  }
  if(!RID || !CODE){
    statusEl.textContent = "‚ùå Lien invalide (rid/code).";
    return;
  }
  if(!PROVIDER_EMAIL){
    statusEl.textContent = "‚ùå Lien prestataire incomplet (pe=...).";
    return;
  }

  const note = ($("forwardNote").value || "").trim();
  const checks = Array.from(document.querySelectorAll(".vendorCheck:checked"));
  const emails = checks.map(c => (c.getAttribute("data-email")||"").trim().toLowerCase()).filter(Boolean);

  if(!emails.length){
    statusEl.textContent = "‚ùå Coche au moins 1 vendeur dans le r√©pertoire.";
    return;
  }

  statusEl.textContent = "Transfert en cours‚Ä¶";

  const results = { ok: 0, fail: 0 };

  for(const to_email of emails){
    const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/forward-request`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        request_id: RID,
        access_code: CODE,
        from_email: PROVIDER_EMAIL,
        to_email,
        note
      })
    });

    if(!res.ok){
      console.log("forward-request failed:", res.status, data);
      results.fail++;
    } else {
      results.ok++;
    }
  }

  statusEl.textContent =
    `‚úÖ Transferts termin√©s.\nOK : ${results.ok} / Erreurs : ${results.fail}` +
    (results.fail ? `\nD√©tails : console.` : "");

  $("forwardNote").value = "";
}

async function forwardRequest(){
  const statusEl = $("forwardStatus");
  const toEmail = normalizeEmail($("forwardTo").value);
  const note = ($("forwardNote").value || "").trim();

  if(!VENDOR_IS_MANAGER){
    statusEl.textContent = "‚ùå Action r√©serv√©e au Chef des ventes.";
    return;
  }
  if(!RID || !CODE){
    statusEl.textContent = "‚ùå Lien invalide (rid/code).";
    return;
  }
  if(!PROVIDER_EMAIL){
    statusEl.textContent = "‚ùå Lien prestataire incomplet (pe=...).";
    return;
  }
  if(!emailLooksValid(toEmail)){
    statusEl.textContent = "‚ùå E-mail invalide.";
    return;
  }
  if(toEmail === PROVIDER_EMAIL){
    statusEl.textContent = "‚ùå E-mail identique : choisis un autre destinataire.";
    return;
  }

  statusEl.textContent = "Transfert en cours‚Ä¶";

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/forward-request`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      from_email: PROVIDER_EMAIL,
      to_email: toEmail,
      note
    })
  });

  if(!res.ok){
    console.log("forward-request failed:", res.status, data);
    statusEl.textContent = "‚ùå Erreur\n" + JSON.stringify(data, null, 2);
    return;
  }

  statusEl.textContent = "‚úÖ Transfert effectu√©.\nLe nouveau destinataire + MF Auto Sud ont re√ßu un e-mail.";
  $("forwardTo").value = "";
}

/* =========================
   RESPONSES (submit-response)
========================= */
async function submitProviderResponse(){
  const msg = ($("respMsg").value || "").trim();
  const filesInput = $("respFiles");
  const statusEl = $("respStatus");

  if(!RID || !CODE){
    statusEl.textContent = "‚ùå Lien invalide (rid/code manquants).";
    return;
  }
  if(!PROVIDER_EMAIL){
    statusEl.textContent = "‚ùå Lien prestataire incomplet (pe=...).";
    return;
  }

  statusEl.textContent = "Envoi en cours‚Ä¶";

  const files = [];
  for(const file of (filesInput.files || [])){
    const dataUrl = await readFileAsDataURL(file);
    files.push({ name: file.name, type: file.type || "application/octet-stream", dataUrl });
  }

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/submit-response`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      author_role: "provider",
      responder_name: "Prestataire",
      responder_email: PROVIDER_EMAIL,
      provider_email: PROVIDER_EMAIL,
      message: msg,
      files
    })
  });

  if(!res.ok){
    console.log("submit-response failed:", res.status, data);
    statusEl.textContent = "‚ùå Erreur\n" + JSON.stringify(data, null, 2);
    return;
  }

  statusEl.textContent = "‚úÖ R√©ponse envoy√©e";
  $("respMsg").value = "";
  $("respFiles").value = "";
  await loadThread();
}

async function submitPrescriberResponse(){
  const msg = ($("prescMsg").value || "").trim();
  const filesInput = $("prescFiles");
  const statusEl = $("prescStatus");

  if(!RID || !CODE){
    statusEl.textContent = "‚ùå Ouvre ou cr√©e une demande d‚Äôabord.";
    return;
  }

  statusEl.textContent = "Envoi en cours‚Ä¶";

  const files = [];
  for(const file of (filesInput.files || [])){
    const dataUrl = await readFileAsDataURL(file);
    files.push({ name: file.name, type: file.type || "application/octet-stream", dataUrl });
  }

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/submit-response`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      author_role: "prescriber",
      responder_name: "MF Auto Sud",
      responder_email: "",
      message: msg,
      files
    })
  });

  if(!res.ok){
    console.log("submit-response failed:", res.status, data);
    statusEl.textContent = "‚ùå Erreur\n" + JSON.stringify(data, null, 2);
    return;
  }

  statusEl.textContent = "‚úÖ R√©ponse envoy√©e";
  $("prescMsg").value = "";
  $("prescFiles").value = "";
  await loadThread();
}

/* =========================
   INIT (async)
========================= */
(async function init(){
  const { rid, code, pe } = getHashParams();

  if(rid && code){
    RID = rid;
    CODE = code;

    // Provider mode only if pe exists
    if(pe && pe.trim()){
      PROVIDER_EMAIL = decodeURIComponent(pe).trim().toLowerCase();
      $("prescriberUI").style.display = "none";
      $("providerUI").style.display = "block";
      setModeChip("Prestataire");

      await vendorFetchList();  // ‚úÖ charge r√¥le + r√©pertoire
      await loadThread();
      return;
    }

    // Prescriber view for existing request
    PROVIDER_EMAIL = "";
    $("prescriberUI").style.display = "block";
    $("providerUI").style.display = "none";
    setModeChip("Prescripteur (dossier)");

    $("sendBox").style.display = "block";
    $("prescriberReplyBox").style.display = "block";
    renderProviders();
    await loadThread();
    return;
  }

  // Root prescriber
  $("prescriberUI").style.display = "block";
  $("providerUI").style.display = "none";
  setModeChip("Prescripteur");
  renderProviders();
})();
</script>

</body>
</html>
