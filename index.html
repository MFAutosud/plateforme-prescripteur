// supabase/functions/get-thread/index.ts
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
const BUCKET = "responses-files";

const admin = createClient(SUPABASE_URL, SERVICE_ROLE_KEY);

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

function json(status: number, data: unknown) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { ...corsHeaders, "Content-Type": "application/json" },
  });
}

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") return new Response("ok", { headers: corsHeaders });
  if (req.method !== "POST") return json(405, { error: "Method Not Allowed" });

  try {
    const payload = await req.json();
    const request_id = String(payload.request_id || "").trim();
    const access_code = String(payload.access_code || "").trim();

    if (!request_id || !access_code) return json(400, { error: "request_id + access_code requis" });

    const { data: request, error: reqErr } = await admin
      .from("requests")
      .select("*")
      .eq("id", request_id)
      .single();

    if (reqErr || !request) return json(404, { error: "Demande introuvable" });
    if (String(request.access_code) !== access_code) return json(401, { error: "Accès refusé" });

    const { data: responses, error: respErr } = await admin
      .from("responses")
      .select("id, request_id, responder_name, responder_email, message, files, created_at")
      .eq("request_id", request_id)
      .order("created_at", { ascending: true });

    if (respErr) return json(400, { error: "Lecture responses échouée", detail: respErr.message });

    // Signed URLs for files
    const outResponses = [];
    for (const r of responses || []) {
      const files = Array.isArray(r.files) ? r.files : [];
      const signedFiles = [];

      for (const f of files) {
        const path = String(f?.path || "");
        const name = String(f?.name || "fichier");
        if (!path) continue;

        const { data, error } = await admin.storage.from(BUCKET).createSignedUrl(path, 60 * 60 * 24); // 24h
        if (error || !data?.signedUrl) continue;

        signedFiles.push({ name, url: data.signedUrl });
      }

      outResponses.push({
        ...r,
        files: signedFiles,
      });
    }

    return json(200, { request, responses: outResponses });
  } catch (e) {
    return json(500, { error: String(e) });
  }
});
