<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Plateforme Prescripteur ‚Äì MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="./assets/logo-mfautosud.png">
  <style>
    :root{
      --bg:#0b1220; --panel:#111c34; --panel2:#0f1a32;
      --text:#ffffff; --muted:rgba(255,255,255,.75); --line:rgba(255,255,255,.10);
      --brand:#4da3ff; --btn:#4da3ff; --btnText:#001; --btn2:#334155;
      --shadow: 0 10px 24px rgba(0,0,0,.22);
      --fieldBg: rgba(11,18,32,.85); --fieldBorder: rgba(255,255,255,.14); --fieldFocus: rgba(77,163,255,.55);
      --rowBg: rgba(11,18,32,.60); --rowBorder: rgba(255,255,255,.08);
      --msgBg: rgba(11,18,32,.75);
      --fileBg:#334155; --fileBorder: rgba(255,255,255,.10);
      --topbarBg: rgba(17,28,52,.85); --topbarBorder: rgba(255,255,255,.08);
      --chipBg: rgba(77,163,255,.12); --chipBorder: rgba(77,163,255,.25); --chipText: #cfe6ff;
      --divider: rgba(255,255,255,.10);
      --link: #7cc0ff;
    }
    [data-theme="light"]{
      --bg:#f6f8fc; --panel:#ffffff; --panel2:#ffffff;
      --text:#0b1220; --muted:rgba(15,23,42,.72); --line:rgba(15,23,42,.12);
      --brand:#2563eb; --btn:#2563eb; --btnText:#fff; --btn2:#e2e8f0;
      --shadow: 0 10px 24px rgba(2,6,23,.08);
      --fieldBg: rgba(255,255,255,.95); --fieldBorder: rgba(15,23,42,.14); --fieldFocus: rgba(37,99,235,.45);
      --rowBg: rgba(2,6,23,.03); --rowBorder: rgba(2,6,23,.08);
      --msgBg: rgba(2,6,23,.03);
      --fileBg: rgba(2,6,23,.06); --fileBorder: rgba(2,6,23,.10);
      --topbarBg: rgba(255,255,255,.85); --topbarBorder: rgba(2,6,23,.10);
      --chipBg: rgba(37,99,235,.10); --chipBorder: rgba(37,99,235,.22); --chipText: rgba(15,23,42,.85);
      --divider: rgba(2,6,23,.10);
      --link: #2563eb;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial, sans-serif; color:var(--text); padding:24px;
      background:
        radial-gradient(1100px 460px at 10% -10%, rgba(77,163,255,.22), transparent 60%),
        radial-gradient(900px 380px at 90% 0%, rgba(37,99,235,.18), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1100px;margin:0 auto}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-radius:16px;
      background: var(--topbarBg); border:1px solid var(--topbarBorder);
      backdrop-filter: blur(6px); margin-bottom:16px; box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0;}
    .brandLogo{
      width:44px;height:44px;border-radius:12px; background:var(--panel2); border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center; padding:6px; flex:0 0 auto;
    }
    .brandLogo img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .brandTitle h1{font-size:16px;margin:0;color:var(--brand);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .brandTitle .sub{margin:2px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .topbarRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .chip{
      font-size:12px; padding:6px 10px;border-radius:999px;
      background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--chipText);
      white-space:nowrap;
    }

    .box{
      background: linear-gradient(180deg, rgba(17,28,52,.95), rgba(15,26,50,.95));
      border:1px solid rgba(255,255,255,.08);
      padding:16px; border-radius:16px; margin-bottom:14px; box-shadow: var(--shadow);
    }
    [data-theme="light"] .box{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
      border:1px solid rgba(2,6,23,.10);
    }

    h2{margin:0 0 10px;font-size:16px}
    h3{margin:10px 0 8px;font-size:14px}
    label{display:block;margin-top:10px;font-size:13px;color:var(--muted)}
    input,textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--fieldBorder); background:var(--fieldBg); color:var(--text); outline:none;
    }
    input:focus,textarea:focus{border-color:var(--fieldFocus); box-shadow:0 0 0 4px rgba(77,163,255,.12)}
    [data-theme="light"] input:focus,[data-theme="light"] textarea:focus{box-shadow:0 0 0 4px rgba(37,99,235,.12)}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    button{
      padding:10px 12px; border-radius:12px; border:0;
      background:var(--btn); color:var(--btnText); font-weight:800; cursor:pointer;
      transition:.12s transform ease, .12s opacity ease;
    }
    button:hover{transform: translateY(-1px)}
    button:active{transform: translateY(0px); opacity:.92}
    button.secondary{
      background:var(--btn2); color: var(--text); font-weight:700; border:1px solid var(--line);
    }
    [data-theme="light"] button.secondary{color:#0b1220;border:1px solid rgba(2,6,23,.10)}
    button.small{padding:8px 10px;border-radius:12px;margin-top:0}

    .hint{opacity:.86;font-size:12px;margin-top:8px;white-space:pre-wrap;line-height:1.35;color:var(--muted)}
    .divider{height:1px;background:var(--divider);margin:14px 0}
    a{color:var(--link)}

    .providerRow{
      display:flex;align-items:center;gap:10px;
      padding:10px 10px;border-radius:14px;
      background:var(--rowBg);
      border:1px solid var(--rowBorder);
      margin:8px 0;
      min-height:46px;
    }
    .providerRow input{margin-top:0}
    .providerRow .txt{
      flex:1; min-width:0;
      display:flex; flex-direction:column; justify-content:center;
    }
    .providerRow .main{
      display:block; font-size:13px; font-weight:800; color:var(--text);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .providerRow .sub{
      display:block; margin-top:2px; font-size:12px; font-weight:600; color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .msg{background:var(--msgBg); padding:12px; border-radius:14px; margin-top:10px; border:1px solid var(--rowBorder)}
    .msg.you{border-left:4px solid var(--brand)}
    .msg.them{border-left:4px solid #22c55e}
    .msgHead{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .msgMeta{font-size:12px;opacity:.75;color:var(--muted)}
    .msgWho{font-weight:800}
    .msgBody{margin-top:8px;line-height:1.45;font-size:13px}

    .file{
      display:inline-block; margin-top:8px; padding:8px 10px; border-radius:12px;
      background:var(--fileBg); color:var(--text); text-decoration:none; border:1px solid var(--fileBorder);
    }
    .thumb{
      margin-top:8px;
      max-width:260px;
      border-radius:12px;
      border:1px solid var(--fileBorder);
      display:block;
    }

    .card{background:var(--rowBg); border:1px solid var(--rowBorder); border-radius:16px; padding:14px;}
    .gridInfo{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.gridInfo{grid-template-columns:1fr}}
    .kv{padding:10px 10px;border-radius:14px;background:rgba(17,28,52,.35);border:1px solid var(--rowBorder);}
    [data-theme="light"] .kv{background:rgba(2,6,23,.03)}
    .kv b{display:block;font-size:12px;opacity:.8;margin-bottom:4px}
    .kv div{font-size:13px;word-break:break-word}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="brandLogo">
        <img src="./assets/logo-mfautosud.png" alt="MF Auto Sud">
      </div>
      <div class="brandTitle">
        <h1>Portail Prescripteur</h1>
        <div class="sub">Cr√©er ‚Ä¢ Suivre ‚Ä¢ Envoyer ‚Ä¢ R√©pondre</div>
      </div>
    </div>
    <div class="topbarRight">
      <div class="chip">Prescripteur</div>
      <div class="chip" id="newMsgChip" style="display:none;">üîî Nouveau message</div>
      <button class="secondary" id="themeBtn" type="button">üåô Mode sombre</button>
    </div>
  </div>

  <div class="box">
    <h2>Cr√©er une demande</h2>
    <div class="gridInfo" style="margin-top:10px">
      <div>
        <label>Client (nom / soci√©t√©)</label>
        <input id="clientName" placeholder="Ex. : Dupont SARL">
      </div>
      <div>
        <label>V√©hicule</label>
        <input id="vehicle" placeholder="Ex. : Peugeot 208">
      </div>
      <div>
        <label>Adresse</label>
        <input id="address" placeholder="Ex. : 12 rue des Fleurs">
      </div>
      <div>
        <label>Code postal</label>
        <input id="postcode" placeholder="Ex. : 13008">
      </div>
      <div>
        <label>Ville</label>
        <input id="city" placeholder="Ex. : Marseille">
      </div>
      <div>
        <label>Pays</label>
        <input id="country" placeholder="Ex. : France">
      </div>
      <div>
        <label>Contact (nom / service)</label>
        <input id="contactName" placeholder="Ex. : Mme Martin">
      </div>
      <div>
        <label>Email contact</label>
        <input id="contactEmail" placeholder="contact@exemple.com">
      </div>
      <div>
        <label>T√©l√©phone contact</label>
        <input id="contactPhone" placeholder="06 12 34 56 78">
      </div>
      <div>
        <label>SIRET</label>
        <input id="siret" placeholder="SIRET">
      </div>
      <div>
        <label>TVA</label>
        <input id="vat" placeholder="TVA">
      </div>
      <div>
        <label>Message initial</label>
        <textarea id="message" style="height:120px" placeholder="D√©tails de la demande‚Ä¶"></textarea>
      </div>
    </div>

    <label>Documents (PDF, images‚Ä¶)</label>
    <input type="file" id="reqFiles" multiple accept="application/pdf,image/*">

    <div class="row">
      <button id="sendBtn" type="button">Envoyer la demande</button>
      <button class="secondary" id="resetBtn" type="button">R√©initialiser</button>
    </div>
    <div id="sendStatus" class="hint"></div>
  </div>

  <div class="box">
    <h2>R√©pertoire des prestataires</h2>
    <div id="providersList" style="margin-top:10px"></div>

    <div class="divider"></div>

    <h3>Ajouter un prestataire</h3>
    <div class="gridInfo" style="margin-top:10px">
      <div>
        <label>Email</label>
        <input id="providerEmail" placeholder="exemple@domaine.com">
      </div>
      <div>
        <label>Nom (optionnel)</label>
        <input id="providerName" placeholder="Ex. : Groupe Grim">
      </div>
    </div>

    <div class="row">
      <label class="checkline"><input type="checkbox" id="providerIsManager"> Chef des ventes</label>
      <label class="checkline"><input type="checkbox" id="providerIsVendor"> Vendeur</label>
    </div>

    <div class="row">
      <button id="addProviderBtn" type="button">‚ûï Ajouter</button>
      <button class="secondary" id="importProvidersBtn" type="button">üì• Importer liste</button>
      <button class="secondary" id="exportProvidersBtn" type="button">üì§ Exporter liste</button>
      <button class="secondary" id="clearProvidersBtn" type="button">üóëÔ∏è Tout effacer</button>
    </div>
    <div id="providersStatus" class="hint"></div>
  </div>

  <div class="box">
    <h2>Envoyer √† des prestataires</h2>
    <div class="row">
      <button class="secondary" type="button" onclick="checkAll(true)">Tout cocher</button>
      <button class="secondary" type="button" onclick="checkAll(false)">Tout d√©cocher</button>
    </div>
    <div class="hint">S√©lectionne les prestataires √† pr√©venir.</div>
  </div>

  <div class="box">
    <h2>Conversation</h2>
    <div id="thread" style="margin-top:10px"></div>
  </div>

  <div class="box" id="providerUI" style="display:none;">
    <h2>R√©ponse prestataire</h2>
    <div id="providerThread" class="hint">Chargement‚Ä¶</div>
    <label>Message</label>
    <textarea id="providerReplyMsg" style="height:120px" placeholder="Votre r√©ponse‚Ä¶"></textarea>
    <label>Documents (PDF, images‚Ä¶)</label>
    <input type="file" id="providerReplyFiles" multiple accept="application/pdf,image/*">
    <div class="row">
      <button id="providerReplyBtn" type="button">Envoyer la r√©ponse</button>
    </div>
    <div id="providerReplyStatus" class="hint"></div>
  </div>
</div>

<script>
/* ========================= CONFIG ========================= */
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1YmhzamtzdGJycWx2bXlsb2J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDE1NzQsImV4cCI6MjA4NDk3NzU3NH0.tANS4zo9wvLsWJS48Hyw6thttQX0yhBjOKI1aY4FTCo";

/* ========================= THEME ========================= */
const THEME_KEY = "mfautosud_theme";
function applyTheme(theme){
  const t = (theme === "light") ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem(THEME_KEY, t);
  const btn = document.getElementById("themeBtn");
  if(btn) btn.textContent = (t === "light") ? "‚òÄÔ∏è Mode clair" : "üåô Mode sombre";
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(cur === "dark" ? "light" : "dark");
}
(function(){
  applyTheme(localStorage.getItem(THEME_KEY) || "dark");
  document.getElementById("themeBtn")?.addEventListener("click", toggleTheme);
})();

/* ========================= STATE ========================= */
let RID = "";
let CODE = "";
let PROVIDER_EMAIL = "";
let PROVIDER_ROLE = "";

/* ========================= UTILS ========================= */
function $(id){ return document.getElementById(id); }
function escHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function normalizeEmail(email){ return (email || "").trim().toLowerCase(); }
function emailLooksValid(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||"").trim().toLowerCase()); }
function baseUrl(){ return window.location.origin + window.location.pathname; }

/* ========================= FILE UPLOAD ========================= */
async function uploadFiles(requestId, fileInput){
  const uploaded = [];
  if(!fileInput || !fileInput.files || !fileInput.files.length) return uploaded;

  for(const file of fileInput.files){
    const fd = new FormData();
    fd.append("file", file);
    fd.append("request_id", requestId);
    fd.append("access_code", CODE || "");
    fd.append("uploader_email", (PROVIDER_EMAIL || "").toLowerCase());

    const res = await fetch(`${SUPABASE_URL}/functions/v1/upload-attachment`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY
      },
      body: fd
    });

    let data = null;
    try { data = await res.json(); } catch {}

    if(!res.ok){
      throw new Error(data?.error || `upload-attachment failed: ${res.status}`);
    }

    const returnedUrl =
      data?.url ||
      data?.publicUrl ||
      data?.public_url ||
      data?.signedUrl ||
      data?.signed_url ||
      "";

    if(!returnedUrl){
      throw new Error("upload-attachment: URL manquante dans la r√©ponse");
    }

    uploaded.push({
      name: data?.name || data?.filename || file.name,
      url: returnedUrl
    });
  }

  return uploaded;
}

/* ========================= PROVIDERS localStorage ========================= */
const PROVIDERS_KEY = "mfautosud_providers_v3";
function toBool(value){
  if(typeof value === "string"){
    const v = value.trim().toLowerCase();
    if(["true","1","yes","y","oui"].includes(v)) return true;
    if(["false","0","no","n","non"].includes(v)) return false;
  }
  if(typeof value === "number") return value === 1;
  return !!value;
}

function normalizeProvider(raw){
  if(typeof raw === "string"){
    const email = normalizeEmail(raw);
    return { email, name: "", is_sales_manager: false, is_vendor: false };
  }
  const email = normalizeEmail(
    raw?.email ||
    raw?.provider_email ||
    raw?.providerEmail ||
    raw?.mail ||
    raw?.e_mail ||
    raw?.value ||
    raw?.id ||
    ""
  );
  const name = String(
    raw?.name ||
    raw?.provider_name ||
    raw?.providerName ||
    raw?.display_name ||
    raw?.label ||
    ""
  ).trim();
  const fallbackEmail = (!email && emailLooksValid(name)) ? normalizeEmail(name) : email;
  const is_sales_manager = toBool(raw?.is_sales_manager ?? raw?.is_manager ?? raw?.isManager ?? raw?.sales_manager);
  const is_vendor = toBool(raw?.is_vendor ?? raw?.isVendor ?? raw?.vendor);
  return { email: fallbackEmail, name, is_sales_manager, is_vendor };
}

function loadProviders(){
  try{
    const raw = localStorage.getItem(PROVIDERS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(arr)) return [];
    const normalized = arr.map(normalizeProvider);
    return normalized;
  }catch{ return []; }
}
function saveProviders(arr){
  const normalized = Array.isArray(arr) ? arr.map(normalizeProvider) : [];
  localStorage.setItem(PROVIDERS_KEY, JSON.stringify(normalized));
}

function removeProvider(index){
  const providers = loadProviders();
  providers.splice(index, 1);
  saveProviders(providers);
  renderProviders();
}

function renderProviders(){
  const listEl = $("providersList");
  if(!listEl) return;

  const providers = loadProviders();
  if(!providers.length){
    listEl.innerHTML = `<div class="hint">Aucun prestataire enregistr√©.</div>`;
    return;
  }

  listEl.innerHTML = providers.map((p, idx) => {
    const email = normalizeEmail(p.email || "");
    const name  = String(p.name || "").trim();
    const primary = email || name || "Email manquant";
    const tags = [
      p.is_sales_manager ? "Chef des ventes" : "",
      p.is_vendor ? "Vendeur" : ""
    ].filter(Boolean).join(" ‚Ä¢ ");

    return `
      <div class="providerRow">
        <input type="checkbox" class="providerCheck" data-email="${escHtml(email)}" aria-label="S√©lection prestataire">
        <div class="txt">
          <span class="main">${escHtml(primary)}</span>
          ${email && name ? `<span class="sub">${escHtml(name)}</span>` : ""}
          ${tags ? `<span class="sub">${escHtml(tags)}</span>` : ""}
        </div>
        <button class="small secondary" type="button" onclick="removeProvider(${idx})">Suppr.</button>
      </div>
    `;
  }).join("");
}

async function addProvider(){
  const email = normalizeEmail($("providerEmail")?.value || "");
  const name = String($("providerName")?.value || "").trim();
  const is_sales_manager = !!$("providerIsManager")?.checked;
  const is_vendor = !!$("providerIsVendor")?.checked;

  if(!email){ alert("Saisis un e-mail."); return; }
  if(!emailLooksValid(email)){ alert("E-mail invalide."); return; }
  if(!is_sales_manager && !is_vendor){
    alert("Coche au moins un r√¥le : Chef des ventes ou Vendeur.");
    return;
  }

  const providers = loadProviders();
  if(providers.some(p => normalizeEmail(p.email) === email)){
    alert("D√©j√† enregistr√©."); return;
  }

  providers.push({ name, email, is_sales_manager, is_vendor });
  saveProviders(providers);

  $("providerEmail").value = "";
  $("providerName").value = "";
  $("providerIsManager").checked = false;
  $("providerIsVendor").checked = false;

  renderProviders();
}

function checkAll(on){ document.querySelectorAll(".providerCheck").forEach(c=>c.checked=!!on); }

/* ========================= FILE RENDERING ========================= */
function isImageUrl(url){
  const u = String(url || "").toLowerCase();
  return u.endsWith(".png") || u.endsWith(".jpg") || u.endsWith(".jpeg") || u.endsWith(".webp") || u.includes("image/");
}

function normalizeFiles(raw){
  if(!raw) return [];
  if(Array.isArray(raw)) return raw.filter(Boolean);

  if(typeof raw === "string"){
    try{
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed.filter(Boolean) : [];
    }catch{
      return [raw];
    }
  }

  if(typeof raw === "object"){
    if(Array.isArray(raw.files)) return raw.files;
    return [];
  }

  return [];
}

function resolveFileUrl(file){
  if(typeof file === "string") return file.trim();
  const raw =
    file?.url ||
    file?.publicUrl ||
    file?.public_url ||
    file?.signedUrl ||
    file?.signed_url ||
    file?.download_url ||
    file?.file_path ||
    file?.filepath ||
    file?.path ||
    file?.storage_path ||
    "";
  const url = String(raw || "").trim();
  if(!url) return "";
  if(/^https?:\/\//i.test(url)) return url;
  if(url.startsWith("/")){
    return `${SUPABASE_URL}${url}`;
  }
  if(url.startsWith("attachments/")){
    return `${SUPABASE_URL}/storage/v1/object/public/${url}`;
  }
  return `${SUPABASE_URL}/storage/v1/object/public/attachments/${url}`;
}

function renderMessageFiles(rawFiles){
  const files = normalizeFiles(rawFiles);
  if(!files.length) return "";

  return files.map(f => {
    const name = escHtml((typeof f === "string" ? f.split("/").pop() : f?.name) || "fichier");
    const url = resolveFileUrl(f);

    if(!url){
      return `<div class="hint">üìé ${name} (lien indisponible)</div>`;
    }

    const link = `
      <div>
        <a class="file" href="${url}" target="_blank" rel="noopener" download>üìé T√©l√©charger : ${name}</a>
      </div>
    `;

    const preview = isImageUrl(url)
      ? `<img class="thumb" src="${url}" alt="${name}">`
      : "";

    return link + preview;
  }).join("");
}

/* ========================= INIT ========================= */
window.addEventListener("load", () => {
  renderProviders();
});
</script>
</body>
</html>
