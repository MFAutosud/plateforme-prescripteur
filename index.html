<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Plateforme prescripteur ‚Äì MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="./assets/logo-mfautosud.png">
  <style>
    :root{
      --bg:#0b1220; --panel:#111c34; --panel2:#0f1a32;
      --text:#ffffff; --muted:rgba(255,255,255,.75); --line:rgba(255,255,255,.10);
      --brand:#4da3ff; --btn:#4da3ff; --btnText:#001; --btn2:#334155;
      --shadow: 0 10px 24px rgba(0,0,0,.22);
      --fieldBg: rgba(11,18,32,.85); --fieldBorder: rgba(255,255,255,.14); --fieldFocus: rgba(77,163,255,.55);
      --rowBg: rgba(11,18,32,.60); --rowBorder: rgba(255,255,255,.08);
      --msgBg: rgba(11,18,32,.75);
      --fileBg:#334155; --fileBorder: rgba(255,255,255,.10);
      --topbarBg: rgba(17,28,52,.85); --topbarBorder: rgba(255,255,255,.08);
      --chipBg: rgba(77,163,255,.12); --chipBorder: rgba(77,163,255,.25); --chipText: #cfe6ff;
      --divider: rgba(255,255,255,.10);
      --link: #7cc0ff;
    }
    [data-theme="light"]{
      --bg:#f6f8fc; --panel:#ffffff; --panel2:#ffffff;
      --text:#0b1220; --muted:rgba(15,23,42,.72); --line:rgba(15,23,42,.12);
      --brand:#2563eb; --btn:#2563eb; --btnText:#fff; --btn2:#e2e8f0;
      --shadow: 0 10px 24px rgba(2,6,23,.08);
      --fieldBg: rgba(255,255,255,.95); --fieldBorder: rgba(15,23,42,.14); --fieldFocus: rgba(37,99,235,.45);
      --rowBg: rgba(2,6,23,.03); --rowBorder: rgba(2,6,23,.08);
      --msgBg: rgba(2,6,23,.03);
      --fileBg: rgba(2,6,23,.06); --fileBorder: rgba(2,6,23,.10);
      --topbarBg: rgba(255,255,255,.85); --topbarBorder: rgba(2,6,23,.10);
      --chipBg: rgba(37,99,235,.10); --chipBorder: rgba(37,99,235,.22); --chipText: rgba(15,23,42,.85);
      --divider: rgba(2,6,23,.10);
      --link: #2563eb;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial, sans-serif; color:var(--text); padding:24px;
      background:
        radial-gradient(1100px 460px at 10% -10%, rgba(77,163,255,.22), transparent 60%),
        radial-gradient(900px 380px at 90% 0%, rgba(37,99,235,.18), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1100px;margin:0 auto}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-radius:16px;
      background: var(--topbarBg); border:1px solid var(--topbarBorder);
      backdrop-filter: blur(6px); margin-bottom:16px; box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0;}
    .brandLogo{
      width:44px;height:44px;border-radius:12px; background:var(--panel2); border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center; padding:6px; flex:0 0 auto;
    }
    .brandLogo img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .brandTitle h1{font-size:16px;margin:0;color:var(--brand);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .brandTitle .sub{margin:2px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .topbarRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .chip{
      font-size:12px; padding:6px 10px;border-radius:999px;
      background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--chipText);
      white-space:nowrap;
    }

    .box{
      background: linear-gradient(180deg, rgba(17,28,52,.95), rgba(15,26,50,.95));
      border:1px solid rgba(255,255,255,.08);
      padding:16px; border-radius:16px; margin-bottom:14px; box-shadow: var(--shadow);
    }
    [data-theme="light"] .box{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
      border:1px solid rgba(2,6,23,.10);
    }

    h2{margin:0 0 10px;font-size:16px}
    h3{margin:10px 0 8px;font-size:14px}
    label{display:block;margin-top:10px;font-size:13px;color:var(--muted)}
    input,textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--fieldBorder); background:var(--fieldBg); color:var(--text); outline:none;
    }
    input:focus,textarea:focus{border-color:var(--fieldFocus); box-shadow:0 0 0 4px rgba(77,163,255,.12)}
    [data-theme="light"] input:focus,[data-theme="light"] textarea:focus{box-shadow:0 0 0 4px rgba(37,99,235,.12)}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    button{
      padding:10px 12px; border-radius:12px; border:0;
      background:var(--btn); color:var(--btnText); font-weight:800; cursor:pointer;
      transition:.12s transform ease, .12s opacity ease;
    }
    button:hover{transform: translateY(-1px)}
    button:active{transform: translateY(0px); opacity:.92}
    button.secondary{
      background:var(--btn2); color: var(--text); font-weight:700; border:1px solid var(--line);
    }
    [data-theme="light"] button.secondary{color:#0b1220;border:1px solid rgba(2,6,23,.10)}
    button.small{padding:8px 10px;border-radius:12px;margin-top:0}

    .hint{opacity:.86;font-size:12px;margin-top:8px;white-space:pre-wrap;line-height:1.35;color:var(--muted)}
    .divider{height:1px;background:var(--divider);margin:14px 0}
    a{color:var(--link)}

    .providerRow{
      display:flex;align-items:center;gap:10px;
      padding:10px 10px;border-radius:14px;
      background:var(--rowBg);
      border:1px solid var(--rowBorder);
      margin:8px 0;
      min-height:46px;
    }
    .providerRow input{margin-top:0}
    .providerRow .txt{
      flex:1; min-width:0;
      display:flex; flex-direction:column; justify-content:center;
    }
    .providerRow .main{
      display:block; font-size:13px; font-weight:800; color:var(--text);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .providerRow .sub{
      display:block; margin-top:2px; font-size:12px; font-weight:600; color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .msg{background:var(--msgBg); padding:12px; border-radius:14px; margin-top:10px; border:1px solid var(--rowBorder)}
    .msg.you{border-left:4px solid var(--brand)}
    .msg.them{border-left:4px solid #22c55e}
    .msgHead{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .msgMeta{font-size:12px;opacity:.75;color:var(--muted)}
    .msgWho{font-weight:800}
    .msgBody{margin-top:8px;line-height:1.45;font-size:13px}

    .file{
      display:inline-block; margin-top:8px; padding:8px 10px; border-radius:12px;
      background:var(--fileBg); color:var(--text); text-decoration:none; border:1px solid var(--fileBorder);
    }
    .thumb{
      margin-top:8px;
      max-width:260px;
      border-radius:12px;
      border:1px solid var(--fileBorder);
      display:block;
    }

    .card{background:var(--rowBg); border:1px solid var(--rowBorder); border-radius:16px; padding:14px;}
    .gridInfo{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.gridInfo{grid-template-columns:1fr}}
    .kv{padding:10px 10px;border-radius:14px;background:rgba(17,28,52,.35);border:1px solid var(--rowBorder);}
    [data-theme="light"] .kv{background:rgba(2,6,23,.03)}
    .kv b{display:block;font-size:12px;opacity:.8;margin-bottom:4px}
    .kv div{font-size:13px;word-break:break-word}
    /* ============ iMessage-like chat ============ */
.msg{
  background: transparent;
  border: 0;
  padding: 0;
  margin-top: 10px;
}

.msgRow{
  display:flex;
  width:100%;
}

.msgRow.you{ justify-content:flex-end; }
.msgRow.them{ justify-content:flex-start; }

.bubble{
  max-width: 78%;
  padding: 10px 12px;
  border-radius: 18px;
  border: 1px solid var(--rowBorder);
  background: var(--msgBg);
  box-shadow: 0 6px 16px rgba(0,0,0,.10);
}

.msgRow.you .bubble{ border-bottom-right-radius: 8px; }
.msgRow.them .bubble{ border-bottom-left-radius: 8px; }

.bubbleHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:6px;
}

.bubbleWho{
  font-size:12px;
  font-weight:800;
  opacity:.9;
}

.bubbleMeta{
  font-size:11px;
  opacity:.7;
  color: var(--muted);
  white-space:nowrap;
}

.bubbleBody{
  font-size:13px;
  line-height:1.45;
  word-break:break-word;
}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="brandLogo">
        <img src="./assets/logo-mfautosud.png" alt="MF Auto Sud">
      </div>
      <div class="brandTitle">
        <h1>Plateforme prescripteur ‚Äì MF Auto Sud</h1>
        <div class="sub">Demandes ‚Ä¢ R√©ponses ‚Ä¢ Pi√®ces jointes ‚Ä¢ Transferts ‚Ä¢ Relances automatiques</div>
      </div>
    </div>

    <div class="topbarRight">
      <div class="chip" id="modeChip">Mode : Prescripteur</div>
      <div class="chip" id="newMsgChip" style="display:none;">üîî Nouveau message</div>
      <button class="secondary" id="themeBtn" type="button" style="white-space:nowrap">üåô Mode sombre</button>
    </div>
  </div>

  <!-- ========================= PRESCRIPTEUR UI ========================= -->
  <div id="prescriberUI">
    <!-- (inchang√©) -->
    <div class="box">
      <h2>1) Cr√©er une demande</h2>

      <div class="grid2">
        <div>
          <label>V√©hicule</label>
          <input id="vehicle" placeholder="Ex. : Ford Puma LLD 25 mois ‚Äì 30 000 km ‚Äì entretien inclus">
        </div>

        <div>
          <label>Lien de la demande</label>
          <div class="row" style="margin-top:10px">
            <button class="secondary" id="copyLinkBtn" type="button">Copier le lien</button>
          </div>
          <div class="hint">Disponible apr√®s cr√©ation (rid + code).</div>
        </div>
      </div>

      <label>Bloc client (copier-coller) ‚Äî 1 ≥·µâ ligne = nom du client</label>
      <textarea id="pasteBlock" style="height:180px" placeholder="Colle ici le bloc complet‚Ä¶"></textarea>

      <div class="card" style="margin-top:12px">
        <div class="gridInfo">
          <div class="kv"><b>Client</b><div id="previewClientName">‚Äî</div></div>
          <div class="kv"><b>Type client</b><div id="previewClientType">‚Äî</div></div>
          <div class="kv"><b>Adresse</b><div id="previewAddress">‚Äî</div></div>
          <div class="kv"><b>Contact</b><div id="previewContact">‚Äî</div></div>
          <div class="kv"><b>Email contact</b><div id="previewContactEmail">‚Äî</div></div>
          <div class="kv"><b>T√©l√©phone</b><div id="previewContactPhone">‚Äî</div></div>
          <div class="kv"><b>SIRET</b><div id="previewSiret">‚Äî</div></div>
          <div class="kv"><b>TVA</b><div id="previewVat">‚Äî</div></div>
        </div>
      </div>

      <div class="row">
        <button id="createBtn" type="button">Cr√©er la demande</button>
      </div>

      <div id="link" class="hint"></div>
    </div>

    <div class="box" id="sendBox" style="display:none;">
      <h2>2) Envoyer √† des prestataires</h2>

      <div class="row">
        <button class="secondary" id="checkAllBtn" type="button">Tout cocher</button>
        <button class="secondary" id="uncheckAllBtn" type="button">Tout d√©cocher</button>
        <button class="secondary" id="exportProvidersBtn" type="button">Exporter</button>
        <button class="secondary" id="clearProvidersBtn" type="button">Tout effacer</button>
      </div>

      <div id="providersList" style="margin-top:10px"></div>

      <div class="divider"></div>

      <h3>Ajouter / importer</h3>

      <div class="grid2">
        <div>
          <label>E-mail du prestataire</label>
          <input id="providerEmail" placeholder="exemple@domaine.com">
        </div>
        <div>
          <label>Nom (optionnel)</label>
          <input id="providerName" placeholder="Ex. : Groupe Grim">
        </div>
      </div>
      <div class="grid2">
        <div>
          <label>Marque / groupe</label>
          <input id="providerBrand" placeholder="Ex. : Peugeot, Renault, Groupe‚Ä¶">
        </div>
        <div>
          <label>Email manager (optionnel)</label>
          <input id="providerManagerEmail" placeholder="manager@domaine.com">
        </div>
      </div>

      <div class="row">
        <button id="addProviderBtn" type="button">Ajouter au r√©pertoire</button>
      </div>

      <label>Importer une liste (1 par ligne : Nom <email> ou email)</label>
      <textarea id="importArea" style="height:110px" placeholder="Ex. : Nom <email@domaine.com>"></textarea>
      <div class="row">
        <button class="secondary" id="importProvidersBtn" type="button">Importer</button>
      </div>

      <label>Message (optionnel) inclus dans l‚Äôe-mail</label>
      <textarea id="customMessage" style="height:90px" placeholder="Texte optionnel‚Ä¶"></textarea>

      <div class="row">
        <button id="sendBtn" type="button">‚úÖ Envoyer automatiquement</button>
        <button class="secondary" id="copyLinkBtn2" type="button">Copier le lien</button>
      </div>

      <div id="sendStatus" class="hint"></div>
    </div>

  <div class="box">
      <h2>3) Conversation</h2>
      <div class="row">
        <button class="secondary" id="refreshThreadBtn" type="button">üîÑ Rafra√Æchir</button>
        <button class="secondary" id="markReadBtn" type="button">‚úÖ Marquer comme lu</button>
        <button class="secondary" id="copyLinkBtn3" type="button">Copier le lien</button>
        <button class="secondary" id="sendClientBtn" type="button">üì§ Envoyer au client</button>
      </div>
      <div id="thread" style="margin-top:10px"></div>
    </div>

    <div class="box" id="prescriberReplyBox" style="display:none;">
      <h2>4) R√©pondre (MF Auto Sud)</h2>

      <label>Message</label>
      <textarea id="prescMsg" style="height:120px" placeholder="Votre message‚Ä¶"></textarea>

      <label>Documents (PDF, images‚Ä¶)</label>
      <input type="file" id="prescFiles" multiple>

      <div class="row">
        <button id="prescReplyBtn" type="button">Envoyer la r√©ponse</button>
      </div>
      <div id="prescStatus" class="hint"></div>

      <div class="divider"></div>

      <h3>Relance automatique prestataire</h3>
      <label>Activer relance automatique</label>
      <div class="row">
        <label class="checkline"><input type="checkbox" id="autoReminder"> Relancer les prestataires qui n‚Äôont pas r√©pondu</label>
      </div>

      <div class="grid2">
        <div>
          <label>D√©lai relance (jours)</label>
          <input id="reminderDays" type="number" min="1" value="3">
        </div>
        <div>
          <label>Heure d‚Äôenvoi (hh:mm)</label>
          <input id="reminderHour" value="09:00">
        </div>
      </div>

      <div class="row">
        <button class="secondary" id="reminderBtn" type="button">üí¨ Configurer la relance</button>
      </div>

      <div id="reminderStatus" class="hint"></div>
    </div>
  </div>

  <!-- ========================= PROVIDER UI ========================= -->
  <div id="providerUI" style="display:none;">
    <div class="box">
      <h2>Dossier prestataire</h2>
      <div class="row">
        <button class="secondary" id="refreshThreadProviderBtn" type="button">üîÑ Rafra√Æchir</button>
        <button class="secondary" id="markReadProviderBtn" type="button">‚úÖ Marquer comme lu</button>
      </div>
      <div id="threadProvider" style="margin-top:10px"></div>
    </div>

    <div class="box">
      <h2>R√©pondre</h2>
      <label>Message</label>
      <textarea id="providerReplyMsg" style="height:120px" placeholder="Votre message‚Ä¶"></textarea>

      <label>Documents (PDF, images‚Ä¶)</label>
      <input type="file" id="providerReplyFiles" multiple>

      <div class="row">
        <button id="providerReplyBtn" type="button">Envoyer la r√©ponse</button>
      </div>
      <div id="providerReplyStatus" class="hint"></div>
    </div>
  </div>

</div>

<script>
/* ========================= CONFIG ========================= */
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1YmhzamtzdGJycWx2bXlsb2J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDE1NzQsImV4cCI6MjA4NDk3NzU3NH0.tANS4zo9wvLsWJS48Hyw6thttQX0yhBjOKI1aY4FTCo";

const PRESCRIBER_EMAIL = "mfautosudprescription@gmail.com";

/* ========================= THEME ========================= */
const THEME_KEY = "mfautosud_theme";
function applyTheme(theme){
  const t = (theme === "light") ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem(THEME_KEY, t);
  const btn = document.getElementById("themeBtn");
  if(btn) btn.textContent = (t === "light") ? "‚òÄÔ∏è Mode clair" : "üåô Mode sombre";
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(cur === "dark" ? "light" : "dark");
}
(function(){
  applyTheme(localStorage.getItem(THEME_KEY) || "dark");
  document.getElementById("themeBtn")?.addEventListener("click", toggleTheme);
})();

/* ========================= STATE ========================= */
let RID = "";
let CODE = "";
let PROVIDER_EMAIL = "";
let PROVIDER_ROLE = "";
let DEBUG_ON = false;
let REQUEST_DATA = null;
let THREAD_CACHE = [];

/* ========================= UTILS ========================= */
function $(id){ return document.getElementById(id); }
function escHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function normalizeEmail(email){ return (email || "").trim().toLowerCase(); }
function emailLooksValid(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||"").trim().toLowerCase()); }
function baseUrl(){ return window.location.origin + window.location.pathname; }
function randomCode(len=6){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out = "";
  for(let i=0;i<len;i++){
    out += chars[Math.floor(Math.random()*chars.length)];
  }
  return out;
}

function currentTheme(){
  return document.documentElement.getAttribute("data-theme") || "dark";
}
function hashHue(str){
  const s = String(str || "");
  let h = 0;
  for(let i=0;i<s.length;i++){
    h = (h * 31 + s.charCodeAt(i)) >>> 0;
  }
  return h % 360;
}
function bubbleStyleForSender(senderEmail, isYou){
  if(isYou){
    return `background: linear-gradient(180deg, var(--brand), var(--brand)); color: #fff; border-color: rgba(255,255,255,.18);`;
  }
  const hue = hashHue(senderEmail || "unknown");
  const theme = currentTheme();
  if(theme === "light"){
    return `background: hsl(${hue} 85% 96%); color:#0b1220; border-color: rgba(2,6,23,.10);`;
  }
  return `background: hsl(${hue} 55% 18%); color:#ffffff; border-color: rgba(255,255,255,.10);`;
}

function getAllParams(){
  const url = new URL(window.location.href);
  const qs = url.searchParams;
  const hs = new URLSearchParams(window.location.hash.replace("#",""));
  const rid   = qs.get("rid")   || hs.get("rid");
  const code  = qs.get("code")  || hs.get("code");
  const pe    = qs.get("pe")    || hs.get("pe");
  const debug = qs.get("debug") || hs.get("debug");
  return { rid, code, pe, debug };
}

async function fetchJson(url, options){
  const res = await fetch(url, options);
  let data = null;
  try { data = await res.json(); } catch {}
  return { res, data };
}

/* ========================= DEBUG ========================= */
function debugShow(show){
  const box = $("debugBox");
  if(box) box.style.display = show ? "" : "none";
}
function debugClear(){
  const out = $("debugOut");
  if(out) out.textContent = "‚Äî";
}
function debugLog(...args){
  if(!DEBUG_ON) return;
  const out = $("debugOut");
  if(!out) return;
  out.textContent += "\n" + args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
}

/* ========================= STORAGE ========================= */
const PROVIDERS_KEY = "mfautosud_providers";
function loadProviders(){
  try{
    const raw = localStorage.getItem(PROVIDERS_KEY);
    const arr = JSON.parse(raw || "[]");
    return Array.isArray(arr) ? arr : [];
  }catch{
    return [];
  }
}
function saveProviders(list){
  localStorage.setItem(PROVIDERS_KEY, JSON.stringify(list || []));
}
function normalizeProvider(p){
  const email = normalizeEmail(p?.email || p?.provider_email || "");
  return {
    email,
    name: String(p?.name || p?.provider_name || "").trim(),
    brand: String(p?.brand || p?.provider_brand || "").trim(),
    manager_email: normalizeEmail(p?.manager_email || p?.managerEmail || "")
  };
}

/* ========================= PROVIDERS UI ========================= */
function renderProviders(){
  const list = loadProviders();
  const el = $("providersList");
  if(!el) return;

  if(!list.length){
    el.innerHTML = `<div class="hint">Aucun prestataire enregistr√©.</div>`;
    return;
  }

  el.innerHTML = list.map((p, idx)=>{
    const checked = p.checked ? "checked" : "";
    const sub = [
      p.name ? escHtml(p.name) : "",
      p.brand ? `Marque : ${escHtml(p.brand)}` : "",
      p.manager_email ? `Manager : ${escHtml(p.manager_email)}` : ""
    ].filter(Boolean).join(" ‚Ä¢ ");

    return `
      <div class="providerRow">
        <input type="checkbox" data-idx="${idx}" ${checked}>
        <div class="txt">
          <span class="main">${escHtml(p.email || "-")}</span>
          <span class="sub">${sub || "‚Äî"}</span>
        </div>
        <button class="secondary small" data-remove="${idx}" type="button">Supprimer</button>
      </div>
    `;
  }).join("");

  el.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const idx = Number(cb.dataset.idx);
      list[idx].checked = cb.checked;
      saveProviders(list);
    });
  });

  el.querySelectorAll('button[data-remove]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = Number(btn.dataset.remove);
      list.splice(idx,1);
      saveProviders(list);
      renderProviders();
    });
  });
}

function addProvider(){
  const email = normalizeEmail($("providerEmail").value || "");
  const name = String($("providerName").value || "").trim();
  const brand = String($("providerBrand").value || "").trim();
  const managerEmail = normalizeEmail($("providerManagerEmail").value || "");

  if(!emailLooksValid(email)){
    alert("Email invalide.");
    return;
  }
  if(managerEmail && !emailLooksValid(managerEmail)){
    alert("Email manager invalide.");
    return;
  }

  const list = loadProviders();
  list.push({ email, name, brand, manager_email: managerEmail, checked: true });
  saveProviders(list);

  $("providerEmail").value = "";
  $("providerName").value = "";
  $("providerBrand").value = "";
  $("providerManagerEmail").value = "";

  renderProviders();
}

function importProviders(){
  const text = String($("importArea").value || "");
  if(!text.trim()){ return; }

  const list = loadProviders();
  const lines = text.split("\n").map(l => l.trim()).filter(Boolean);

  lines.forEach(line=>{
    const m = line.match(/(.*)<([^>]+)>/);
    let name = "";
    let email = "";
    if(m){
      name = m[1].trim();
      email = normalizeEmail(m[2].trim());
    }else{
      email = normalizeEmail(line);
    }
    if(emailLooksValid(email)){
      list.push({ email, name, brand: "", manager_email: "", checked: true });
    }
  });

  saveProviders(list);
  $("importArea").value = "";
  renderProviders();
}

function exportProviders(){
  const list = loadProviders().map(p => ({
    email: p.email,
    name: p.name,
    brand: p.brand,
    manager_email: p.manager_email
  }));
  const blob = new Blob([JSON.stringify(list, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "providers.json";
  a.click();
  URL.revokeObjectURL(url);
}

function clearProviders(){
  if(!confirm("Supprimer tous les prestataires ?")) return;
  saveProviders([]);
  renderProviders();
}

function checkAll(value){
  const list = loadProviders();
  list.forEach(p => p.checked = value);
  saveProviders(list);
  renderProviders();
}

/* ========================= REQUEST CREATE ========================= */
function parsePaste(text){
  const lines = String(text || "")
    .split("\n")
    .map(l => l.trim())
    .filter(Boolean);

  const out = {
    client_name: "",
    client_type: "",
    address: "",
    contact_name: "",
    contact_email: "",
    contact_phone: "",
    siret: "",
    vat: ""
  };

  if(!lines.length) return out;

  const firstMeaningful = lines[0];
  out.client_name = firstMeaningful || lines[0];

  lines.forEach((line)=>{
    if(/siret/i.test(line)) out.siret = line.replace(/.*siret[:\s]*/i,"").trim();
    if(/tva/i.test(line)) out.vat = line.replace(/.*tva[:\s]*/i,"").trim();
    if(/@/.test(line)) out.contact_email = line.trim();
    if(/tel|t√©l|phone/i.test(line)) out.contact_phone = line.replace(/.*(?:tel|t√©l|phone)[:\s]*/i,"").trim();
    if(/adresse/i.test(line)) out.address = line.replace(/.*adresse[:\s]*/i,"").trim();
  });

  // heuristique contact name
  const maybeContact = lines.find(l => /contact/i.test(l)) || "";
  out.contact_name = maybeContact.replace(/contact[:\s]*/i,"").trim();

  // type client (PRO vs particulier)
  if(out.siret) out.client_type = "PRO";
  else out.client_type = "Particulier";

  return out;
}

function updatePastePreview(parsed){
  $("previewClientName").textContent = parsed.client_name || "‚Äî";
  $("previewClientType").textContent = parsed.client_type || "‚Äî";
  $("previewAddress").textContent = parsed.address || "‚Äî";
  $("previewContact").textContent = parsed.contact_name || "‚Äî";
  $("previewContactEmail").textContent = parsed.contact_email || "‚Äî";
  $("previewContactPhone").textContent = parsed.contact_phone || "‚Äî";
  $("previewSiret").textContent = parsed.siret || "‚Äî";
  $("previewVat").textContent = parsed.vat || "‚Äî";
}

async function createRequest(){
  const vehicle = String($("vehicle")?.value || "").trim();
  const paste = String($("pasteBlock")?.value || "").trim();
  if(!vehicle || !paste){ alert("V√©hicule + bloc client obligatoires."); return; }

  const parsed = parsePaste(paste);
  if(!parsed.client_name){ alert("Nom client introuvable (1√®re ligne)."); return; }

  const payload = {
    client_name: parsed.client_name,
    client_type: parsed.client_type,
    vehicle,
    address: parsed.address,
    contact_name: parsed.contact_name,
    contact_email: parsed.contact_email,
    contact_phone: parsed.contact_phone,
    siret: parsed.siret,
    vat: parsed.vat,
    raw_block: paste
  };

  $("link").textContent = "Cr√©ation‚Ä¶";

  let res;
  let data;
  try{
    const result = await fetchJson(`${SUPABASE_URL}/rest/v1/requests`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type": "application/json",
        Prefer: "return=representation"
      },
      body: JSON.stringify(payload)
    });
    res = result.res;
    data = result.data;
  }catch(e){
    const message = String(e?.message || e);
    debugLog("create request network error", message);
    $("link").textContent = `‚ùå Erreur r√©seau : ${message}`;
    return;
  }

  if(!res.ok){
    debugLog("create request failed", res.status, data);
    $("link").textContent = `‚ùå Erreur cr√©ation (HTTP ${res.status})`;
    return;
  }

  const created = Array.isArray(data) ? data[0] : data;
  if(!created?.id){
    debugLog("create request response unexpected", data);
    $("link").textContent = "‚ùå Erreur cr√©ation (r√©ponse inattendue)";
    return;
  }

  RID = created.id;
  CODE = randomCode(6);

  await fetchJson(`${SUPABASE_URL}/rest/v1/requests`, {
    method: "PATCH",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ access_code: CODE }),
    // @ts-ignore
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    }
  });

  const link = `${baseUrl()}?rid=${encodeURIComponent(RID)}&code=${encodeURIComponent(CODE)}`;
  $("link").textContent = `‚úÖ Demande cr√©√©e\nClient : ${parsed.client_name}\nLien : ${link}`;

  $("sendBox").style.display = "block";
  $("prescriberReplyBox").style.display = "block";

  await loadThread();
}

async function sendToSelected(){
  const providers = loadProviders().filter(p => p.checked);
  if(!providers.length){ alert("Aucun prestataire s√©lectionn√©."); return; }
  if(!RID || !CODE){ alert("Cr√©e d‚Äôabord une demande."); return; }

  const msg = String($("customMessage").value || "").trim();

  $("sendStatus").textContent = "Envoi en cours‚Ä¶";

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/send-request`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      providers: providers.map(p => ({
        email: p.email,
        name: p.name,
        brand: p.brand,
        manager_email: p.manager_email
      })),
      custom_message: msg
    })
  });

  if(!res.ok){
    debugLog("send-request failed", res.status, data);
    $("sendStatus").textContent = `‚ùå Erreur envoi (HTTP ${res.status})`;
    return;
  }

  $("sendStatus").textContent = `‚úÖ Envoy√© √† ${providers.length} prestataire(s).`;
}

async function uploadFiles(requestId, fileInput){
  const files = fileInput?.files;
  if(!files?.length) return [];

  const formData = new FormData();
  formData.append("request_id", requestId);
  Array.from(files).forEach(f => formData.append("files", f));

  const res = await fetch(`${SUPABASE_URL}/functions/v1/upload`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY
    },
    body: formData
  });

  if(!res.ok){
    throw new Error("Upload failed");
  }

  const data = await res.json();
  return Array.isArray(data?.files) ? data.files : [];
}

/* ========================= THREAD / REPLY ========================= */
function getSeen(mode="prescriber"){
  const key = `seen_${RID}_${mode}`;
  const raw = localStorage.getItem(key);
  return Number(raw || "0");
}

function markSeen(mode="prescriber"){
  const key = `seen_${RID}_${mode}`;
  localStorage.setItem(key, String(Date.now()));
  updateNewBadge(false);
}

function updateNewBadge(show){
  const chip = $("newMsgChip");
  if(chip) chip.style.display = show ? "" : "none";
}

function updateReminderStatus(msg){
  const el = $("reminderStatus");
  if(el) el.textContent = msg;
}

async function scheduleReminder(){
  if(!RID || !CODE) return;
  const enabled = $("autoReminder").checked;
  const days = Number($("reminderDays").value || "3");
  const hour = String($("reminderHour").value || "09:00");

  updateReminderStatus("Enregistrement‚Ä¶");
  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/schedule-reminder`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({ request_id: RID, access_code: CODE, enabled, days, hour })
  });

  if(!res.ok){
    debugLog("schedule-reminder failed", res.status, data);
    updateReminderStatus(`‚ùå Erreur (HTTP ${res.status})`);
    return;
  }
  updateReminderStatus(enabled ? "‚úÖ Relance activ√©e." : "‚úÖ Relance d√©sactiv√©e.");
}

async function prescriberReply(){
  if(!RID || !CODE){
    $("prescStatus").textContent = "‚ùå Dossier non charg√©.";
    return;
  }
  const msg = String($("prescMsg").value || "").trim();
  const fileInput = $("prescFiles");

  if(!msg && (!fileInput?.files?.length)){
    $("prescStatus").textContent = "‚ùå Mets un message ou un fichier.";
    return;
  }

  $("prescStatus").textContent = "Upload fichiers‚Ä¶";
  let files = [];
  try { files = await uploadFiles(RID, fileInput); }
  catch(e){
    $("prescStatus").textContent = "‚ùå Erreur upload fichier.";
    debugLog("upload error", String(e));
    return;
  }

  $("prescStatus").textContent = "Envoi‚Ä¶";
  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/prescriber-reply`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      message: msg || "(Pi√®ce jointe)",
      files
    })
  });

  if(!res.ok){
    debugLog("prescriber-reply failed", res.status, data);
    $("prescStatus").textContent = `‚ùå Erreur envoi (HTTP ${res.status})`;
    return;
  }

  $("prescMsg").value = "";
  $("prescFiles").value = "";
  $("prescStatus").textContent = "‚úÖ Envoy√©";
  await loadThread();
}

async function providerReply(){
  if(!RID || !CODE){
    $("providerReplyStatus").textContent = "‚ùå Dossier non charg√©.";
    return;
  }
  const msg = String($("providerReplyMsg").value || "").trim();
  const fileInput = $("providerReplyFiles");

  if(!msg && (!fileInput?.files?.length)){
    $("providerReplyStatus").textContent = "‚ùå Mets un message ou un fichier.";
    return;
  }

  $("providerReplyStatus").textContent = "Upload fichiers‚Ä¶";
  let files = [];
  try { files = await uploadFiles(RID, fileInput); }
  catch(e){
    $("providerReplyStatus").textContent = "‚ùå Erreur upload fichier.";
    debugLog("upload error", String(e));
    return;
  }

  $("providerReplyStatus").textContent = "Envoi‚Ä¶";
  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/provider-reply`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      provider_email: PROVIDER_EMAIL,
      message: msg || "(Pi√®ce jointe)",
      files
    })
  });

  if(!res.ok){
    debugLog("provider-reply failed", res.status, data);
    $("providerReplyStatus").textContent = `‚ùå Erreur envoi (HTTP ${res.status})`;
    return;
  }

  $("providerReplyMsg").value = "";
  $("providerReplyFiles").value = "";
  $("providerReplyStatus").textContent = "‚úÖ Envoy√©";
  await loadThread();
}

/* ========================= RENDER FILES ========================= */
function isImageUrl(url){
  const u = String(url || "").toLowerCase();
  return u.endsWith(".png") || u.endsWith(".jpg") || u.endsWith(".jpeg") || u.endsWith(".webp") || u.includes("image/");
}

function normalizeFiles(raw){
  if(!raw) return [];
  if(Array.isArray(raw)) return raw.filter(Boolean);

  if(typeof raw === "string"){
    try{
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed.filter(Boolean) : [];
    }catch{
      return [raw];
    }
  }

  if(typeof raw === "object"){
    if(Array.isArray(raw.files)) return raw.files;
    return [];
  }

  return [];
}

function resolveFileUrl(file){
  if(typeof file === "string") return file.trim();
  const raw =
    file?.url ||
    file?.publicUrl ||
    file?.public_url ||
    file?.signedUrl ||
    file?.signed_url ||
    file?.download_url ||
    file?.file_path ||
    file?.filepath ||
    file?.path ||
    file?.storage_path ||
    "";
  const url = String(raw || "").trim();
  if(!url) return "";
  if(/^https?:\/\//i.test(url)) return url;
  if(url.startsWith("/")){
    return `${SUPABASE_URL}${url}`;
  }
  if(url.startsWith("attachments/")){
    return `${SUPABASE_URL}/storage/v1/object/public/${url}`;
  }
  return `${SUPABASE_URL}/storage/v1/object/public/attachments/${url}`;
}

function renderMessageFiles(rawFiles){
  const files = normalizeFiles(rawFiles);
  if(!files.length) return "";

  return files.map(f => {
    const name = escHtml((typeof f === "string" ? f.split("/").pop() : f?.name) || "fichier");
    const url = resolveFileUrl(f);

    if(!url){
      return `<div class="hint">üìé ${name} (lien indisponible)</div>`;
    }

    const link = `
      <div>
        <a class="file" href="${url}" target="_blank" rel="noopener" download>üìé T√©l√©charger : ${name}</a>
      </div>
    `;

    const preview = isImageUrl(url)
      ? `<img class="thumb" src="${url}" alt="${name}">`
      : "";

    return link + preview;
  }).join("");
}

function formatAddress(r){
  const addr = String(r.address || "").trim();
  const postcode = String(r.postcode || "").trim();
  const city = String(r.city || "").trim();
  const country = String(r.country || "").trim();
  const addrHasFrance = /france/i.test(addr);
  const parts = [];
  if(addr) parts.push(addr);
  if(postcode || city) parts.push([postcode, city].filter(Boolean).join(" "));
  if(country && !addrHasFrance) parts.push(country);
  return parts.join(" ").replace(/\s+/g," ").trim();
}

function formatThreadForClient(responses){
  if(!Array.isArray(responses) || !responses.length) return "";
  return responses.map((x)=>{
    const who = x.responder_email ? String(x.responder_email) : "MF Auto Sud";
    const when = x.created_at ? new Date(x.created_at).toLocaleString("fr-FR") : "";
    const msg = String(x.message || "");
    return `[${when}] ${who} :\n${msg}\n`;
  }).join("\n");
}

function formatClientSummary(r){
  if(!r) return "";
  const lines = [];
  const clientName = String(r.client_name || "").trim();
  const vehicle = String(r.vehicle || "").trim();
  const address = formatAddress(r);
  const contactName = String(r.contact_name || "").trim();
  const contactEmail = String(r.contact_email || "").trim();
  const contactPhone = String(r.contact_phone || "").trim();
  const siret = String(r.siret || "").trim();
  const vat = String(r.vat || "").trim();

  if(clientName) lines.push(`Client : ${clientName}`);
  if(vehicle) lines.push(`V√©hicule : ${vehicle}`);
  if(address) lines.push(`Adresse : ${address}`);
  if(contactName) lines.push(`Contact : ${contactName}`);
  if(contactEmail) lines.push(`Email contact : ${contactEmail}`);
  if(contactPhone) lines.push(`T√©l√©phone : ${contactPhone}`);
  if(siret) lines.push(`SIRET : ${siret}`);
  if(vat) lines.push(`TVA : ${vat}`);

  if(!lines.length) return "";
  return `\nDossier :\n${lines.map((line)=>`- ${line}`).join("\n")}\n`;
}

function sendToClientEmail(){
  if(!REQUEST_DATA){
    alert("Charge d‚Äôabord un dossier.");
    return;
  }
  const clientEmail = String(REQUEST_DATA.contact_email || "").trim();
  if(!clientEmail){
    alert("Email client introuvable.");
    return;
  }
  const subject = `Offre MF Auto Sud ‚Äì ${REQUEST_DATA.client_name || "Client"}`;
  const intro = `Bonjour ${REQUEST_DATA.client_name || ""},\n\nVoici les informations concernant votre demande :\n`;
  const summary = formatClientSummary(REQUEST_DATA);
  const thread = formatThreadForClient(THREAD_CACHE);
  const threadSection = thread ? `\n√âchanges :\n${thread}` : "\n√âchanges :\nAucun √©change pour le moment.\n";
  const body = `${intro}${summary}${threadSection}\nCordialement,\nMF Auto Sud`;
  const mailto = `mailto:${encodeURIComponent(clientEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailto;
}

async function loadThread(){
  if(!RID || !CODE) return;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/get-thread`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ request_id: RID, access_code: CODE })
  });

  const target = $("thread") || $("threadProvider");
  if(!res.ok){
    debugLog("get-thread failed", res.status, data);
    if(target) target.innerHTML = `<div class="hint">‚ùå Erreur chargement conversation (HTTP ${res.status})</div>`;
    return;
  }

  const responses = Array.isArray(data?.responses) ? data.responses : [];
  THREAD_CACHE = responses;
  REQUEST_DATA = data?.request || null;
  const latest = responses.length ? new Date(responses[responses.length-1].created_at).getTime() : 0;

  const providerVisible = $("providerUI") && $("providerUI").style.display !== "none";
  const mode = providerVisible ? "provider" : "prescriber";
  const seen = getSeen(mode);
  updateNewBadge(latest > seen);

  if($("thread")){
    const el = $("thread");
    el.innerHTML = "";
    responses.forEach(x=>{
      const isProvider = !!x.responder_email;
      const sender = isProvider ? (x.responder_email || "Prestataire") : "MF Auto Sud";
      const isYou = !isProvider;

      const style = bubbleStyleForSender(String(x.responder_email || "mf"), isYou);

      el.innerHTML += `
        <div class="msg">
          <div class="msgRow ${isYou ? "you" : "them"}">
            <div class="bubble" style="${style}">
              <div class="bubbleHead">
                <div class="bubbleWho">${escHtml(sender)}</div>
                <div class="bubbleMeta">${new Date(x.created_at).toLocaleString("fr-FR")}</div>
              </div>
              <div class="bubbleBody">
                ${escHtml(x.message || "").replaceAll("\n","<br>")}
                ${renderMessageFiles(x.files)}
              </div>
            </div>
          </div>
        </div>
      `;
    });
  }

  if($("threadProvider")){
    const el = $("threadProvider");
    el.innerHTML = "";
    responses.forEach(x=>{
      const senderEmail = String(x.responder_email || "mf");
      const isYou = PROVIDER_EMAIL && (senderEmail.toLowerCase() === PROVIDER_EMAIL);

      const senderLabel = isYou ? "Vous" : "MF Auto Sud";
      const style = bubbleStyleForSender(senderEmail, isYou);

      el.innerHTML += `
        <div class="msg">
          <div class="msgRow ${isYou ? "you" : "them"}">
            <div class="bubble" style="${style}">
              <div class="bubbleHead">
                <div class="bubbleWho">${escHtml(senderLabel)}</div>
                <div class="bubbleMeta">${new Date(x.created_at).toLocaleString("fr-FR")}</div>
              </div>
              <div class="bubbleBody">
                ${escHtml(x.message || "").replaceAll("\n","<br>")}
                ${renderMessageFiles(x.files)}
              </div>
            </div>
          </div>
        </div>
      `;
    });
  }

  if($("requestInfo") && data.request){
    const r = data.request;
    const addrLine = formatAddress(r);

    $("requestInfo").innerHTML = `
      <div class="card">
        <div class="gridInfo">
          <div class="kv"><b>Client</b><div>${escHtml(r.client_name || "-")}</div></div>
          <div class="kv"><b>Type client</b><div>${escHtml(r.client_type || (r.siret ? "PRO" : "Particulier"))}</div></div>
          <div class="kv"><b>V√©hicule</b><div>${escHtml(r.vehicle || "-")}</div></div>

          <div class="kv"><b>Adresse</b><div>${escHtml(addrLine || "-")}</div></div>
          <div class="kv"><b>Contact</b><div>${escHtml(r.contact_name || "-")}</div></div>

          <div class="kv"><b>E-mail</b><div>${escHtml(r.contact_email || "-")}</div></div>
          <div class="kv"><b>T√©l√©phone</b><div>${escHtml(r.contact_phone || "-")}</div></div>

          <div class="kv"><b>SIRET</b><div>${escHtml(r.siret || "-")}</div></div>
          <div class="kv"><b>TVA</b><div>${escHtml(r.vat || "-")}</div></div>

          <div class="kv"><b>Assign√© √†</b><div>${escHtml(r.assigned_to_email || "-")}</div></div>
        </div>
      </div>
    `;
  }
}

/* ========================= INIT ========================= */
(async function init(){
  const { rid, code, pe, debug } = getAllParams();
  DEBUG_ON = String(debug) === "1";
  debugShow(DEBUG_ON);
  if($("debugClearBtn")) $("debugClearBtn").addEventListener("click", debugClear);

  // binds prescriber
  $("createBtn")?.addEventListener("click", createRequest);
  $("copyLinkBtn")?.addEventListener("click", copyThreadLink);
  $("copyLinkBtn2")?.addEventListener("click", copyThreadLink);
  $("copyLinkBtn3")?.addEventListener("click", copyThreadLink);

  $("addProviderBtn")?.addEventListener("click", addProvider);
  $("importProvidersBtn")?.addEventListener("click", importProviders);
  $("checkAllBtn")?.addEventListener("click", ()=>checkAll(true));
  $("uncheckAllBtn")?.addEventListener("click", ()=>checkAll(false));
  $("exportProvidersBtn")?.addEventListener("click", exportProviders);
  $("clearProvidersBtn")?.addEventListener("click", clearProviders);
  $("sendBtn")?.addEventListener("click", sendToSelected);

  $("refreshThreadBtn")?.addEventListener("click", loadThread);
  $("markReadBtn")?.addEventListener("click", ()=>markSeen("prescriber"));
  $("sendClientBtn")?.addEventListener("click", sendToClientEmail);

  $("prescReplyBtn")?.addEventListener("click", prescriberReply);

  $("pasteBlock")?.addEventListener("input", ()=>{
    const text = String($("pasteBlock")?.value || "").trim();
    if(!text){
      updatePastePreview({});
      return;
    }
    const parsed = parsePaste(text);
    updatePastePreview(parsed);
  });

  // binds provider
  $("refreshThreadProviderBtn")?.addEventListener("click", loadThread);
  $("markReadProviderBtn")?.addEventListener("click", ()=>markSeen("provider"));
  $("providerReplyBtn")?.addEventListener("click", providerReply);

  renderProviders();

  if (rid && code && pe && String(pe).trim()) {
    RID = String(rid);
    CODE = String(code);
    PROVIDER_EMAIL = decodeURIComponent(String(pe)).trim().toLowerCase();

    $("prescriberUI").style.display = "none";
    $("providerUI").style.display = "block";

    await loadThread();
    return;
  }

  if (rid && code) {
    RID = String(rid);
    CODE = String(code);

    $("prescriberUI").style.display = "block";
    $("providerUI").style.display = "none";

    $("sendBox").style.display = "block";
    $("prescriberReplyBox").style.display = "block";

    renderProviders();
    await loadThread();
    return;
  }

  $("prescriberUI").style.display = "block";
  $("providerUI").style.display = "none";
  $("sendBox").style.display = "none";
  $("prescriberReplyBox").style.display = "none";
})();
</script>

</body>
</html>
