<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Plateforme prescripteur ‚Äì MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="./assets/logo-mfautosud.png">

  <style>
    :root{
      --bg:#0b1220; --panel:#111c34; --panel2:#0f1a32;
      --text:#ffffff; --muted:rgba(255,255,255,.75); --line:rgba(255,255,255,.10);
      --brand:#4da3ff; --brand2:#2563eb;
      --btn:#4da3ff; --btnText:#001; --btn2:#334155;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 10px 24px rgba(0,0,0,.22);
      --fieldBg: rgba(11,18,32,.85); --fieldBorder: rgba(255,255,255,.14); --fieldFocus: rgba(77,163,255,.55);
      --chipBg: rgba(77,163,255,.12); --chipBorder: rgba(77,163,255,.25); --chipText: #cfe6ff;
      --link: #7cc0ff;
      --rowBg: rgba(11,18,32,.60); --rowBorder: rgba(255,255,255,.08);
      --msgBg: rgba(11,18,32,.75); --cardBg: rgba(11,18,32,.65); --kvBg: rgba(17,28,52,.55);
      --topbarBg: rgba(17,28,52,.85); --topbarBorder: rgba(255,255,255,.08);
      --fileBg: #334155; --fileBorder: rgba(255,255,255,.10);
      --divider: rgba(255,255,255,.10);
    }

    [data-theme="light"]{
      --bg:#f6f8fc; --panel:#ffffff; --panel2:#ffffff;
      --text:#0b1220; --muted:rgba(15,23,42,.72); --line:rgba(15,23,42,.12);
      --brand:#2563eb; --brand2:#1d4ed8;
      --btn:#2563eb; --btnText:#ffffff; --btn2:#e2e8f0;
      --shadow: 0 10px 24px rgba(2,6,23,.08);
      --fieldBg: rgba(255,255,255,.95); --fieldBorder: rgba(15,23,42,.14); --fieldFocus: rgba(37,99,235,.45);
      --chipBg: rgba(37,99,235,.10); --chipBorder: rgba(37,99,235,.22); --chipText: rgba(15,23,42,.85);
      --link: #2563eb;
      --rowBg: rgba(2,6,23,.03); --rowBorder: rgba(2,6,23,.08);
      --msgBg: rgba(2,6,23,.03); --cardBg: rgba(2,6,23,.02); --kvBg: rgba(2,6,23,.03);
      --topbarBg: rgba(255,255,255,.85); --topbarBorder: rgba(2,6,23,.10);
      --fileBg: rgba(2,6,23,.06); --fileBorder: rgba(2,6,23,.10);
      --divider: rgba(2,6,23,.10);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial, sans-serif; color:var(--text); padding:24px;
      background:
        radial-gradient(1100px 460px at 10% -10%, rgba(77,163,255,.22), transparent 60%),
        radial-gradient(900px 380px at 90% 0%, rgba(37,99,235,.18), transparent 60%),
        var(--bg);
    }
    [data-theme="light"] body{
      background:
        radial-gradient(1100px 460px at 10% -10%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(900px 380px at 90% 0%, rgba(77,163,255,.08), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1100px;margin:0 auto}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-radius:16px;
      background: var(--topbarBg); border:1px solid var(--topbarBorder);
      backdrop-filter: blur(6px); margin-bottom:16px; box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0;}
    .brandLogo{
      width:44px;height:44px;border-radius:12px; background:var(--panel2); border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center; padding:6px; flex:0 0 auto;
    }
    .brandLogo img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .brandTitle h1{font-size:18px;margin:0;color:var(--brand);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .brandTitle .sub{margin:2px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .topbarRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .chip{
      font-size:12px; padding:6px 10px;border-radius:999px;
      background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--chipText);
      white-space:nowrap;
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}

    .box{
      background: linear-gradient(180deg, rgba(17,28,52,.95), rgba(15,26,50,.95));
      border:1px solid rgba(255,255,255,.08);
      padding:16px; border-radius:16px; margin-bottom:14px; box-shadow: var(--shadow);
    }
    [data-theme="light"] .box{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
      border:1px solid rgba(2,6,23,.10);
    }
    h2{margin:0 0 10px;font-size:16px}
    h3{margin:8px 0 8px;font-size:14px}
    label{display:block;margin-top:10px;font-size:13px;color:var(--muted)}
    input,textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--fieldBorder); background:var(--fieldBg); color:var(--text); outline:none;
    }
    input:focus,textarea:focus{border-color:var(--fieldFocus); box-shadow:0 0 0 4px rgba(77,163,255,.12)}
    [data-theme="light"] input:focus,[data-theme="light"] textarea:focus{box-shadow:0 0 0 4px rgba(37,99,235,.12)}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    button{
      padding:10px 12px; border-radius:12px; border:0;
      background:var(--btn); color:var(--btnText); font-weight:800; cursor:pointer;
      transition:.12s transform ease, .12s opacity ease;
    }
    button:hover{transform: translateY(-1px)}
    button:active{transform: translateY(0px); opacity:.92}
    button.secondary{
      background:var(--btn2); color: var(--text); font-weight:700; border:1px solid var(--line);
    }
    [data-theme="light"] button.secondary{color:#0b1220;border:1px solid rgba(2,6,23,.10)}
    button.small{padding:8px 10px;border-radius:12px;margin-top:0}

    .hint{opacity:.86;font-size:12px;margin-top:8px;white-space:pre-wrap;line-height:1.35;color:var(--muted)}
    .divider{height:1px;background:var(--divider);margin:14px 0}
    a{color:var(--link)}

    .providerRow{
      display:flex;align-items:flex-start;gap:10px;
      padding:10px 10px;border-radius:14px;
      background:var(--rowBg);
      border:1px solid var(--rowBorder);
      margin:8px 0;
    }
    .providerRow input{margin-top:3px}
    .providerRow .txt{flex:1; min-width:0}
    .providerRow .main{
      display:block; font-size:13px; font-weight:800; color:var(--text);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .providerRow .sub{
      display:block; margin-top:2px; font-size:12px; font-weight:600; color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .msg{background:var(--msgBg); padding:12px; border-radius:14px; margin-top:10px; border:1px solid var(--rowBorder)}
    .msg.you{border-left:4px solid var(--brand)}
    .msg.them{border-left:4px solid var(--ok)}
    .msgHead{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .msgMeta{font-size:12px;opacity:.75;color:var(--muted)}
    .msgWho{font-weight:800}
    .msgBody{margin-top:8px;line-height:1.45;font-size:13px}
    .file{
      display:inline-block; margin-top:8px; padding:8px 10px; border-radius:12px;
      background:var(--fileBg); color:var(--text); text-decoration:none; border:1px solid var(--fileBorder);
    }

    .card{background:var(--cardBg); border:1px solid var(--rowBorder); border-radius:16px; padding:14px;}
    .gridInfo{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.gridInfo{grid-template-columns:1fr}}
    .kv{padding:10px 10px;border-radius:14px;background:var(--kvBg);border:1px solid var(--rowBorder);}
    .kv b{display:block;font-size:12px;opacity:.8;margin-bottom:4px}
    .kv div{font-size:13px;word-break:break-word}

    .tag{
      display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px;
      border:1px solid var(--line); background:var(--rowBg); color:var(--text);
    }
    .tag.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10)}
    .checkline{display:flex;align-items:center;gap:8px;margin-top:0;color:var(--muted)}
    .checkline input{width:auto}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="brandLogo">
        <img src="./assets/logo-mfautosud.png" alt="MF Auto Sud">
      </div>
      <div class="brandTitle">
        <h1>Plateforme prescripteur ‚Äì MF Auto Sud</h1>
        <div class="sub">Demandes ‚Ä¢ R√©ponses ‚Ä¢ Pi√®ces jointes ‚Ä¢ Transferts ‚Ä¢ Relances automatiques</div>
      </div>
    </div>

    <div class="topbarRight">
      <div class="chip" id="modeChip">Mode : Prescripteur</div>
      <button class="secondary" id="themeBtn" style="white-space:nowrap">üåô Mode sombre</button>
    </div>
  </div>

  <!-- =========================
       PRESCRIPTEUR UI
  ========================= -->
  <div id="prescriberUI">

    <!-- ADMIN -->
    <div class="box" id="adminBox" style="display:none;">
      <h2>Admin ‚Äî Prestataires & r√¥les</h2>
      <div class="hint" id="adminHint">Admin d√©sactiv√©.</div>

      <div class="divider"></div>

      <h3>Ajouter / mettre √† jour</h3>
      <div class="grid2">
        <div>
          <label>E-mail</label>
          <input id="adminEmail" placeholder="ex: chef@concession.com">
        </div>
        <div>
          <label>Nom (optionnel)</label>
          <input id="adminName" placeholder="ex: Concession X">
        </div>
      </div>

      <div class="row">
        <label class="checkline"><input type="checkbox" id="adminIsManager"> Chef des ventes</label>
        <label class="checkline"><input type="checkbox" id="adminIsVendor"> Vendeur</label>
        <button id="adminSave">Enregistrer</button>
        <button class="secondary" id="adminRefresh">Rafra√Æchir</button>
      </div>

      <div class="divider"></div>

      <h3>Liste</h3>
      <div id="adminList" class="hint">‚Äî</div>

      <div class="divider"></div>

      <h3>Chefs des ventes ‚Üí Vendeurs (gestion √©quipe)</h3>
      <div class="hint">Ici tu pourras voir les √©quipes et ajouter/supprimer des vendeurs (n√©cessite fonctions admin-manager-vendor-list + admin-vendor-upsert/delete).</div>
      <div id="teamBox" class="hint">‚Äî</div>
    </div>

    <div class="box">
      <h2>1) Cr√©er une demande</h2>

      <div class="grid2">
        <div>
          <label>V√©hicule</label>
          <input id="vehicle" placeholder="Ex. : Ford Puma LLD 25 mois ‚Äì 30 000 km ‚Äì entretien inclus">
        </div>

        <div>
          <label>Lien de la demande</label>
          <div class="row" style="margin-top:10px">
            <button class="secondary" id="copyLinkBtn">Copier le lien</button>
          </div>
          <div class="hint">Disponible apr√®s cr√©ation (rid + code).</div>
        </div>
      </div>

      <label>Bloc client (copier-coller) ‚Äî 1 ≥·µâ ligne = nom du client</label>
      <textarea id="pasteBlock" style="height:180px" placeholder="Colle ici le bloc complet‚Ä¶"></textarea>

      <div class="hint">
La 1 ≥·µâ ligne devient automatiquement le nom du client.
Lignes supprim√©es automatiquement :
- ¬´ Obtenir un lien √† envoyer au client pour signer un mandat de pr√©l√®vement SEPA ¬ª
- ¬´ Responsable MF Autosud ¬ª
- variantes ¬´ pr√©l√®vement / prelevement ¬ª
      </div>

      <div class="row">
        <button id="createBtn">Cr√©er la demande</button>
      </div>

      <div id="link" class="hint"></div>
    </div>

    <div class="box" id="sendBox" style="display:none;">
      <h2>2) Envoyer √† des prestataires</h2>

      <div class="row">
        <button class="secondary" id="checkAllBtn">Tout cocher</button>
        <button class="secondary" id="uncheckAllBtn">Tout d√©cocher</button>
        <button class="secondary" id="exportProvidersBtn">Exporter</button>
        <button class="secondary" id="clearProvidersBtn">Tout effacer</button>
      </div>

      <div id="providersList" style="margin-top:10px"></div>

      <div class="divider"></div>

      <h3>Ajouter / importer</h3>

      <div class="grid2">
        <div>
          <label>E-mail du prestataire</label>
          <input id="providerEmail" placeholder="exemple@domaine.com">
        </div>
        <div>
          <label>Nom (optionnel)</label>
          <input id="providerName" placeholder="Ex. : Groupe Grim">
        </div>
      </div>

      <div class="row">
        <label class="checkline"><input type="checkbox" id="providerIsManager"> Chef des ventes</label>
        <label class="checkline"><input type="checkbox" id="providerIsVendor"> Vendeur</label>
      </div>

      <div class="row">
        <button id="addProviderBtn">Ajouter au r√©pertoire</button>
      </div>

      <label>Importer une liste (1 par ligne : Nom &lt;email&gt; ou email)</label>
      <textarea id="importArea" style="height:110px" placeholder="Ex. : Nom <email@domaine.com>"></textarea>
      <div class="row">
        <button class="secondary" id="importProvidersBtn">Importer</button>
      </div>

      <label>Message (optionnel) inclus dans l‚Äôe-mail</label>
      <textarea id="customMessage" style="height:90px" placeholder="Texte optionnel‚Ä¶"></textarea>

      <div class="row">
        <button id="sendBtn">‚úÖ Envoyer automatiquement</button>
        <button class="secondary" id="copyLinkBtn2">Copier le lien</button>
      </div>

      <div id="sendStatus" class="hint"></div>
    </div>

    <div class="box">
      <h2>3) Conversation</h2>
      <div class="row">
        <button class="secondary" id="refreshThreadBtn">üîÑ Rafra√Æchir</button>
        <button class="secondary" id="copyLinkBtn3">Copier le lien</button>
      </div>
      <div id="thread" style="margin-top:10px"></div>
    </div>

    <div class="box" id="prescriberReplyBox" style="display:none;">
      <h2>4) R√©pondre (MF Auto Sud)</h2>

      <label>Message</label>
      <textarea id="prescMsg" style="height:120px" placeholder="Votre message‚Ä¶"></textarea>

      <label>Documents (PDF, images‚Ä¶)</label>
      <input type="file" id="prescFiles" multiple>

      <button id="prescReplyBtn">Envoyer la r√©ponse</button>
      <div id="prescStatus" class="hint"></div>
    </div>
  </div>

  <!-- =========================
       PRESTATAIRE UI
  ========================= -->
  <div id="providerUI" style="display:none;">
    <div class="box">
      <h2>Demande re√ßue <span class="tag">Prestataire</span></h2>
      <div id="requestInfo" class="hint">Chargement‚Ä¶</div>
    </div>

    <!-- ‚úÖ NOUVEAU : box attribution (visible seulement si chef des ventes) -->
    <div class="box" id="assignBox" style="display:none;">
      <h2>Chef des ventes ‚Äî Attribuer √† un vendeur</h2>
      <div class="hint" id="assignHint">Chargement‚Ä¶</div>
      <div id="assignList" style="margin-top:10px"></div>
      <div class="row">
        <button class="secondary" id="assignBtn">Attribuer</button>
      </div>
      <div class="hint" id="assignStatus"></div>
    </div>

    <div class="box">
      <h2>Conversation</h2>
      <div class="row">
        <button class="secondary" id="refreshThreadProviderBtn">üîÑ Rafra√Æchir</button>
      </div>
      <div id="threadProvider" style="margin-top:10px"></div>
    </div>

    <!-- ‚úÖ vendorBox branch√© (visible seulement si chef des ventes) -->
    <div class="box" id="vendorBox" style="display:none;">
      <h2>R√©pertoire vendeurs (Chef des ventes)</h2>
      <div class="hint" id="vendorRoleHint">Chargement‚Ä¶</div>

      <div class="row">
        <button class="secondary" id="vendorCheckAllBtn">Tout cocher</button>
        <button class="secondary" id="vendorUncheckAllBtn">Tout d√©cocher</button>
        <button class="secondary" id="vendorExportBtn">Exporter</button>
        <button class="secondary" id="vendorClearBtn">Tout effacer</button>
      </div>

      <div id="vendorList" style="margin-top:10px"></div>

      <div class="divider"></div>

      <h3>Ajouter / importer des vendeurs</h3>

      <div class="grid2">
        <div>
          <label>E-mail vendeur</label>
          <input id="vendorEmail" placeholder="vendeur@domaine.com">
        </div>
        <div>
          <label>Nom (optionnel)</label>
          <input id="vendorName" placeholder="Ex. : Jean Dupont">
        </div>
      </div>

      <div class="row">
        <button id="vendorAddBtn">Ajouter</button>
      </div>

      <label>Importer une liste (1 par ligne : Nom &lt;email&gt; ou email)</label>
      <textarea id="vendorImport" style="height:110px" placeholder="Ex. : Jean Dupont <vendeur@domaine.com>"></textarea>
      <div class="row">
        <button class="secondary" id="vendorImportBtn">Importer</button>
      </div>
    </div>

    <div class="box">
      <h2>R√©pondre</h2>

      <label>Votre message</label>
      <textarea id="respMsg" style="height:120px" placeholder="Texte d‚Äôaccompagnement‚Ä¶"></textarea>

      <label>Documents (PDF, images‚Ä¶)</label>
      <input type="file" id="respFiles" multiple>

      <button id="providerReplyBtn">Envoyer la r√©ponse</button>
      <div id="respStatus" class="hint"></div>
    </div>
  </div>

</div>

<script>
/* =========================
   CONFIG
========================= */
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1YmhzamtzdGJycWx2bXlsb2J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDE1NzQsImV4cCI6MjA4NDk3NzU3NH0.tANS4zo9wvLsWJS48Hyw6thttQX0yhBjOKI1aY4FTCo";
const PRESCRIBER_EMAIL = "courtier@mfautosud.fr";
const PROVIDERS_KEY = "mfautosud_providers_v2";

/* ‚úÖ optionnel: admin sans URL sp√©ciale */
const DEFAULT_ADMIN_TOKEN = ""; // ex: "mfautosud_admin_2026_9F3kL8pXqZ"

/* =========================
   THEME
========================= */
const THEME_KEY = "mfautosud_theme";
function applyTheme(theme){
  const t = (theme === "light") ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem(THEME_KEY, t);
  const btn = document.getElementById("themeBtn");
  if(btn) btn.textContent = (t === "light") ? "‚òÄÔ∏è Mode clair" : "üåô Mode sombre";
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(cur === "dark" ? "light" : "dark");
}
(function(){
  const saved = localStorage.getItem(THEME_KEY) || "dark";
  applyTheme(saved);
  document.getElementById("themeBtn").addEventListener("click", toggleTheme);
})();

/* =========================
   STATE
========================= */
let RID = "";
let CODE = "";
let PROVIDER_EMAIL = "";
let ADMIN_TOKEN = "";
let VENDOR_IS_MANAGER = false;

/* =========================
   UTILS
========================= */
function $(id){ return document.getElementById(id); }
function escHtml(s){
  return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function normalizeEmail(email){ return (email || "").trim().toLowerCase(); }
function emailLooksValid(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||"").trim().toLowerCase()); }
function setModeChip(txt){ const c=$("modeChip"); if(c) c.textContent = "Mode : " + txt; }
function baseUrl(){ return window.location.origin + window.location.pathname; }
function randomCode(){
  const a = crypto.getRandomValues(new Uint8Array(16));
  return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("");
}
function getAllParams(){
  const url = new URL(window.location.href);
  const qs = url.searchParams;
  const hs = new URLSearchParams(window.location.hash.replace("#",""));

  const rid   = qs.get("rid")   || hs.get("rid");
  const code  = qs.get("code")  || hs.get("code");
  const pe    = qs.get("pe")    || hs.get("pe");
  const admin = qs.get("admin") || hs.get("admin");
  const token = qs.get("token") || hs.get("token");

  return { rid, code, pe, admin, token };
}
async function fetchJson(url, options){
  const res = await fetch(url, options);
  let data = null;
  try { data = await res.json(); } catch {}
  return { res, data };
}

function showVendorBox(show){
  const box = $("vendorBox");
  if(box) box.style.display = show ? "" : "none";
}
function showAssignBox(show){
  const box = $("assignBox");
  if(box) box.style.display = show ? "" : "none";
}

/* =========================
   PROVIDERS localStorage
========================= */
function loadProviders(){
  try{
    const raw = localStorage.getItem(PROVIDERS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveProviders(arr){ localStorage.setItem(PROVIDERS_KEY, JSON.stringify(arr)); }

function renderProviders(){
  const listEl = $("providersList");
  if(!listEl) return;

  const providers = loadProviders();
  if(!providers.length){
    listEl.innerHTML = `<div class="hint">Aucun prestataire enregistr√©.</div>`;
    return;
  }

  listEl.innerHTML = providers.map((p, idx) => {
    const email = normalizeEmail(p.email || p.provider_email || "");
    const name  = String(p.name || p.provider_name || "").trim();
    const tags = [
      p.is_sales_manager ? "Chef des ventes" : "",
      p.is_vendor ? "Vendeur" : ""
    ].filter(Boolean).join(" ‚Ä¢ ");

    return `
      <div class="providerRow">
        <input type="checkbox" class="providerCheck" data-email="${escHtml(email)}">
        <div class="txt">
          <span class="main">${escHtml(email || "(email manquant)")}</span>
          ${name ? `<span class="sub">${escHtml(name)}</span>` : ""}
          ${tags ? `<span class="sub">${escHtml(tags)}</span>` : ""}
        </div>
        <button class="small secondary" onclick="removeProvider(${idx})">Suppr.</button>
      </div>
    `;
  }).join("");
}

function removeProvider(index){
  const providers = loadProviders();
  providers.splice(index, 1);
  saveProviders(providers);
  renderProviders();
}

async function addProvider(){
  const email = normalizeEmail($("providerEmail").value);
  const name = ($("providerName").value || "").trim();
  const is_sales_manager = !!($("providerIsManager") && $("providerIsManager").checked);
  const is_vendor = !!($("providerIsVendor") && $("providerIsVendor").checked);

  if(!email){ alert("Saisis un e-mail."); return; }
  if(!emailLooksValid(email)){ alert("E-mail invalide."); return; }

  const providers = loadProviders();
  if(providers.some(p => normalizeEmail(p.email || p.provider_email) === email)){
    alert("D√©j√† enregistr√©."); return;
  }

  providers.push({ name, email, is_sales_manager, is_vendor });
  saveProviders(providers);

  // push en base si admin actif
  if(ADMIN_TOKEN){
    await fetchJson(`${SUPABASE_URL}/functions/v1/admin-provider-upsert`, {
      method:"POST",
      headers:{
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type":"application/json",
        "x-admin-token": ADMIN_TOKEN
      },
      body: JSON.stringify({
        provider_email: email,
        provider_name: name || null,
        is_sales_manager,
        is_vendor
      })
    });
  }

  $("providerEmail").value = "";
  $("providerName").value = "";
  if($("providerIsManager")) $("providerIsManager").checked = false;
  if($("providerIsVendor")) $("providerIsVendor").checked = false;

  renderProviders();
}

function checkAll(on){ document.querySelectorAll(".providerCheck").forEach(c=>c.checked=!!on); }

async function exportProviders(){
  const providers = loadProviders();
  const lines = providers.map(p => {
    const email = normalizeEmail(p.email || p.provider_email || "");
    const name = String(p.name || p.provider_name || "").trim();
    return name ? `${name} <${email}>` : email;
  }).join("\n");
  await navigator.clipboard.writeText(lines || "");
  alert("Liste copi√©e dans le presse-papiers.");
}

function clearProviders(){
  if(!confirm("Supprimer tous les prestataires enregistr√©s sur cet ordinateur ?")) return;
  saveProviders([]);
  renderProviders();
}

function extractEmailAndName(line){
  const s = (line || "").trim();
  if(!s) return null;
  const m = s.match(/^(.*)<\s*([^>]+)\s*>$/);
  if(m){
    const name = m[1].replace(/^['"]|['"]$/g,"").trim();
    const email = (m[2] || "").trim().toLowerCase();
    return { name, email };
  }
  const only = s.replace(/^['"]|['"]$/g,"").trim().toLowerCase();
  if(emailLooksValid(only)) return { name:"", email: only };
  const em = s.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
  if(em) return { name:"", email: em[0].toLowerCase() };
  return null;
}

function importProviders(){
  const raw = ($("importArea").value || "").replace(/\r/g,"").trim();
  if(!raw){ alert("Colle une liste."); return; }

  const lines = raw.split("\n").map(x=>x.trim()).filter(Boolean);
  const providers = loadProviders();
  const existing = new Set(providers.map(p => normalizeEmail(p.email || p.provider_email)));

  let added=0, ignored=0;
  for(const line of lines){
    const parsed = extractEmailAndName(line);
    if(!parsed || !emailLooksValid(parsed.email)){ ignored++; continue; }
    if(existing.has(parsed.email)){ ignored++; continue; }
    providers.push({ name: parsed.name || "", email: parsed.email, is_sales_manager:false, is_vendor:false });
    existing.add(parsed.email);
    added++;
  }

  saveProviders(providers);
  renderProviders();
  alert(`Import termin√© : +${added} ajout√©s / ${ignored} ignor√©s`);
}

/* =========================
   PARSE COPY-PASTE (corrig√©)
========================= */
function parsePaste(text){
  const t = (text || "").replace(/\r/g, "").trim();
  const lines = t.split("\n").map(l => l.trim()).filter(Boolean);

  const out = {
    client_name:"",
    address:"",
    postcode:"",
    city:"",
    country:"",
    siret:"",
    vat:"",
    contact_name:"",
    contact_email:"",
    contact_phone:""
  };
  if (!lines.length) return out;

  out.client_name = lines[0];

  const isUselessLine = (l) => {
    const x = l.toLowerCase();
    return (
      x.includes("obtenir un lien") ||
      x.includes("mandat de pr√©l√®vement sepa") ||
      x.includes("mandat de prelevement sepa") ||
      x.includes("prelevement sepa") ||
      x.includes("pr√©l√®vement sepa") ||
      x.includes("responsable mf autosud") ||
      x === "responsable" ||
      x === "mf autosud" ||
      x === "client" ||
      x === "contacts" ||
      x === "contact"
    );
  };

  const looksLikeShortCode = (l) => /^[a-z]{1,3}$/i.test(l.trim());

  const parseZipCityCountry = (l) => {
    const m = l.match(/\b(\d{5})\b\s+(.+)$/);
    if(!m) return null;
    const postcode = m[1];
    let rest = (m[2] || "").trim();
    let country = "";
    if(/france$/i.test(rest)){
      country = "France";
      rest = rest.replace(/france$/i, "").trim();
    }
    return { postcode, city: rest, country };
  };

  const looksLikeStreet = (l) => {
    const x = l.toLowerCase();
    return (
      /\b\d{1,5}\b/.test(x) &&
      (x.includes("rue") || x.includes("avenue") || x.includes("av ") || x.includes("boulevard") ||
       x.includes("bd ") || x.includes("chemin") || x.includes("route") || x.includes("impasse") || x.includes("place"))
    );
  };

  const looksLikeSiretNumber = (l) => /^[0-9 ]{10,30}$/.test(l.trim());
  const looksLikeVatNumber = (l) => /^[A-Z]{2}\s*[0-9A-Z ]{6,}$/.test(l.trim());

  for (let i = 1; i < lines.length; i++) {
    const l = lines[i];
    const low = l.toLowerCase();

    if (isUselessLine(l) || looksLikeShortCode(l)) continue;

    // ‚úÖ SIRET (sur la m√™me ligne)
    let siretMatch = l.match(/siret\s*[:\-]?\s*([0-9 ]{10,30})/i);
    if (siretMatch) { out.siret = siretMatch[1].replace(/\s+/g, ""); continue; }

    // ‚úÖ SIRET (label sur une ligne puis valeur sur la ligne suivante)
    if (!out.siret && (low === "n¬∞ siret :" || low === "no siret :" || low === "n¬∞ siret" || low === "no siret" || low.startsWith("siret"))) {
      const next = lines[i+1] || "";
      if (looksLikeSiretNumber(next)) {
        out.siret = next.replace(/\s+/g, "");
        i++; // on saute la ligne suivante
        continue;
      }
    }

    // ‚úÖ TVA (sur la m√™me ligne)
    let vatMatch = l.match(/tva\s*[:\-]?\s*([A-Z]{2}\s*[0-9A-Z ]{6,})/i);
    if (vatMatch) { out.vat = vatMatch[1].replace(/\s+/g, ""); continue; }

    // ‚úÖ TVA (label sur une ligne puis valeur sur la ligne suivante)
    if (!out.vat && (low === "n¬∞ de tva :" || low === "no de tva :" || low === "n¬∞ tva :" || low === "no tva :" || low.startsWith("tva"))) {
      const next = lines[i+1] || "";
      if (looksLikeVatNumber(next)) {
        out.vat = next.replace(/\s+/g, "");
        i++;
        continue;
      }
    }

    // Email
    const emailMatch = l.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    if (emailMatch && !out.contact_email) { out.contact_email = emailMatch[0].toLowerCase(); continue; }

    // Phone FR
    const phoneMatch = l.match(/(\+33|0)\s*[1-9](?:[\s.\-]*\d{2}){4}/);
    if (phoneMatch && !out.contact_phone) { out.contact_phone = phoneMatch[0].replace(/[\s.\-]/g,""); continue; }

    // Adresse (rue + CP ville pays sur la ligne suivante)
    if(!out.address && looksLikeStreet(l)){
      out.address = l;
      const next = lines[i+1] || "";
      const z = parseZipCityCountry(next);
      if(z){
        out.postcode = z.postcode;
        out.city = z.city;
        if(z.country) out.country = z.country;
      }
      continue;
    }

    // Adresse (CP ville pays sur la m√™me ligne)
    if(!out.postcode){
      const z = parseZipCityCountry(l);
      if(z){
        if(!out.address) out.address = ""; // adresse inconnue si pas de rue
        out.postcode = z.postcode;
        out.city = z.city;
        if(z.country) out.country = z.country;
        continue;
      }
    }

    // Nom contact (heuristique) => on √©vite de capturer "N¬∞ Siret :" etc
    if (!out.contact_name) {
      if (!/\d/.test(l) && !l.includes("@") && l.length <= 45) {
        const w = l.split(/\s+/).filter(Boolean);
        if (w.length >= 2 && w.length <= 5) out.contact_name = l;
      }
    }
  }

  if (!out.country && /france/i.test(t)) out.country = "France";
  return out;
}

/* =========================
   REQUEST creation / send / thread
========================= */
async function createRequest(){
  const vehicle = $("vehicle").value.trim();
  const paste = ($("pasteBlock").value || "").trim();
  if(!vehicle || !paste){ alert("V√©hicule + bloc client obligatoires."); return; }

  const parsed = parsePaste(paste);
  if(!parsed.client_name){ alert("Nom client introuvable (1√®re ligne)."); return; }

  RID = "";
  CODE = randomCode();

  const payload = {
    status: "draft",
    prescriber_email: PRESCRIBER_EMAIL,
    client_name: parsed.client_name,
    vehicle,
    fin_type: "LLD",
    recipients: [PRESCRIBER_EMAIL],
    access_code: CODE,
    address: parsed.address || null,
    postcode: parsed.postcode || null,
    city: parsed.city || null,
    country: parsed.country || null,
    siret: parsed.siret || null,
    vat: parsed.vat || null,
    contact_name: parsed.contact_name || null,
    contact_email: parsed.contact_email || null,
    contact_phone: parsed.contact_phone || null
  };

  const { res, data } = await fetchJson(`${SUPABASE_URL}/rest/v1/requests`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify(payload)
  });

  if(!res.ok){ console.log(res.status, data); alert("Erreur cr√©ation (console)."); return; }

  RID = data[0].id;
  const link = `${baseUrl()}?rid=${encodeURIComponent(RID)}&code=${encodeURIComponent(CODE)}`;
  $("link").textContent = `‚úÖ Demande cr√©√©e\nClient : ${parsed.client_name}\nLien : ${link}`;

  $("sendBox").style.display = "block";
  $("prescriberReplyBox").style.display = "block";
  renderProviders();
  await loadThread();
}

async function copyThreadLink(){
  if(!RID || !CODE){ alert("Cr√©e d‚Äôabord une demande."); return; }
  const link = `${baseUrl()}?rid=${encodeURIComponent(RID)}&code=${encodeURIComponent(CODE)}`;
  await navigator.clipboard.writeText(link);
  alert("Lien copi√©.");
}

async function sendToSelected(){
  if(!RID || !CODE){ alert("Cr√©e d‚Äôabord une demande."); return; }

  const checks = Array.from(document.querySelectorAll(".providerCheck:checked"));
  const emails = checks.map(c => (c.getAttribute("data-email")||"").trim().toLowerCase()).filter(Boolean);
  if(!emails.length){ alert("S√©lectionne au moins 1 prestataire."); return; }

  $("sendStatus").textContent = "Envoi‚Ä¶";
  const custom = ($("customMessage").value || "").trim();

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/send-request`, {
    method: "POST",
    headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY, "Content-Type": "application/json" },
    body: JSON.stringify({ request_id: RID, access_code: CODE, provider_emails: emails, custom_message: custom })
  });

  if(!res.ok){ console.log(res.status, data); $("sendStatus").textContent = "‚ùå Erreur (console)."; return; }
  $("sendStatus").textContent = "‚úÖ Envoy√©";
}

/* =========================
   THREAD
========================= */
function renderMessageFiles(files){
  if(!Array.isArray(files) || !files.length) return "";
  return files.map(f => {
    const name = escHtml(f?.name || "fichier");
    const url = f?.url;
    if(!url) return `<div class="hint">üìé ${name} (lien indisponible)</div>`;
    return `<div><a class="file" href="${url}" target="_blank" rel="noopener">üìé T√©l√©charger : ${name}</a></div>`;
  }).join("");
}

function renderThreadProvider(data){
  const el = $("threadProvider");
  if(!el) return;

  el.innerHTML = "";
  (data.responses || []).forEach(x=>{
    const isYou = PROVIDER_EMAIL && (String(x.responder_email||"").toLowerCase() === PROVIDER_EMAIL);
    el.innerHTML += `
      <div class="msg ${isYou ? "you":"them"}">
        <div class="msgHead">
          <div class="msgWho">${escHtml(x.responder_email || "MF Auto Sud")}</div>
          <div class="msgMeta">${new Date(x.created_at).toLocaleString("fr-FR")}</div>
        </div>
        <div class="msgBody">
          ${escHtml(x.message || "").replaceAll("\n","<br>")}
          ${renderMessageFiles(x.files)}
        </div>
      </div>`;
  });
}

async function loadThread(){
  if(!RID || !CODE) return;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/get-thread`, {
    method: "POST",
    headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY, "Content-Type": "application/json" },
    body: JSON.stringify({ request_id: RID, access_code: CODE })
  });

  const target = $("thread") || $("threadProvider");
  if(!res.ok){
    console.log("get-thread failed:", res.status, data);
    if(target) target.innerHTML = `<div class="hint">‚ùå Erreur chargement conversation</div>`;
    return;
  }

  // prescriber thread
  if($("thread")){
    const el = $("thread");
    el.innerHTML = "";
    (data.responses || []).forEach(x=>{
      const isThem = !!x.responder_email;
      el.innerHTML += `
        <div class="msg ${isThem ? "them":"you"}">
          <div class="msgHead">
            <div class="msgWho">${isThem ? escHtml(x.responder_email || "Prestataire") : "Vous"}</div>
            <div class="msgMeta">${new Date(x.created_at).toLocaleString("fr-FR")}</div>
          </div>
          <div class="msgBody">
            ${escHtml(x.message || "").replaceAll("\n","<br>")}
            ${renderMessageFiles(x.files)}
          </div>
        </div>`;
    });
  }

  // provider thread + info
  if($("threadProvider")) renderThreadProvider(data);

  if($("requestInfo") && data.request){
    const r = data.request;
    const addrLine = [r.address, r.postcode, r.city, r.country].filter(Boolean).join(" ");
    $("requestInfo").innerHTML = `
      <div class="card">
        <div class="gridInfo">
          <div class="kv"><b>Client</b><div>${escHtml(r.client_name || "-")}</div></div>
          <div class="kv"><b>V√©hicule</b><div>${escHtml(r.vehicle || "-")}</div></div>

          <div class="kv"><b>Adresse</b><div>${escHtml(addrLine || "-")}</div></div>
          <div class="kv"><b>Contact</b><div>${escHtml(r.contact_name || "-")}</div></div>

          <div class="kv"><b>E-mail</b><div>${escHtml(r.contact_email || "-")}</div></div>
          <div class="kv"><b>T√©l√©phone</b><div>${escHtml(r.contact_phone || "-")}</div></div>

          <div class="kv"><b>SIRET</b><div>${escHtml(r.siret || "-")}</div></div>
          <div class="kv"><b>TVA</b><div>${escHtml(r.vat || "-")}</div></div>

          <div class="kv"><b>Assign√© √†</b><div>${escHtml(r.assigned_to_email || "-")}</div></div>
        </div>
      </div>
    `;
  }
}

/* =========================
   CHEF DES VENTES : √©quipe + assignation
   (n√©cessite vendor-list + request-assign)
========================= */
async function providerRoleAndTeam(){
  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-list`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({ provider_email: PROVIDER_EMAIL, request_id: RID, access_code: CODE })
  });

  if(!res.ok){
    console.log("vendor-list:", res.status, data);
    return { is_manager:false, vendors:[] };
  }
  return {
    is_manager: data.is_sales_manager === true,
    vendors: Array.isArray(data.vendors) ? data.vendors : []
  };
}

function renderAssignList(vendors){
  const el = $("assignList");
  const hint = $("assignHint");
  if(!el) return;

  if(!vendors.length){
    if(hint) hint.textContent = "Aucun vendeur rattach√© √† ce chef des ventes.";
    el.innerHTML = "";
    return;
  }

  if(hint) hint.textContent = "Choisis un vendeur de l‚Äô√©quipe :";
  el.innerHTML = vendors.map(v=>{
    const email = String(v.vendor_email || "").trim().toLowerCase();
    const name = String(v.vendor_name || "").trim();
    const label = name ? `${name} ‚Äî ${email}` : email;

    return `
      <div class="providerRow">
        <input type="radio" name="assignVendor" value="${escHtml(email)}">
        <div class="txt">
          <span class="main">${escHtml(label)}</span>
          <span class="sub">Attribuer ce dossier √† ce vendeur</span>
        </div>
      </div>
    `;
  }).join("");
}

async function assignRequestToSelectedVendor(){
  const status = $("assignStatus");
  const picked = document.querySelector('input[name="assignVendor"]:checked');
  if(!picked){
    if(status) status.textContent = "‚ùå S√©lectionne un vendeur.";
    return;
  }
  const vendor_email = String(picked.value || "").trim().toLowerCase();
  if(status) status.textContent = "Attribution en cours‚Ä¶";

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/request-assign`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      manager_email: PROVIDER_EMAIL,
      vendor_email
    })
  });

  if(!res.ok){
    console.log("request-assign:", res.status, data);
    if(status) status.textContent = "‚ùå Erreur attribution (voir console).";
    return;
  }

  if(status) status.textContent = "‚úÖ Dossier attribu√©.";
  await loadThread();
}

/* =========================
   Vendor directory (chef des ventes)
   (n√©cessite vendor-list + vendor-upsert + vendor-delete)
========================= */
function vendorExtractLine(line){
  const s = (line || "").trim();
  if(!s) return null;

  const m = s.match(/^(.*)<\s*([^>]+)\s*>$/);
  if(m){
    const name = m[1].replace(/^['"]|['"]$/g,"").trim();
    const email = (m[2] || "").trim().toLowerCase();
    return { name, email };
  }

  const only = s.replace(/^['"]|['"]$/g,"").trim().toLowerCase();
  if(emailLooksValid(only)) return { name:"", email: only };

  const em = s.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
  if(em) return { name:"", email: em[0].toLowerCase() };

  return null;
}

async function vendorFetchList(){
  showVendorBox(false);

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-list`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({ provider_email: PROVIDER_EMAIL, request_id: RID, access_code: CODE })
  });

  if(!res.ok){
    console.log("vendor-list error:", res.status, data);
    return;
  }

  VENDOR_IS_MANAGER = (data && data.is_sales_manager === true);
  if(!VENDOR_IS_MANAGER){
    showVendorBox(false);
    return;
  }

  showVendorBox(true);
  $("vendorRoleHint").innerHTML = `<span class="tag ok">Chef des ventes</span> R√©pertoire √©quipe disponible.`;

  const vendors = Array.isArray(data.vendors) ? data.vendors : [];
  const el = $("vendorList");
  if(!el) return;

  if(!vendors.length){
    el.innerHTML = `<div class="hint">Aucun vendeur enregistr√©.</div>`;
    return;
  }

  el.innerHTML = vendors.map(v=>{
    const email = String(v.vendor_email || "").trim().toLowerCase();
    const name  = String(v.vendor_name || "").trim();
    const label = name ? `${name} ‚Äî ${email}` : email;

    return `
      <div class="providerRow">
        <div class="txt">
          <span class="main">${escHtml(label)}</span>
          <span class="sub">${escHtml(email)}</span>
        </div>
        <button class="small secondary" data-del="${escHtml(email)}">Suppr.</button>
      </div>
    `;
  }).join("");

  // bind delete buttons
  el.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const ve = String(btn.getAttribute("data-del")||"").trim().toLowerCase();
      if(!ve) return;
      if(!confirm("Supprimer ce vendeur ?")) return;

      const { res: r2, data: d2 } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-delete`, {
        method:"POST",
        headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
        body: JSON.stringify({ provider_email: PROVIDER_EMAIL, vendor_email: ve, request_id: RID, access_code: CODE })
      });

      if(!r2.ok){
        console.log("vendor-delete:", r2.status, d2);
        alert("Erreur suppression (console)");
        return;
      }
      await vendorFetchList();
      // refresh assign list too
      const role = await providerRoleAndTeam();
      renderAssignList(role.vendors);
    });
  });
}

async function vendorAddDb(){
  if(!VENDOR_IS_MANAGER){
    alert("Action r√©serv√©e au Chef des ventes.");
    return;
  }
  const email = normalizeEmail($("vendorEmail").value);
  const name = ($("vendorName").value || "").trim();
  if(!emailLooksValid(email)){ alert("E-mail vendeur invalide."); return; }

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-upsert`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({ provider_email: PROVIDER_EMAIL, vendor_email: email, vendor_name: name || "", request_id: RID, access_code: CODE })
  });

  if(!res.ok){
    console.log("vendor-upsert:", res.status, data);
    alert("Erreur ajout vendeur (console)");
    return;
  }

  $("vendorEmail").value = "";
  $("vendorName").value = "";
  await vendorFetchList();
  const role = await providerRoleAndTeam();
  renderAssignList(role.vendors);
}

async function vendorImportList(){
  if(!VENDOR_IS_MANAGER){
    alert("Action r√©serv√©e au Chef des ventes.");
    return;
  }
  const raw = ($("vendorImport").value || "").replace(/\r/g,"").trim();
  if(!raw){ alert("Colle une liste."); return; }

  const lines = raw.split("\n").map(x=>x.trim()).filter(Boolean);

  let added = 0, ignored = 0;
  for(const line of lines){
    const p = vendorExtractLine(line);
    if(!p || !emailLooksValid(p.email)){ ignored++; continue; }

    const { res } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-upsert`, {
      method:"POST",
      headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
      body: JSON.stringify({ provider_email: PROVIDER_EMAIL, vendor_email: p.email, vendor_name: p.name || "", request_id: RID, access_code: CODE })
    });

    if(res.ok) added++; else ignored++;
  }

  $("vendorImport").value = "";
  await vendorFetchList();
  const role = await providerRoleAndTeam();
  renderAssignList(role.vendors);
  alert(`Import termin√© : +${added} ajout√©s / ${ignored} ignor√©s`);
}

async function vendorExport(){
  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-list`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({ provider_email: PROVIDER_EMAIL, request_id: RID, access_code: CODE })
  });

  if(!res.ok){
    console.log("vendor-export vendor-list:", res.status, data);
    alert("Erreur export (console)");
    return;
  }

  const vendors = Array.isArray(data.vendors) ? data.vendors : [];
  const lines = vendors.map(v=>{
    const email = String(v.vendor_email || "");
    const name = String(v.vendor_name || "").trim();
    return name ? `${name} <${email}>` : email;
  }).join("\n");

  await navigator.clipboard.writeText(lines || "");
  alert("R√©pertoire vendeurs copi√©.");
}

async function vendorClear(){
  if(!VENDOR_IS_MANAGER){ alert("Action r√©serv√©e au Chef des ventes."); return; }
  if(!confirm("Supprimer tout le r√©pertoire vendeurs (en base) ?")) return;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-list`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({ provider_email: PROVIDER_EMAIL, request_id: RID, access_code: CODE })
  });

  if(!res.ok){
    console.log("vendor-clear vendor-list:", res.status, data);
    alert("Erreur chargement vendeurs (console)");
    return;
  }

  const vendors = Array.isArray(data.vendors) ? data.vendors : [];
  for(const v of vendors){
    const ve = String(v.vendor_email || "").toLowerCase();
    await fetchJson(`${SUPABASE_URL}/functions/v1/vendor-delete`, {
      method:"POST",
      headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
      body: JSON.stringify({ provider_email: PROVIDER_EMAIL, vendor_email: ve, request_id: RID, access_code: CODE })
    });
  }

  await vendorFetchList();
  renderAssignList([]);
}

/* =========================
   ADMIN (roles + √©quipes)
========================= */
function showAdminBox(show){ $("adminBox").style.display = show ? "" : "none"; }

async function adminList(){
  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/admin-provider-list`, {
    method:"POST",
    headers:{
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type":"application/json",
      "x-admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({})
  });

  if(!res.ok){
    console.log("admin-provider-list error:", res.status, data);
    $("adminList").innerHTML = `‚ùå Erreur admin-provider-list`;
    return;
  }

  const rows = Array.isArray(data.providers) ? data.providers : [];
  if(!rows.length){
    $("adminList").innerHTML = `<div class="hint">Aucun prestataire en base.</div>`;
    return;
  }

  $("adminList").innerHTML = rows.map(r=>{
    const email = escHtml(r.provider_email || "");
    const name = escHtml(r.provider_name || "");
    const tags = [
      r.is_sales_manager ? "‚úÖ Chef des ventes" : "",
      r.is_vendor ? "‚úÖ Vendeur" : ""
    ].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî";

    return `
      <div class="providerRow">
        <div class="txt">
          <span class="main">${email}</span>
          ${name ? `<span class="sub">${name}</span>` : ""}
          <span class="sub">${escHtml(tags)}</span>
        </div>
      </div>
    `;
  }).join("");
}

async function adminSave(){
  const email = normalizeEmail($("adminEmail").value);
  const name = ($("adminName").value || "").trim();
  const is_sales_manager = !!$("adminIsManager").checked;
  const is_vendor = !!$("adminIsVendor").checked;

  if(!emailLooksValid(email)){ alert("Email invalide"); return; }

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/admin-provider-upsert`, {
    method:"POST",
    headers:{
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type":"application/json",
      "x-admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ provider_email: email, provider_name: name || null, is_sales_manager, is_vendor })
  });

  if(!res.ok){
    console.log("admin-provider-upsert error:", res.status, data);
    alert("Erreur admin (console)");
    return;
  }

  $("adminEmail").value = "";
  $("adminName").value = "";
  $("adminIsManager").checked = false;
  $("adminIsVendor").checked = false;

  await adminList();
  await adminTeamList();
}

async function adminTeamList(){
  const box = $("teamBox");
  if(!box) return;

  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/admin-manager-vendor-list`, {
    method:"POST",
    headers:{
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type":"application/json",
      "x-admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({})
  });

  if(!res.ok){
    console.log("admin-manager-vendor-list:", res.status, data);
    box.innerHTML = `‚ùå Fonction admin-manager-vendor-list non disponible (ou token invalide).`;
    return;
  }

  const managers = Array.isArray(data.managers) ? data.managers : [];
  if(!managers.length){
    box.innerHTML = `<div class="hint">Aucun chef des ventes trouv√©.</div>`;
    return;
  }

  box.innerHTML = managers.map(m=>{
    const me = String(m.manager_email || "");
    const mn = String(m.manager_name || "").trim();
    const vendors = Array.isArray(m.vendors) ? m.vendors : [];

    const vendorHtml = vendors.length
      ? vendors.map(v=>{
          const ve = String(v.vendor_email || "");
          const vn = String(v.vendor_name || "").trim();
          const label = vn ? `${vn} ‚Äî ${ve}` : ve;

          return `
            <div class="providerRow">
              <div class="txt">
                <span class="main">${escHtml(label)}</span>
                <span class="sub">${escHtml(ve)}</span>
              </div>
              <button class="small secondary" data-adm-del="${escHtml(me)}||${escHtml(ve)}">Suppr.</button>
            </div>
          `;
        }).join("")
      : `<div class="hint">Aucun vendeur rattach√©.</div>`;

    return `
      <div class="box" style="margin-top:12px">
        <h3>${escHtml(mn ? `${mn} ‚Äî ${me}` : me)}</h3>
        ${vendorHtml}
        <div class="divider"></div>
        <div class="grid2">
          <div>
            <label>Ajouter vendeur (email)</label>
            <input data-adm-add-email="${escHtml(me)}" placeholder="vendeur@domaine.com">
          </div>
          <div>
            <label>Nom (optionnel)</label>
            <input data-adm-add-name="${escHtml(me)}" placeholder="Jean Dupont">
          </div>
        </div>
        <div class="row">
          <button class="secondary" data-adm-add-btn="${escHtml(me)}">Ajouter</button>
        </div>
      </div>
    `;
  }).join("");

  // bind delete
  box.querySelectorAll("button[data-adm-del]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const raw = String(btn.getAttribute("data-adm-del")||"");
      const [manager_email, vendor_email] = raw.split("||").map(x=>String(x||"").trim().toLowerCase());
      if(!manager_email || !vendor_email) return;
      if(!confirm("Supprimer ce vendeur de l‚Äô√©quipe ?")) return;

      const { res: r2, data: d2 } = await fetchJson(`${SUPABASE_URL}/functions/v1/admin-vendor-delete`, {
        method:"POST",
        headers:{
          apikey: SUPABASE_ANON_KEY,
          Authorization: "Bearer " + SUPABASE_ANON_KEY,
          "Content-Type":"application/json",
          "x-admin-token": ADMIN_TOKEN
        },
        body: JSON.stringify({ manager_email, vendor_email })
      });

      if(!r2.ok){
        console.log("admin-vendor-delete:", r2.status, d2);
        alert("Erreur suppression (console)");
        return;
      }
      await adminTeamList();
    });
  });

  // bind add
  box.querySelectorAll("button[data-adm-add-btn]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const manager_email = String(btn.getAttribute("data-adm-add-btn")||"").trim().toLowerCase();
      const emailInput = box.querySelector(`input[data-adm-add-email="${CSS.escape(manager_email)}"]`);
      const nameInput  = box.querySelector(`input[data-adm-add-name="${CSS.escape(manager_email)}"]`);

      const vendor_email = normalizeEmail(emailInput ? emailInput.value : "");
      const vendor_name  = String(nameInput ? nameInput.value : "").trim();

      if(!emailLooksValid(vendor_email)){ alert("Email vendeur invalide"); return; }

      const { res: r2, data: d2 } = await fetchJson(`${SUPABASE_URL}/functions/v1/admin-vendor-upsert`, {
        method:"POST",
        headers:{
          apikey: SUPABASE_ANON_KEY,
          Authorization: "Bearer " + SUPABASE_ANON_KEY,
          "Content-Type":"application/json",
          "x-admin-token": ADMIN_TOKEN
        },
        body: JSON.stringify({ manager_email, vendor_email, vendor_name: vendor_name || null })
      });

      if(!r2.ok){
        console.log("admin-vendor-upsert:", r2.status, d2);
        alert("Erreur ajout (console)");
        return;
      }

      if(emailInput) emailInput.value = "";
      if(nameInput) nameInput.value = "";
      await adminTeamList();
    });
  });
}

/* =========================
   INIT
========================= */
(function init(){
  // binds prescriber
  $("createBtn").addEventListener("click", createRequest);
  $("copyLinkBtn").addEventListener("click", copyThreadLink);
  $("copyLinkBtn2").addEventListener("click", copyThreadLink);
  $("copyLinkBtn3").addEventListener("click", copyThreadLink);

  $("addProviderBtn").addEventListener("click", addProvider);
  $("checkAllBtn").addEventListener("click", ()=>checkAll(true));
  $("uncheckAllBtn").addEventListener("click", ()=>checkAll(false));
  $("exportProvidersBtn").addEventListener("click", exportProviders);
  $("clearProvidersBtn").addEventListener("click", clearProviders);
  $("importProvidersBtn").addEventListener("click", importProviders);
  $("sendBtn").addEventListener("click", sendToSelected);
  $("refreshThreadBtn").addEventListener("click", loadThread);

  // provider buttons
  $("refreshThreadProviderBtn").addEventListener("click", loadThread);
  $("assignBtn").addEventListener("click", assignRequestToSelectedVendor);

  $("vendorAddBtn").addEventListener("click", vendorAddDb);
  $("vendorImportBtn").addEventListener("click", vendorImportList);
  $("vendorExportBtn").addEventListener("click", vendorExport);
  $("vendorClearBtn").addEventListener("click", vendorClear);

  // UI initial
  renderProviders();

  const { rid, code, pe, admin, token } = getAllParams();

  // admin activation (query ou hash)
  ADMIN_TOKEN = token || DEFAULT_ADMIN_TOKEN || "";
  if(String(admin) === "1" && ADMIN_TOKEN){
    showAdminBox(true);
    $("adminHint").innerHTML = `<span class="tag ok">Admin activ√©</span>`;
    $("adminSave").addEventListener("click", adminSave);
    $("adminRefresh").addEventListener("click", async ()=>{ await adminList(); await adminTeamList(); });
    adminList();
    adminTeamList();
  }else{
    showAdminBox(false);
  }

  // 1) Mode prestataire si pe existe (prioritaire)
  if (rid && code && pe && String(pe).trim()) {
    RID = rid;
    CODE = code;
    PROVIDER_EMAIL = decodeURIComponent(String(pe)).trim().toLowerCase();

    $("prescriberUI").style.display = "none";
    $("providerUI").style.display = "block";
    setModeChip("Prestataire");

    // par d√©faut: cache les features manager, puis on d√©cide
    showVendorBox(false);
    showAssignBox(false);

    // charge thread + d√©cide si manager
    loadThread().then(async ()=>{
      const role = await providerRoleAndTeam();
      if(role.is_manager){
        showVendorBox(true);
        showAssignBox(true);
        renderAssignList(role.vendors);
        await vendorFetchList();
      }else{
        showVendorBox(false);
        showAssignBox(false);
      }
    });

    return;
  }

  // 2) Mode prescripteur dossier
  if (rid && code) {
    RID = rid;
    CODE = code;

    $("prescriberUI").style.display = "block";
    $("providerUI").style.display = "none";

    $("sendBox").style.display = "block";
    $("prescriberReplyBox").style.display = "block";

    setModeChip("Prescripteur (dossier)");
    loadThread();
    return;
  }

  // 3) Mode prescripteur accueil
  $("prescriberUI").style.display = "block";
  $("providerUI").style.display = "none";
  setModeChip("Prescripteur");
})();
</script>

</body>
</html>
