<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Portail Vendeur ‚Äì MF Auto Sud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="./assets/logo-mfautosud.png">
  <style>
    :root{
      --bg:#0b1220; --panel:#111c34; --panel2:#0f1a32;
      --text:#ffffff; --muted:rgba(255,255,255,.75); --line:rgba(255,255,255,.10);
      --brand:#4da3ff; --btn:#4da3ff; --btnText:#001; --btn2:#334155;
      --shadow: 0 10px 24px rgba(0,0,0,.22);
      --fieldBg: rgba(11,18,32,.85); --fieldBorder: rgba(255,255,255,.14); --fieldFocus: rgba(77,163,255,.55);
      --rowBg: rgba(11,18,32,.60); --rowBorder: rgba(255,255,255,.08);
      --msgBg: rgba(11,18,32,.75);
      --fileBg:#334155; --fileBorder: rgba(255,255,255,.10);
      --topbarBg: rgba(17,28,52,.85); --topbarBorder: rgba(255,255,255,.08);
      --chipBg: rgba(77,163,255,.12); --chipBorder: rgba(77,163,255,.25); --chipText: #cfe6ff;
      --divider: rgba(255,255,255,.10);
      --link: #7cc0ff;
    }
    [data-theme="light"]{
      --bg:#f6f8fc; --panel:#ffffff; --panel2:#ffffff;
      --text:#0b1220; --muted:rgba(15,23,42,.72); --line:rgba(15,23,42,.12);
      --brand:#2563eb; --btn:#2563eb; --btnText:#fff; --btn2:#e2e8f0;
      --shadow: 0 10px 24px rgba(2,6,23,.08);
      --fieldBg: rgba(255,255,255,.95); --fieldBorder: rgba(15,23,42,.14); --fieldFocus: rgba(37,99,235,.45);
      --rowBg: rgba(2,6,23,.03); --rowBorder: rgba(2,6,23,.08);
      --msgBg: rgba(2,6,23,.03);
      --fileBg: rgba(2,6,23,.06); --fileBorder: rgba(2,6,23,.10);
      --topbarBg: rgba(255,255,255,.85); --topbarBorder: rgba(2,6,23,.10);
      --chipBg: rgba(37,99,235,.10); --chipBorder: rgba(37,99,235,.22); --chipText: rgba(15,23,42,.85);
      --divider: rgba(2,6,23,.10);
      --link: #2563eb;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial, sans-serif; color:var(--text); padding:24px;
      background:
        radial-gradient(1100px 460px at 10% -10%, rgba(77,163,255,.22), transparent 60%),
        radial-gradient(900px 380px at 90% 0%, rgba(37,99,235,.18), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1100px;margin:0 auto}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-radius:16px;
      background: var(--topbarBg); border:1px solid var(--topbarBorder);
      backdrop-filter: blur(6px); margin-bottom:16px; box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0;}
    .brandLogo{
      width:44px;height:44px;border-radius:12px; background:var(--panel2); border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center; padding:6px; flex:0 0 auto;
    }
    .brandLogo img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .brandTitle h1{font-size:16px;margin:0;color:var(--brand);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .brandTitle .sub{margin:2px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .topbarRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .chip{
      font-size:12px; padding:6px 10px;border-radius:999px;
      background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--chipText);
      white-space:nowrap;
    }

    .box{
      background: linear-gradient(180deg, rgba(17,28,52,.95), rgba(15,26,50,.95));
      border:1px solid rgba(255,255,255,.08);
      padding:16px; border-radius:16px; margin-bottom:14px; box-shadow: var(--shadow);
    }
    [data-theme="light"] .box{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
      border:1px solid rgba(2,6,23,.10);
    }

    h2{margin:0 0 10px;font-size:16px}
    label{display:block;margin-top:10px;font-size:13px;color:var(--muted)}
    input,textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--fieldBorder); background:var(--fieldBg); color:var(--text); outline:none;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    button{
      padding:10px 12px; border-radius:12px; border:0;
      background:var(--btn); color:var(--btnText); font-weight:800; cursor:pointer;
    }
    button.secondary{
      background:var(--btn2); color: var(--text); font-weight:700; border:1px solid var(--line);
    }
    [data-theme="light"] button.secondary{color:#0b1220;border:1px solid rgba(2,6,23,.10)}

    .hint{opacity:.86;font-size:12px;margin-top:8px;white-space:pre-wrap;line-height:1.35;color:var(--muted)}
    .msg{background:var(--msgBg); padding:12px; border-radius:14px; margin-top:10px; border:1px solid var(--rowBorder)}
    .msg.you{border-left:4px solid var(--brand)}
    .msg.them{border-left:4px solid #22c55e}
    .msgHead{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .msgMeta{font-size:12px;opacity:.75;color:var(--muted)}
    .msgWho{font-weight:800}
    .msgBody{margin-top:8px;line-height:1.45;font-size:13px}

    .file{
      display:inline-block; margin-top:8px; padding:8px 10px; border-radius:12px;
      background:var(--fileBg); color:var(--text); text-decoration:none; border:1px solid var(--fileBorder);
    }
    .thumb{
      margin-top:8px;
      max-width:260px;
      border-radius:12px;
      border:1px solid var(--fileBorder);
      display:block;
    }

    .card{background:var(--rowBg); border:1px solid var(--rowBorder); border-radius:16px; padding:14px;}
    .gridInfo{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.gridInfo{grid-template-columns:1fr}}
    .kv{padding:10px 10px;border-radius:14px;background:rgba(17,28,52,.35);border:1px solid var(--rowBorder);}
    [data-theme="light"] .kv{background:rgba(2,6,23,.03)}
    .kv b{display:block;font-size:12px;opacity:.8;margin-bottom:4px}
    .kv div{font-size:13px;word-break:break-word}
    /* ============ iMessage-like chat ============ */
.msg{
  background: transparent;
  border: 0;
  padding: 0;
  margin-top: 10px;
}

.msgRow{
  display:flex;
  width:100%;
}

.msgRow.you{ justify-content:flex-end; }
.msgRow.them{ justify-content:flex-start; }

.bubble{
  max-width: 78%;
  padding: 10px 12px;
  border-radius: 18px;
  border: 1px solid var(--rowBorder);
  background: var(--msgBg);
  box-shadow: 0 6px 16px rgba(0,0,0,.10);
}

.msgRow.you .bubble{ border-bottom-right-radius: 8px; }
.msgRow.them .bubble{ border-bottom-left-radius: 8px; }

.bubbleHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:6px;
}

.bubbleWho{
  font-size:12px;
  font-weight:800;
  opacity:.9;
}

.bubbleMeta{
  font-size:11px;
  opacity:.7;
  color: var(--muted);
  white-space:nowrap;
}

.bubbleBody{
  font-size:13px;
  line-height:1.45;
  word-break:break-word;
}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="brandLogo">
        <img src="./assets/logo-mfautosud.png" alt="MF Auto Sud">
      </div>
      <div class="brandTitle">
        <h1>Portail Vendeur</h1>
        <div class="sub">Voir dossier ‚Ä¢ R√©pondre ‚Ä¢ Pi√®ces jointes</div>
      </div>
    </div>
    <div class="topbarRight">
      <div class="chip">Vendeur</div>
      <div class="chip" id="newMsgChip" style="display:none;">üîî Nouveau message</div>
      <button class="secondary" id="themeBtn" type="button">üåô Mode sombre</button>
    </div>
  </div>

  <div class="box">
    <h2>Dossier</h2>
    <div class="row">
      <button class="secondary" id="refreshBtn" type="button">üîÑ Rafra√Æchir</button>
      <button class="secondary" id="copyLinkBtn" type="button">Copier le lien</button>
      <button class="secondary" id="markReadBtn" type="button">‚úÖ Marquer comme lu</button>
    </div>
    <div id="requestInfo" class="hint" style="margin-top:10px">Chargement‚Ä¶</div>
    <div id="accessErr" class="hint" style="margin-top:10px;display:none;"></div>
  </div>

  <div class="box">
    <h2>Conversation</h2>
    <div id="thread" style="margin-top:10px"></div>
  </div>

  <div class="box">
    <h2>R√©pondre</h2>
    <label>Message</label>
    <textarea id="respMsg" style="height:120px" placeholder="Votre message‚Ä¶"></textarea>

    <label>Documents (PDF, images‚Ä¶)</label>
<input type="file" id="respFiles" multiple accept="application/pdf,image/*">
    <div class="row">
      <button id="sendMsgBtn" type="button">Envoyer</button>
    </div>
    <div id="respStatus" class="hint"></div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1YmhzamtzdGJycWx2bXlsb2J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDE1NzQsImV4cCI6MjA4NDk3NzU3NH0.tANS4zo9wvLsWJS48Hyw6thttQX0yhBjOKI1aY4FTCo";

const THEME_KEY = "mfautosud_theme";
function applyTheme(theme){
  const t = (theme === "light") ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem(THEME_KEY, t);
  const btn = document.getElementById("themeBtn");
  if(btn) btn.textContent = (t === "light") ? "‚òÄÔ∏è Mode clair" : "üåô Mode sombre";
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(cur === "dark" ? "light" : "dark");
}
(function(){
  applyTheme(localStorage.getItem(THEME_KEY) || "dark");
  document.getElementById("themeBtn")?.addEventListener("click", toggleTheme);
})();

let RID="", CODE="", PROVIDER_EMAIL="";

function $(id){ return document.getElementById(id); }
function escHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function normalizeEmail(email){ return (email || "").trim().toLowerCase(); }
function currentTheme(){
  return document.documentElement.getAttribute("data-theme") || "dark";
}

function hashHue(str){
  const s = String(str || "");
  let h = 0;
  for(let i=0;i<s.length;i++){
    h = (h * 31 + s.charCodeAt(i)) >>> 0;
  }
  return h % 360;
}

function bubbleStyleForSender(senderEmail, isYou){
  // Vous = bleu MF (style iMessage)
  if(isYou){
    return `background: linear-gradient(180deg, var(--brand), var(--brand)); color:#fff; border-color: rgba(255,255,255,.18);`;
  }

  // Interlocuteur = couleur stable bas√©e sur son email
  const hue = hashHue(senderEmail || "unknown");
  const theme = currentTheme();

  if(theme === "light"){
    return `background: hsl(${hue} 85% 96%); color:#0b1220; border-color: rgba(2,6,23,.10);`;
  }
  return `background: hsl(${hue} 55% 18%); color:#ffffff; border-color: rgba(255,255,255,.10);`;
}
function baseUrl(){ return window.location.origin + window.location.pathname; }

function getAllParams(){
  const url = new URL(window.location.href);
  const qs = url.searchParams;
  const hs = new URLSearchParams(window.location.hash.replace("#",""));
  const rid   = qs.get("rid")   || hs.get("rid");
  const code  = qs.get("code")  || hs.get("code");
  const pe    = qs.get("pe")    || hs.get("pe");
  return { rid, code, pe };
}
async function fetchJson(url, options){
  const res = await fetch(url, options);
  let data=null; try{ data=await res.json(); }catch{}
  return { res, data };
}

/* badge */
function seenKey(){ return `mf_seen_vendor_${RID}_${PROVIDER_EMAIL}`; }
function markSeen(){
  if(!RID) return;
  localStorage.setItem(seenKey(), new Date().toISOString());
  $("newMsgChip").style.display = "none";
}
function getSeen(){
  const v = localStorage.getItem(seenKey());
  return v ? new Date(v).getTime() : 0;
}
function updateNewBadge(show){
  $("newMsgChip").style.display = show ? "" : "none";
}

/* files */
async function uploadFiles(requestId, fileInput){
  const uploaded = [];
  if(!fileInput || !fileInput.files || !fileInput.files.length) return uploaded;

  for(const file of fileInput.files){
    const fd = new FormData();
    fd.append("file", file);
    fd.append("request_id", requestId);
    fd.append("access_code", CODE || "");
    fd.append("uploader_email", (PROVIDER_EMAIL || "").toLowerCase());

    const res = await fetch(`${SUPABASE_URL}/functions/v1/upload-attachment`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY
      },
      body: fd
    });

    let data = null;
    try { data = await res.json(); } catch {}

    if(!res.ok){
      debugLog("upload-attachment failed", { status: res.status, data });
      throw new Error(data?.error || `upload-attachment failed: ${res.status}`);
    }

    const returnedUrl =
      data?.url ||
      data?.publicUrl ||
      data?.public_url ||
      data?.signedUrl ||
      data?.signed_url ||
      "";

    if(!returnedUrl){
      throw new Error("upload-attachment: URL manquante dans la r√©ponse");
    }

    uploaded.push({
      name: data?.name || data?.filename || file.name,
      url: returnedUrl
    });
  }

  return uploaded;
}


function isImageUrl(url){
  const u = String(url || "").toLowerCase();
  return u.endsWith(".png") || u.endsWith(".jpg") || u.endsWith(".jpeg") || u.endsWith(".webp");
}
function normalizeFiles(raw){
  if(!raw) return [];
  if(Array.isArray(raw)) return raw;

  if(typeof raw === "string"){
    try{
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    }catch{
      return [];
    }
  }

  if(typeof raw === "object"){
    if(Array.isArray(raw.files)) return raw.files;
    return [];
  }

  return [];
}

function isImageUrl(url){
  const u = String(url || "").toLowerCase();
  return u.endsWith(".png") || u.endsWith(".jpg") || u.endsWith(".jpeg") || u.endsWith(".webp") || u.includes("image/");
}

function renderMessageFiles(rawFiles){
  const files = normalizeFiles(rawFiles);
  if(!files.length) return "";

  return files.map(f => {
    const name = escHtml(f?.name || "fichier");
    const url = String(f?.url || "").trim();

    if(!url){
      return `<div class="hint">üìé ${name} (lien indisponible)</div>`;
    }

    const link = `
      <div>
        <a class="file" href="${url}" target="_blank" rel="noopener">üìé T√©l√©charger : ${name}</a>
      </div>
    `;

    const preview = isImageUrl(url)
      ? `<img class="thumb" src="${url}" alt="${name}">`
      : "";

    return link + preview;
  }).join("");
}

function formatAddress(r){
  const addr = String(r.address || "").trim();
  const postcode = String(r.postcode || "").trim();
  const city = String(r.city || "").trim();
  const country = String(r.country || "").trim();
  const addrHasFrance = /france/i.test(addr);
  const parts=[];
  if(addr) parts.push(addr);
  if(postcode || city) parts.push([postcode, city].filter(Boolean).join(" "));
  if(country && !addrHasFrance) parts.push(country);
  return parts.join(" ").replace(/\s+/g," ").trim();
}
function renderRequestCard(r){
  const addrLine = formatAddress(r);
  return `
    <div class="card">
      <div class="gridInfo">
        <div class="kv"><b>Client</b><div>${escHtml(r.client_name || "-")}</div></div>
        <div class="kv"><b>V√©hicule</b><div>${escHtml(r.vehicle || "-")}</div></div>
        <div class="kv"><b>Adresse</b><div>${escHtml(addrLine || "-")}</div></div>
        <div class="kv"><b>Contact</b><div>${escHtml(r.contact_name || "-")}</div></div>
        <div class="kv"><b>Email contact</b><div>${escHtml(r.contact_email || "-")}</div></div>
        <div class="kv"><b>T√©l√©phone</b><div>${escHtml(r.contact_phone || "-")}</div></div>
        <div class="kv"><b>Assign√© √†</b><div>${escHtml(r.assigned_to_email || "-")}</div></div>
      </div>
    </div>
  `;
}

async function loadThread(){
  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/get-thread`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({ request_id: RID, access_code: CODE })
  });

  if(!res.ok){
    $("accessErr").style.display = "";
    $("accessErr").textContent = `‚ùå Impossible de charger le dossier (HTTP ${res.status}).`;
    $("requestInfo").textContent = "";
    return;
  }

  $("accessErr").style.display = "none";
  $("requestInfo").innerHTML = data?.request ? renderRequestCard(data.request) : "‚ö†Ô∏è data.request manquant (get-thread).";

  const responses = Array.isArray(data?.responses) ? data.responses : [];
  const thread = $("thread");
  thread.innerHTML = "";

  responses.forEach(x=>{
  const from = x.responder_email ? String(x.responder_email) : "MF Auto Sud";

  // isYou = message envoy√© par le prestataire connect√© (chef des ventes)
  const isYou = !!x.responder_email && normalizeEmail(from) === normalizeEmail(PROVIDER_EMAIL);

  // couleur : bleu pour toi, couleur unique pour chaque interlocuteur sinon
  const style = bubbleStyleForSender(from, isYou);

  thread.innerHTML += `
    <div class="msg">
      <div class="msgRow ${isYou ? "you" : "them"}">
        <div class="bubble" style="${style}">
          <div class="bubbleHead">
            <div class="bubbleWho">${escHtml(isYou ? "Vous" : from)}</div>
            <div class="bubbleMeta">${new Date(x.created_at).toLocaleString("fr-FR")}</div>
          </div>
          <div class="bubbleBody">
            ${escHtml(x.message || "").replaceAll("\n","<br>")}
            ${renderMessageFiles(x.files)}
          </div>
        </div>
      </div>
    </div>
  `;
});

  const latest = responses.length ? new Date(responses[responses.length-1].created_at).getTime() : 0;
  updateNewBadge(latest > getSeen());
}

async function providerReply(){
  const msg = String($("respMsg").value || "").trim();
  const fileInput = $("respFiles");

  if(!msg && (!fileInput?.files?.length)){
    $("respStatus").textContent = "‚ùå Mets un message ou un fichier.";
    return;
  }

  $("respStatus").textContent = "Upload fichiers‚Ä¶";
  let files = [];
  try { files = await uploadFiles(RID, fileInput); }
  catch(e){
  $("respStatus").textContent = "‚ùå Erreur upload fichier : " + String(e.message || e);
  return;
}

  $("respStatus").textContent = "Envoi‚Ä¶";
  const { res, data } = await fetchJson(`${SUPABASE_URL}/functions/v1/provider-reply`, {
    method:"POST",
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:"Bearer " + SUPABASE_ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({
      request_id: RID,
      access_code: CODE,
      provider_email: PROVIDER_EMAIL,
      message: msg || "(Pi√®ce jointe)",
      files
    })
  });

  if(!res.ok){
    $("respStatus").textContent = `‚ùå Erreur envoi (HTTP ${res.status})`;
    return;
  }

  $("respMsg").value = "";
  $("respFiles").value = "";
  $("respStatus").textContent = "‚úÖ Envoy√©";
  await loadThread();
}

async function copyThreadLink(){
  const link = `${baseUrl()}?rid=${encodeURIComponent(RID)}&code=${encodeURIComponent(CODE)}&pe=${encodeURIComponent(PROVIDER_EMAIL)}`;
  await navigator.clipboard.writeText(link);
  alert("Lien copi√©.");
}

(async function init(){
  const { rid, code, pe } = getAllParams();
  RID = String(rid || "").trim();
  CODE = String(code || "").trim();
  PROVIDER_EMAIL = decodeURIComponent(String(pe || "")).trim().toLowerCase();

  if(!RID || !CODE || !PROVIDER_EMAIL){
    $("requestInfo").textContent = "‚ùå Lien invalide. Il faut rid, code et pe.";
    $("accessErr").style.display = "";
    $("accessErr").textContent = "Exemple : vendor.html?rid=XXX&code=YYY&pe=vendeur@domaine.com";
    return;
  }

  $("refreshBtn").addEventListener("click", loadThread);
  $("copyLinkBtn").addEventListener("click", copyThreadLink);
  $("markReadBtn").addEventListener("click", markSeen);
  $("sendMsgBtn").addEventListener("click", providerReply);

  await loadThread();
})();
</script>
</body>
</html>
