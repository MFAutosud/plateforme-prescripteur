<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Admin â€“ MF Auto Sud</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#0b1220;color:#fff;padding:24px}
h1{color:#4da3ff}
.box{background:#111c34;padding:16px;border-radius:12px;margin-bottom:16px}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #2b3a5a;background:#0b1220;color:#fff}
button{padding:8px 12px;border-radius:8px;border:0;background:#4da3ff;color:#000;font-weight:bold;cursor:pointer}
button.secondary{background:#334155;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #1f2a44;text-align:left;font-size:14px}
tr:hover{background:#0b1220}
.badge{padding:3px 8px;border-radius:999px;font-size:12px}
.en-cours{background:#2563eb}
.vendu{background:#16a34a}
.perdu{background:#dc2626}
.archive{background:#6b7280}
.small{font-size:12px;opacity:.8}
</style>
</head>

<body>

<h1>Dashboard Admin â€“ MF Auto Sud</h1>

<div class="box">
  <input id="search" placeholder="ðŸ” Recherche client / vÃ©hicule / email" style="width:40%">
  <select id="filterStatus">
    <option value="">Tous les statuts</option>
    <option value="en_cours">En cours</option>
    <option value="vendu">Vendu</option>
    <option value="perdu">Perdu</option>
    <option value="archive">ArchivÃ©</option>
  </select>
  <button onclick="load()">Actualiser</button>
  <button class="secondary" onclick="exportCSV()">Exporter Excel</button>
</div>

<div class="box">
<table>
<thead>
<tr>
<th>Client</th>
<th>VÃ©hicule</th>
<th>Statut</th>
<th>DerniÃ¨re maj</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</div>

<script>
const SUPABASE_URL = "https://tubhsjkstbrqlvmylobz.supabase.co";
const ADMIN_TOKEN = prompt("ðŸ” Token admin MF Auto Sud");

let DATA = [];

async function api(body){
  const res = await fetch(`${SUPABASE_URL}/functions/v1/admin-api`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+ADMIN_TOKEN
    },
    body:JSON.stringify(body)
  });
  return res.json();
}

async function load(){
  const search = document.getElementById("search").value.toLowerCase();
  const status = document.getElementById("filterStatus").value;

  const r = await api({action:"list"});
  if(!r.ok){ alert("Erreur chargement"); return; }

  DATA = r.data.filter(x=>{
    if(status && x.deal_status!==status) return false;
    if(search){
      const s = (x.client_name+x.vehicle).toLowerCase();
      return s.includes(search);
    }
    return true;
  });

  render();
}

function render(){
  const el = document.getElementById("rows");
  el.innerHTML = "";
  DATA.forEach(d=>{
    el.innerHTML += `
      <tr>
        <td><strong>${d.client_name}</strong></td>
        <td>${d.vehicle}</td>
        <td><span class="badge ${d.deal_status}">
          ${label(d.deal_status)}
        </span></td>
        <td class="small">${new Date(d.updated_at).toLocaleDateString()}</td>
        <td>
          <button onclick="openDeal('${d.id}')">Ouvrir</button>
          <button class="secondary" onclick="setStatus('${d.id}','vendu')">Vendu</button>
          <button class="secondary" onclick="setStatus('${d.id}','perdu')">Perdu</button>
          <button class="secondary" onclick="setStatus('${d.id}','archive')">Archiver</button>
        </td>
      </tr>
    `;
  });
}

function label(s){
  return {
    en_cours:"En cours",
    vendu:"Vendu",
    perdu:"Perdu",
    archive:"ArchivÃ©"
  }[s] || s;
}

async function setStatus(id,status){
  await api({action:"update",request_id:id,deal_status:status});
  load();
}

async function openDeal(id){
  const r = await api({action:"link",request_id:id});
  if(r.link) window.open(r.link,"_blank");
}

function exportCSV(){
  let csv="Client;VÃ©hicule;Statut\n";
  DATA.forEach(d=>{
    csv+=`${d.client_name};${d.vehicle};${label(d.deal_status)}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="mfautosud_affaires.csv";
  a.click();
}

load();
</script>

</body>
</html>
